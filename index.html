<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pharma - Monitor V6</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-dark: #2c3e50; --accent-blue: #3498db; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; font-size: 0.85rem; }
        
        /* Header e Tabela */
        .header-bar { background: var(--primary-dark); color: white; padding: 12px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-table { border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .table-pncp thead { background-color: #34495e; color: white; text-transform: uppercase; font-size: 0.75rem; }
        .table-pncp td { vertical-align: middle; padding: 10px; border-bottom: 1px solid #eee; }

        /* Dados Principais */
        .uasg-orgao { font-weight: 700; color: #2c3e50; font-size: 0.9rem; }
        .unidade-comp { color: #555; font-size: 0.8rem; display: block; margin-top: 2px; }
        .local-uf { color: #7f8c8d; font-size: 0.8rem; display: block; font-style: italic; }

        /* Badges de Tipo de Licitação */
        .badge-tipo { font-size: 0.7rem; font-weight: 700; padding: 4px 8px; border-radius: 4px; display: inline-block; width: 100%; text-align: center; }
        .tipo-amplo { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; } /* Verde */
        .tipo-exclusivo { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; } /* Vermelho */
        .tipo-parcial { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; } /* Amarelo */

        /* Modal e Grupos */
        .group-header { padding: 8px 15px; font-weight: 700; color: white; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .bg-fornecedor { background-color: #2c3e50; } 
        .bg-andamento { background-color: #198754; } 
        .bg-fracassado { background-color: #dc3545; } 
        
        .table-itens th { background: #f8f9fa; font-size: 0.75rem; }
        .me-epp-sim { color: #dc3545; font-weight: 800; } 
        .me-epp-nao { color: #ccc; font-weight: 400; }

        /* Overlay de Carregamento */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border text-primary" role="status" id="spinner"></div>
    <div class="mt-3 text-secondary fw-bold" id="loading-msg">Carregando dados...</div>
    <button class="btn btn-sm btn-primary mt-3 d-none" id="btn-retry" onclick="location.reload()">Tentar Novamente</button>
</div>

<div class="header-bar d-flex justify-content-between align-items-center sticky-top">
    <div class="fw-bold fs-5"><i class="fas fa-crosshairs me-2"></i>SNIPER PHARMA V6</div>
    <button class="btn btn-sm btn-outline-light" onclick="location.reload()"><i class="fas fa-sync-alt"></i></button>
</div>

<div class="container-fluid py-3">
    <div class="card card-table p-3 mb-3">
        <div class="row g-2">
            <div class="col-md-2"><input id="fUf" class="form-control form-control-sm" placeholder="UF" onkeyup="render()"></div>
            <div class="col-md-4"><input id="fOrgao" class="form-control form-control-sm" placeholder="Cidade ou Órgão" onkeyup="render()"></div>
            <div class="col-md-4"><input id="fObjeto" class="form-control form-control-sm" placeholder="Palavra no Objeto" onkeyup="render()"></div>
            <div class="col-md-2">
                <select id="fTipo" class="form-select form-select-sm" onchange="render()">
                    <option value="">Todos os Tipos</option>
                    <option value="AMPLO">Amplo (Verde)</option>
                    <option value="EXCLUSIVO">Exclusivo ME/EPP (Vermelho)</option>
                    <option value="PARCIAL">Parcial (Amarelo)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card card-table">
        <div class="table-responsive">
            <table class="table table-hover table-pncp mb-0">
                <thead>
                    <tr>
                        <th style="width: 100px;">Data Fim</th>
                        <th style="width: 80px;" class="text-center">Tipo</th>
                        <th>Órgão / Unidade / Local</th>
                        <th style="width: 100px;">Edital</th>
                        <th>Objeto</th>
                        <th class="text-end" style="width: 120px;">Valor Est.</th>
                        <th class="text-center" style="width: 80px;">Ação</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div class="p-3 d-flex justify-content-between align-items-center border-top">
            <div class="text-muted small">
                Total de Registros: <span id="totalReg" class="fw-bold">0</span>
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-sm btn-secondary me-2" onclick="mudarPagina(-1)" id="btnAnt">Anterior</button>
                <span class="text-muted small mx-2">Página <span id="pagAtual">1</span> de <span id="pagTotal">1</span></span>
                <button class="btn btn-sm btn-secondary ms-2" onclick="mudarPagina(1)" id="btnProx">Próximo</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2 bg-dark text-white">
                <h6 class="modal-title">Detalhamento do Processo</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div id="modalBody" class="modal-body bg-light"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

<script>
    const FILE_URL = 'pregacoes_pharma_limpos.json.gz';
    let dadosOriginais = [], dadosFiltrados = [];
    let pagina = 1;
    const ITENS_POR_PAG = 20;
    
    const fmtBrl = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmtData = d => d ? new Date(d).toLocaleDateString('pt-BR') : '--';

    // Inicialização Segura
    window.onload = async () => {
        try {
            updateLoading("Baixando arquivo de dados...");
            // Adiciona timestamp para evitar cache do navegador
            const res = await fetch(`${FILE_URL}?v=${Date.now()}`);
            
            if(!res.ok) throw new Error(`Arquivo não encontrado (${res.status}). O robô ainda não gerou os dados ou o arquivo está vazio.`);
            
            const blob = await res.blob();
            const arrayBuffer = await blob.arrayBuffer();

            updateLoading("Descompactando...");
            
            let text;
            try {
                // Tenta descompactar GZIP
                text = pako.ungzip(new Uint8Array(arrayBuffer), {to:'string'});
            } catch (e) {
                // Se falhar, tenta ler como texto puro (fallback)
                console.warn("Falha GZIP, tentando texto plano...");
                text = await new Response(blob).text();
            }
            
            updateLoading("Processando JSON...");
            
            try {
                dadosOriginais = JSON.parse(text);
            } catch (e) {
                throw new Error("O arquivo baixado não é um JSON válido. Pode estar corrompido.");
            }

            if (!Array.isArray(dadosOriginais)) {
                // Se o JSON existir mas estiver vazio ou não for lista
                dadosOriginais = []; 
                console.warn("JSON válido, mas não é uma lista.");
            }
            
            // Ordenação Inicial: Data de Encerramento
            dadosOriginais.sort((a,b) => {
                const da = a.data_enc ? new Date(a.data_enc) : new Date('2099-01-01');
                const db = b.data_enc ? new Date(b.data_enc) : new Date('2099-01-01');
                return da - db;
            });
            
            render();
            
            // Esconde loading apenas se tudo deu certo
            const loadingOverlay = document.getElementById('loading-overlay');
            if(loadingOverlay) loadingOverlay.style.display = 'none';

        } catch (e) {
            console.error(e);
            showError(`Erro: ${e.message}`);
        }
    };

    function updateLoading(msg) {
        const el = document.getElementById('loading-msg');
        if(el) el.innerText = msg;
    }

    function showError(msg) {
        const spinner = document.getElementById('spinner');
        if(spinner) spinner.style.display = 'none';
        
        const elMsg = document.getElementById('loading-msg');
        if(elMsg) {
            elMsg.innerHTML = `<div class="text-danger mb-2"><i class="fas fa-exclamation-triangle fa-2x"></i></div>${msg}`;
            elMsg.classList.remove('text-secondary');
            elMsg.classList.add('text-danger');
        }
        
        const btnRetry = document.getElementById('btn-retry');
        if(btnRetry) btnRetry.classList.remove('d-none');
    }

    function render() {
        const ufEl = document.getElementById('fUf');
        const orgEl = document.getElementById('fOrgao');
        const objEl = document.getElementById('fObjeto');
        const tipoEl = document.getElementById('fTipo');

        // Proteção contra elementos não encontrados
        if(!ufEl || !orgEl || !objEl || !tipoEl) return;

        const uf = ufEl.value.toUpperCase();
        const org = orgEl.value.toUpperCase();
        const obj = objEl.value.toUpperCase();
        const tipo = tipoEl.value;

        dadosFiltrados = dadosOriginais.filter(d => {
            const fullLocal = ((d.cidade || '') + ' ' + (d.orgao || '')).toUpperCase();
            const objUpper = (d.objeto || '').toUpperCase();
            const ufUpper = (d.uf || '').toUpperCase();
            
            return (ufUpper.includes(uf) && 
                    fullLocal.includes(org) && 
                    objUpper.includes(obj) &&
                    (tipo === "" || d.tipo_licitacao === tipo));
        });

        const totalPaginas = Math.ceil(dadosFiltrados.length / ITENS_POR_PAG) || 1;
        if(pagina > totalPaginas) pagina = totalPaginas;
        if(pagina < 1) pagina = 1;

        const inicio = (pagina - 1) * ITENS_POR_PAG;
        const lote = dadosFiltrados.slice(inicio, inicio + ITENS_POR_PAG);
        
        const tbody = document.getElementById('tbody');
        if(tbody) {
            tbody.innerHTML = '';
            lote.forEach(d => {
                // Estilo da Data
                const dataObj = d.data_enc ? new Date(d.data_enc) : null;
                const hoje = new Date();
                let corData = 'text-dark';
                
                if (dataObj) {
                    const diffHoras = (dataObj - hoje) / 36e5; 
                    if (diffHoras < 0) corData = 'text-decoration-line-through text-muted';
                    else if (diffHoras < 48) corData = 'text-danger fw-bold';
                }

                let classeTipo = 'tipo-amplo'; 
                if(d.tipo_licitacao === 'EXCLUSIVO') classeTipo = 'tipo-exclusivo';
                if(d.tipo_licitacao === 'PARCIAL') classeTipo = 'tipo-parcial';

                tbody.innerHTML += `
                    <tr>
                        <td class="${corData}">${fmtData(d.data_enc)}</td>
                        <td class="text-center"><span class="badge-tipo ${classeTipo}">${d.tipo_licitacao || 'AMPLO'}</span></td>
                        <td>
                            <div class="uasg-orgao">UASG ${d.uasg || '---'} - ${d.orgao || 'Órgão Desconhecido'}</div>
                            <div class="unidade-comp">${d.unidade || ''}</div>
                            <div class="local-uf">${d.cidade || ''} - ${d.uf || ''}</div>
                        </td>
                        <td>${d.edital || '-'}</td>
                        <td><div class="text-truncate" style="max-width:350px" title="${d.objeto}">${d.objeto}</div></td>
                        <td class="text-end fw-bold text-success">${fmtBrl.format(d.valor_estimado || 0)}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes('${d.id}')"><i class="fas fa-list"></i></button>
                            <a href="${d.link}" target="_blank" class="btn btn-sm btn-outline-dark"><i class="fas fa-external-link-alt"></i></a>
                        </td>
                    </tr>
                `;
            });
        }

        // Atualiza Paginação com segurança
        const elPagAtual = document.getElementById('pagAtual');
        const elPagTotal = document.getElementById('pagTotal');
        const elTotalReg = document.getElementById('totalReg');
        const elBtnAnt = document.getElementById('btnAnt');
        const elBtnProx = document.getElementById('btnProx');

        if(elPagAtual) elPagAtual.innerText = pagina;
        if(elPagTotal) elPagTotal.innerText = totalPaginas;
        if(elTotalReg) elTotalReg.innerText = dadosFiltrados.length; // AQUI ESTAVA O ERRO ANTES
        if(elBtnAnt) elBtnAnt.disabled = pagina === 1;
        if(elBtnProx) elBtnProx.disabled = pagina === totalPaginas;
    }

    function mudarPagina(d) { pagina += d; render(); document.querySelector('.card-table').scrollIntoView(); }

    function verDetalhes(id) {
        const lic = dadosOriginais.find(d => d.id === id);
        if(!lic) return;

        const itens = lic.itens || [];
        
        const grupos = {
            'EM_ANDAMENTO': [],
            'HOMOLOGADO': {}, 
            'OUTROS': [] 
        };

        itens.forEach(it => {
            const sit = (it.situacao || 'EM_ANDAMENTO');
            if (sit === 'HOMOLOGADO') {
                const forn = it.fornecedor || 'Fornecedor Não Identificado';
                if (!grupos.HOMOLOGADO[forn]) grupos.HOMOLOGADO[forn] = [];
                grupos.HOMOLOGADO[forn].push(it);
            } else if (sit === 'EM_ANDAMENTO') {
                grupos.EM_ANDAMENTO.push(it);
            } else {
                grupos.OUTROS.push(it);
            }
        });

        let html = `
            <div class="alert alert-light border shadow-sm">
                <strong>${lic.orgao}</strong><br>
                <small>${lic.cidade}/${lic.uf} - Edital: ${lic.edital}</small>
                <div class="mt-2 text-muted small">${lic.objeto}</div>
            </div>
        `;

        const gerarTabela = (lista, mostrarValHom) => {
            let trs = '';
            lista.forEach(it => {
                const txtMeEpp = it.me_epp ? '<span class="me-epp-sim">SIM</span>' : '<span class="me-epp-nao">NÃO</span>';
                const valShow = mostrarValHom ? (it.valHomologado || 0) : (it.valUnit || 0);
                const total = (it.qtd || 0) * valShow;
                
                let descSit = '';
                if(it.situacao === 'CANCELADO') descSit = '<span class="badge bg-danger ms-1">CANCELADO</span>';
                if(it.situacao === 'DESERTO') descSit = '<span class="badge bg-warning text-dark ms-1">DESERTO</span>';
                if(it.situacao === 'FRACASSADO') descSit = '<span class="badge bg-danger ms-1">FRACASSADO</span>';

                trs += `
                    <tr>
                        <td class="text-center">${it.n}</td>
                        <td class="text-center">${txtMeEpp}</td>
                        <td>${it.desc} ${descSit}</td>
                        <td class="text-center">${it.qtd}</td>
                        <td class="text-center">${it.un}</td>
                        <td class="text-end">${fmtBrl.format(valShow)}</td>
                        <td class="text-end fw-bold">${fmtBrl.format(total)}</td>
                    </tr>
                `;
            });
            return `
                <div class="table-responsive mb-3">
                    <table class="table table-sm table-bordered table-itens mb-0">
                        <thead>
                            <tr>
                                <th style="width:50px">Item</th>
                                <th style="width:50px">ME/EPP</th>
                                <th>Descrição</th>
                                <th style="width:70px">Qtd</th>
                                <th style="width:60px">Un</th>
                                <th style="width:110px">${mostrarValHom ? 'Val. Final' : 'Val. Est.'}</th>
                                <th style="width:110px">Total</th>
                            </tr>
                        </thead>
                        <tbody>${trs}</tbody>
                    </table>
                </div>
            `;
        };

        if (Object.keys(grupos.HOMOLOGADO).length > 0) {
            html += `<h6 class="mt-4 border-bottom pb-2">✅ Itens Homologados / Adjudicados</h6>`;
            for (const [fornecedor, lista] of Object.entries(grupos.HOMOLOGADO)) {
                html += `
                    <div class="card mb-3 shadow-sm border-dark">
                        <div class="group-header bg-fornecedor">
                            <span><i class="fas fa-truck me-2"></i> ${fornecedor}</span>
                            <span class="badge bg-white text-dark">${lista.length} itens</span>
                        </div>
                        <div class="card-body p-0">${gerarTabela(lista, true)}</div>
                    </div>`;
            }
        }

        if (grupos.EM_ANDAMENTO.length > 0) {
            html += `
                <div class="card mb-3 border-success shadow-sm mt-4">
                    <div class="group-header bg-andamento">
                        <span><i class="fas fa-clock me-2"></i> Em Andamento / Aberto</span>
                        <span class="badge bg-white text-dark">${grupos.EM_ANDAMENTO.length} itens</span>
                    </div>
                    <div class="card-body p-0">${gerarTabela(grupos.EM_ANDAMENTO, false)}</div>
                </div>`;
        }

        if (grupos.OUTROS.length > 0) {
            html += `
                <div class="card mb-3 border-danger shadow-sm mt-4">
                    <div class="group-header bg-fracassado">
                        <span><i class="fas fa-times-circle me-2"></i> Fracassados / Desertos / Cancelados</span>
                        <span class="badge bg-white text-dark">${grupos.OUTROS.length} itens</span>
                    </div>
                    <div class="card-body p-0">${gerarTabela(grupos.OUTROS, false)}</div>
                </div>`;
        }

        const modalBody = document.getElementById('modalBody');
        if(modalBody) modalBody.innerHTML = html;
        const modalEl = document.getElementById('modalDetalhes');
        if(modalEl) new bootstrap.Modal(modalEl).show();
    }
</script>
</body>
</html>
