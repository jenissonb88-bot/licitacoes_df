<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Sniper PNCP - Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner-border text-primary"></div>
        <div class="mt-2 fw-bold" id="statusMsg">Buscando dados atualizados...</div>
    </div>

    <div class="container py-4">
        <h2 class="mb-4">Monitor de Licitações</h2>
        <div id="containerLicitacoes" class="row"></div>
    </div>

    <script>
        let dadosLicitacoes = [];

        async function carregarDados() {
            try {
                // Cache Buster: ?t= adiciona a hora atual para forçar o download do arquivo novo
                const url = `dados/oportunidades.json.gz?t=${new Date().getTime()}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error("Arquivo não encontrado.");

                const ds = new DecompressionStream("gzip");
                const stream = resp.body.pipeThrough(ds);
                const texto = await new Response(stream).text();
                
                dadosLicitacoes = JSON.parse(texto);
                document.getElementById('loader').style.display = 'none';
                render();
            } catch (e) {
                document.getElementById('statusMsg').innerHTML = `<span class="text-danger">Erro: ${e.message}</span>`;
            }
        }

        function render() {
            const container = document.getElementById('containerLicitacoes');
            container.innerHTML = dadosLicitacoes.length === 0 ? '<p>Nenhuma licitação encontrada para este período.</p>' : '';
            
            dadosLicitacoes.forEach(l => {
                container.innerHTML += `
                    <div class="col-md-6 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title fw-bold">${l.orgao}</h6>
                                <p class="small text-muted mb-2">${l.objeto}</p>
                                <a href="${l.link}" target="_blank" class="btn btn-primary btn-sm">Ver no PNCP</a>
                            </div>
                        </div>
                    </div>`;
            });
        }

        window.onload = carregarDados;
    </script>
</body>
</html>
