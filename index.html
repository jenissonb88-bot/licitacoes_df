<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pharma - Monitor de Licitações</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary-color: #0d6efd; --bg-color: #f4f6f9; }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background: linear-gradient(to right, #004e92, #000428); }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; border-radius: 10px; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .valor-monetario { font-weight: bold; color: #198754; }
        .data-critica { color: #dc3545; font-weight: bold; }
        
        /* Estilo da Tabela de Itens no Modal */
        .table-itens thead th { background-color: #e9ecef; position: sticky; top: 0; }
        .modal-body { max-height: 70vh; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="loading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <h5 class="mt-3">Carregando Sniper Pharma...</h5>
        <p class="text-muted small" id="loading-msg">Conectando...</p>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-biohazard me-2"></i>Sniper Pharma</a>
            <span class="navbar-text text-white small" id="last-update"></span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card p-3 border-start border-4 border-primary">
                    <h6 class="text-muted text-uppercase small">Total Ativos</h6>
                    <h3 id="total-count">0</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 border-start border-4 border-success">
                    <h6 class="text-muted text-uppercase small">Valor Total Estimado</h6>
                    <h3 id="total-value">R$ 0,00</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3 border-start border-4 border-warning">
                    <h6 class="text-muted text-uppercase small">Urgentes (48h)</h6>
                    <h3 id="urgent-count">0</h3>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <table id="tabela-pharma" class="table table-striped table-hover dt-responsive nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th>Fim</th>
                            <th>UF</th>
                            <th>Órgão / Edital</th>
                            <th>Objeto</th>
                            <th>Valor Total</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalItens" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <div>
                        <h5 class="modal-title" id="modalTitle">Itens do Pregão</h5>
                        <small class="text-muted" id="modalSubtitle">Carregando...</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped table-itens mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Descrição do Item</th>
                                    <th style="width: 100px;">Qtd</th>
                                    <th style="width: 80px;">Un</th>
                                    <th style="width: 120px;">Val. Unit.</th>
                                    <th style="width: 120px;">Total Item</th>
                                </tr>
                            </thead>
                            <tbody id="lista-itens-body">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <a href="#" id="btn-pncp-link" target="_blank" class="btn btn-primary"><i class="fas fa-external-link-alt"></i> Ver no PNCP</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>

    <script>
        const FILE_URL = 'pregacoes_pharma_limpos.json.gz';
        var table; // Variável global para a tabela

        $(document).ready(function() {
            moment.locale('pt-br');
            carregarDados();
        });

        async function carregarDados() {
            try {
                $('#loading-msg').text(`Baixando ${FILE_URL}...`);
                const response = await fetch(FILE_URL, {cache: "no-store"});
                if (!response.ok) throw new Error("Arquivo não encontrado.");
                
                const blob = await response.blob();
                const arrayBuffer = await blob.arrayBuffer();
                
                let textData;
                try {
                    textData = pako.ungzip(new Uint8Array(arrayBuffer), { to: 'string' });
                } catch (e) {
                    textData = await blob.text();
                }

                const dados = JSON.parse(textData);
                inicializarTabela(dados);
                atualizarStats(dados);
                $('#loading').fadeOut();

            } catch (erro) {
                $('#loading').html(`<div class="text-danger text-center"><h3>Erro</h3><p>${erro.message}</p></div>`);
            }
        }

        function inicializarTabela(dados) {
            table = $('#tabela-pharma').DataTable({
                data: dados,
                order: [[0, 'asc']],
                pageLength: 25,
                language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/pt-BR.json" },
                columns: [
                    { 
                        data: 'data_enc',
                        render: function(data) {
                            if (!data) return '<span class="text-muted">N/A</span>';
                            const m = moment(data);
                            const dias = m.diff(moment(), 'days');
                            let cls = dias <= 2 && dias >= 0 ? 'data-critica' : '';
                            return `<span class="${cls}">${m.format('DD/MM/YYYY HH:mm')}</span>`;
                        }
                    },
                    { data: 'uf' },
                    { 
                        data: null, 
                        render: function(row) {
                            return `<b>${row.cidade}</b><br><small>${row.edital}</small>`; 
                        }
                    },
                    { 
                        data: 'objeto',
                        render: function(data) {
                            return `<div class="text-truncate" style="max-width:300px" title="${data}">${data}</div>`;
                        }
                    },
                    { 
                        data: 'valor_estimado',
                        render: function(v) { 
                            return parseFloat(v).toLocaleString('pt-BR',{style:'currency', currency:'BRL'}); 
                        }
                    },
                    {
                        data: null,
                        render: function(data, type, row) {
                            // Armazena os dados do objeto no botão para facilitar o clique
                            // Mas como o objeto é grande, melhor usar o evento de click do datatables
                            return `
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-info text-white btn-detalhes" title="Ver Itens">
                                        <i class="fas fa-list-ol"></i> Itens
                                    </button>
                                    <a href="${row.link}" target="_blank" class="btn btn-sm btn-outline-primary" title="Abrir PNCP">
                                        <i class="fas fa-external-link-alt"></i>
                                    </a>
                                </div>
                            `;
                        }
                    }
                ]
            });

            // Evento de Clique no Botão Detalhes
            $('#tabela-pharma tbody').on('click', '.btn-detalhes', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr).data();
                abrirModalItens(row);
            });
        }

        function abrirModalItens(dados) {
            // Preenche cabeçalho
            $('#modalTitle').text(`Edital ${dados.edital} - ${dados.cidade}/${dados.uf}`);
            $('#modalSubtitle').text(dados.objeto);
            $('#btn-pncp-link').attr('href', dados.link);

            // Preenche Tabela
            const tbody = $('#lista-itens-body');
            tbody.empty();

            if (!dados.itens || dados.itens.length === 0) {
                tbody.html('<tr><td colspan="6" class="text-center py-4 text-muted">Nenhum item detalhado disponível para este pregão.</td></tr>');
            } else {
                dados.itens.forEach(item => {
                    const totalItem = (item.qtd * item.valUnit);
                    const html = `
                        <tr>
                            <td>${item.n}</td>
                            <td>${item.desc}</td>
                            <td>${parseFloat(item.qtd).toLocaleString('pt-BR')}</td>
                            <td>${item.un}</td>
                            <td>${parseFloat(item.valUnit).toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                            <td class="fw-bold">${totalItem.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}</td>
                        </tr>
                    `;
                    tbody.append(html);
                });
            }

            // Abre Modal
            var myModal = new bootstrap.Modal(document.getElementById('modalItens'));
            myModal.show();
        }

        function atualizarStats(dados) {
            $('#total-count').text(dados.length);
            const total = dados.reduce((acc, i) => acc + (i.valor_estimado || 0), 0);
            $('#total-value').text(total.toLocaleString('pt-BR', {style:'currency', currency:'BRL', maximumFractionDigits: 0}));
            
            const urgentes = dados.filter(i => {
                if(!i.data_enc) return false;
                const d = moment(i.data_enc);
                return d.isAfter(moment()) && d.isBefore(moment().add(48, 'h'));
            }).length;
            $('#urgent-count').text(urgentes);
            $('#last-update').text("Atualizado: " + moment().format('DD/MM HH:mm'));
        }
    </script>
</body>
</html>
