<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel PNCP - Saúde</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-size: 0.85rem; }
        .header { background: #2c3e50; color: white; padding: 15px; }
        .table-main th { background: #34495e; color: white; font-weight: 500; }
        .money { font-family: monospace; font-weight: bold; text-align: right; }
        .status-winner { background: #d1e7dd; border-left: 5px solid #198754; }
        .status-open { background: #fff3cd; border-left: 5px solid #ffc107; }
    </style>
</head>
<body>

<div class="header d-flex justify-content-between align-items-center">
    <h5 class="m-0"><i class="fas fa-robot"></i> Monitor PNCP</h5>
    <div>
        <span class="badge bg-info me-2" id="totalLics">0</span>
        <button class="btn btn-sm btn-light" onclick="location.reload()">Atualizar</button>
    </div>
</div>

<div class="container-fluid mt-3">
    <div class="card mb-3 p-2">
        <div class="row g-2">
            <div class="col-md-2"><input id="fUf" class="form-control form-control-sm" placeholder="UF" onkeyup="render()"></div>
            <div class="col-md-4"><input id="fOrgao" class="form-control form-control-sm" placeholder="Órgão / UASG / Edital" onkeyup="render()"></div>
            <div class="col-md-6"><input id="fObj" class="form-control form-control-sm" placeholder="Objeto" onkeyup="render()"></div>
        </div>
    </div>

    <div class="card">
        <table class="table table-hover table-striped mb-0">
            <thead>
                <tr>
                    <th>Data Fim</th>
                    <th>UF</th>
                    <th>Órgão / UASG</th>
                    <th>Edital</th>
                    <th>Objeto</th>
                    <th class="text-center">Itens</th>
                    <th class="text-end">Valor Global</th>
                    <th class="text-center">Ação</th>
                </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>
        
        <div class="d-flex justify-content-center p-2 gap-2">
            <button class="btn btn-sm btn-secondary" onclick="mudarPag(-1)">Anterior</button>
            <span id="pagInfo" class="align-self-center"></span>
            <button class="btn btn-sm btn-secondary" onclick="mudarPag(1)">Próximo</button>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDet" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header py-2 bg-dark text-white">
                <h6 class="modal-title">Detalhes</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" id="modalBody"></div>
        </div>
    </div>
</div>

<script src="dados/oportunidades.js"></script>
<script>
    const POR_PAG = 20;
    let pag = 1;
    let dados = [];
    
    // Formatação Moeda
    const brl = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const dataFmt = d => d ? new Date(d).toLocaleDateString('pt-BR') : '-';

    window.onload = () => {
        // Carrega dados + Exclusões Locais
        const excluidos = JSON.parse(localStorage.getItem('excluidos') || '[]');
        const raw = (typeof dadosLicitacoes !== 'undefined') ? dadosLicitacoes : [];
        
        dados = raw.filter(d => !excluidos.includes(d.id));
        render();
    };

    function render() {
        const u = document.getElementById('fUf').value.toUpperCase();
        const o = document.getElementById('fOrgao').value.toUpperCase();
        const ob = document.getElementById('fObj').value.toUpperCase();

        // Filtragem
        const filtrados = dados.filter(d => 
            (d.uf || '').includes(u) &&
            ((d.orgao || '').toUpperCase().includes(o) || (d.uasg || '').includes(o) || (d.edital || '').includes(o)) &&
            (d.objeto || '').toUpperCase().includes(ob)
        );

        // Paginação
        const totalPag = Math.ceil(filtrados.length / POR_PAG) || 1;
        if (pag > totalPag) pag = totalPag;
        if (pag < 1) pag = 1;
        
        const slice = filtrados.slice((pag-1)*POR_PAG, pag*POR_PAG);
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        slice.forEach(d => {
            const val = d.is_sigiloso ? 'Sigiloso' : brl.format(d.valor_global);
            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold text-danger">${dataFmt(d.data_encerramento)}</td>
                    <td><b>${d.uf}</b></td>
                    <td>
                        <div class="text-truncate" style="max-width:200px" title="${d.orgao}">${d.orgao}</div>
                        <small class="text-muted">UASG: ${d.uasg}</small>
                    </td>
                    <td><span class="badge bg-secondary">${d.edital}</span></td>
                    <td><div class="text-truncate" style="max-width:300px" title="${d.objeto}">${d.objeto}</div></td>
                    <td class="text-center">${d.qtd_itens}</td>
                    <td class="text-end fw-bold">${val}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary" onclick="ver('${d.id}')"><i class="fas fa-eye"></i></button>
                        <a href="${d.link}" target="_blank" class="btn btn-sm btn-dark"><i class="fas fa-link"></i></a>
                        <button class="btn btn-sm btn-danger" onclick="excluir('${d.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('totalLics').innerText = filtrados.length;
        document.getElementById('pagInfo').innerText = `${pag} / ${totalPag}`;
    }

    function ver(id) {
        const item = dados.find(d => d.id === id);
        const corpo = document.getElementById('modalBody');
        corpo.innerHTML = '';

        // Agrupa
        const grupos = {};
        item.itens.forEach(i => {
            const k = i.fornecedor || 'SEM RESULTADO';
            if (!grupos[k]) grupos[k] = [];
            grupos[k].push(i);
        });

        Object.keys(grupos).sort().forEach(k => {
            const lista = grupos[k];
            const isVencedor = k !== 'EM ANDAMENTO' && k !== 'SEM RESULTADO';
            const cls = isVencedor ? 'status-winner' : 'status-open';
            
            let html = `<div class="card mb-2 ${cls}"><div class="card-header fw-bold">${k}</div><div class="card-body p-0"><table class="table table-sm mb-0"><thead><tr><th>Item</th><th>Descrição</th><th>Qtd</th><th class="text-end">V. Est.</th>${isVencedor ? '<th class="text-end">V. Homol.</th>' : ''}</tr></thead><tbody>`;
            
            lista.forEach(i => {
                html += `<tr>
                    <td>${i.item}</td>
                    <td>${i.desc}</td>
                    <td>${i.qtd}</td>
                    <td class="text-end">${brl.format(i.total)}</td>
                    ${isVencedor ? `<td class="text-end fw-bold text-success">${brl.format(i.homologado_total)}</td>` : ''}
                </tr>`;
            });
            html += '</tbody></table></div></div>';
            corpo.innerHTML += html;
        });

        new bootstrap.Modal(document.getElementById('modalDet')).show();
    }

    function excluir(id) {
        if(confirm('Ocultar esta licitação?')) {
            const list = JSON.parse(localStorage.getItem('excluidos') || '[]');
            list.push(id);
            localStorage.setItem('excluidos', JSON.stringify(list));
            window.onload();
        }
    }
    
    function mudarPag(d) { pag += d; render(); }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
