<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pharma - Monitor de Licita√ß√µes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        .container { max-width: 1200px; }
        
        /* Estilo dos Cards */
        .card-licitacao { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 25px; overflow: hidden; }
        .header-card { background-color: #003366; color: white; padding: 12px 20px; }
        .badge-uf { background-color: #ffc107; color: #000; font-weight: bold; border-radius: 4px; padding: 3px 8px; }
        
        /* Badges de Situa√ß√£o (Estilo Portal PNCP) */
        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; border: 1px solid; display: inline-block; text-transform: uppercase; }
        .status-fracassado { background-color: #f8d7da; color: #842029; border-color: #f5c2c7; }
        .status-deserto { background-color: #fff3cd; color: #664d03; border-color: #ffecb5; }
        .status-cancelado { background-color: #e2e3e5; color: #41464b; border-color: #d3d6d8; }
        .status-homologado { background-color: #cfe2ff; color: #084298; border-color: #b6d4fe; }
        .status-aberto { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc; }

        /* Tabela de Itens */
        .table-itens { font-size: 0.9em; vertical-align: middle; }
        .val-unitario { background-color: #fff9db; font-weight: 600; color: #856404; }
        .val-homologado { background-color: #e7f1ff; font-weight: 600; color: #0c4128; }
        .row-muted { opacity: 0.6; background-color: #fafafa; }
        .group-divider { background-color: #eee; font-weight: bold; text-align: center; font-size: 0.8em; letter-spacing: 1px; }

        /* Pagina√ß√£o e Salto */
        .pagination-container { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .input-jump { width: 70px; display: inline-block; }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold" style="color: #003366;">üöÄ Sniper Pharma</h1>
        <p class="text-muted">Monitor Estrat√©gico de Licita√ß√µes - Drogafonte</p>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-9">
            <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="Pesquisar por √≥rg√£o, cidade ou objeto...">
        </div>
        <div class="col-md-3">
            <select id="filterUF" class="form-select form-select-lg">
                <option value="">Todas as UFs</option>
            </select>
        </div>
    </div>

    <div id="monitor-content">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">A carregar licita√ß√µes de 2026...</p>
        </div>
    </div>

    <div class="pagination-container d-flex flex-wrap justify-content-between align-items-center mt-4">
        <div>
            <button class="btn btn-outline-primary" id="prevPage">Anterior</button>
            <span id="pageInfo" class="mx-3 fw-bold text-dark">P√°gina 1</span>
            <button class="btn btn-outline-primary" id="nextPage">Pr√≥xima</button>
        </div>
        
        <div class="d-flex align-items-center">
            <span class="me-2 text-muted">Ir para a p√°gina:</span>
            <input type="number" id="jumpInput" class="form-control input-jump me-2" min="1">
            <button class="btn btn-dark" id="btnJump">Ir</button>
        </div>
    </div>
</div>

<script>
let allData = [];
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 12;

// Fun√ß√£o para descompactar e carregar o JSON.GZ
async function loadData() {
    try {
        const response = await fetch('pregacoes_pharma_limpos.json.gz');
        const blob = await response.blob();
        const ds = new DecompressionStream('gzip');
        const decompressedStream = blob.stream().pipeThrough(ds);
        const text = await new Response(decompressedStream).text();
        allData = JSON.parse(text);
        
        // Ordena√ß√£o por data (mais recentes primeiro)
        allData.sort((a, b) => new Date(b.data_enc) - new Date(a.data_enc));
        
        filteredData = [...allData];
        setupUF();
        renderMonitor();
    } catch (e) {
        document.getElementById('monitor-content').innerHTML = `<div class="alert alert-danger">Erro ao carregar ficheiro de dados: ${e.message}</div>`;
    }
}

function renderMonitor() {
    const container = document.getElementById('monitor-content');
    container.innerHTML = '';

    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const items = filteredData.slice(start, end);

    items.forEach(preg => {
        // Agrupamento de itens por situa√ß√£o
        const grupos = {
            vendas: preg.itens.filter(i => !['FRACASSADO', 'DESERTO', 'CANCELADO'].includes(i.situacao)),
            fracassados: preg.itens.filter(i => i.situacao === 'FRACASSADO'),
            desertos: preg.itens.filter(i => i.situacao === 'DESERTO'),
            cancelados: preg.itens.filter(i => i.situacao === 'CANCELADO')
        };

        const renderLinha = (it, extraClass = '') => `
            <tr class="${extraClass}">
                <td class="text-center fw-bold">${it.n}</td>
                <td>${it.desc}</td>
                <td class="text-center">${it.qtd} ${it.un}</td>
                <td class="val-unitario">R$ ${it.valUnit.toFixed(4)}</td>
                <td class="val-homologado">R$ ${it.valHomologado > 0 ? it.valHomologado.toFixed(4) : '---'}</td>
                <td>
                    <span class="status-badge status-${it.situacao.toLowerCase()}">${it.situacao}</span>
                    ${it.fornecedor ? `<br><small class="text-primary fw-bold">${it.fornecedor}</small>` : ''}
                </td>
            </tr>
        `;

        const card = document.createElement('div');
        card.className = 'card card-licitacao';
        card.innerHTML = `
            <div class="header-card d-flex justify-content-between">
                <span><span class="badge-uf me-2">${preg.uf}</span> <strong>${preg.orgao}</strong></span>
                <span class="small">${preg.edital}</span>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <h6 class="text-muted small mb-1">UNIDADE: ${preg.unidade} | CIDADE: ${preg.cidade}</h6>
                        <p class="mb-0"><strong>Objeto:</strong> ${preg.objeto}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="d-block text-muted">Abertura: ${new Date(preg.data_enc).toLocaleString()}</small>
                        <h4 class="text-primary mt-1">R$ ${preg.valor_estimado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h4>
                    </div>
                </div>
                <div class="d-flex justify-content-between border-top pt-3">
                    <span class="badge bg-light text-dark border">${preg.tipo_licitacao}</span>
                    <button class="btn btn-sm btn-primary" onclick="document.getElementById('det-${preg.id}').classList.toggle('d-none')">Ver Itens e Resultados</button>
                </div>
                
                <div id="det-${preg.id}" class="d-none mt-4">
                    <table class="table table-sm table-hover table-bordered table-itens">
                        <thead class="table-dark">
                            <tr>
                                <th>Item</th>
                                <th>Descri√ß√£o do Produto</th>
                                <th>Qtd/Un</th>
                                <th class="val-unitario">Est. Unit</th>
                                <th class="val-homologado">Homologado</th>
                                <th>Situa√ß√£o / Vencedor</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${grupos.vendas.map(i => renderLinha(i)).join('')}
                            ${grupos.fracassados.length ? `<tr class="group-divider"><td colspan="6">ITENS FRACASSADOS</td></tr>` + grupos.fracassados.map(i => renderLinha(i, 'row-muted')).join('') : ''}
                            ${grupos.desertos.length ? `<tr class="group-divider"><td colspan="6">ITENS DESERTOS</td></tr>` + grupos.desertos.map(i => renderLinha(i, 'row-muted')).join('') : ''}
                            ${grupos.cancelados.length ? `<tr class="group-divider"><td colspan="6">ITENS CANCELADOS</td></tr>` + grupos.cancelados.map(i => renderLinha(i, 'row-muted')).join('') : ''}
                        </tbody>
                    </table>
                    <div class="text-end mt-3">
                        <a href="${preg.link}" target="_blank" class="btn btn-sm btn-outline-secondary">Visualizar no Portal Oficial (PNCP)</a>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });

    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    document.getElementById('pageInfo').innerText = `P√°gina ${currentPage} de ${totalPages}`;
    document.getElementById('jumpInput').max = totalPages;
}

// L√≥gica de Salto de P√°gina
document.getElementById('btnJump').onclick = () => {
    const val = parseInt(document.getElementById('jumpInput').value);
    const max = Math.ceil(filteredData.length / itemsPerPage);
    if (val >= 1 && val <= max) {
        currentPage = val;
        renderMonitor();
        window.scrollTo(0,0);
    }
};

// Navega√ß√£o Simples
document.getElementById('prevPage').onclick = () => { if(currentPage > 1) { currentPage--; renderMonitor(); window.scrollTo(0,0); } };
document.getElementById('nextPage').onclick = () => { if(currentPage * itemsPerPage < filteredData.length) { currentPage++; renderMonitor(); window.scrollTo(0,0); } };

// Busca e Filtros
document.getElementById('searchInput').oninput = function() {
    const termo = this.value.toUpperCase();
    filteredData = allData.filter(p => 
        p.orgao.toUpperCase().includes(termo) || 
        p.objeto.toUpperCase().includes(termo) || 
        p.cidade.toUpperCase().includes(termo)
    );
    currentPage = 1;
    renderMonitor();
};

document.getElementById('filterUF').onchange = function() {
    const uf = this.value;
    filteredData = uf ? allData.filter(p => p.uf === uf) : [...allData];
    currentPage = 1;
    renderMonitor();
};

function setupUF() {
    const ufs = [...new Set(allData.map(p => p.uf))].sort();
    const select = document.getElementById('filterUF');
    ufs.forEach(uf => {
        const opt = document.createElement('option');
        opt.value = uf; opt.innerText = uf;
        select.appendChild(opt);
    });
}

loadData();
</script>
</body>
</html>
