<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Monitor PNCP - Saúde</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f4f6f9; font-size: 0.85rem; font-family: 'Segoe UI', sans-serif; }
        .header { background: #2c3e50; color: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .table-main th { background: #34495e; color: white; font-weight: 500; vertical-align: middle; }
        .money { font-family: 'Consolas', monospace; font-weight: bold; text-align: right; white-space: nowrap; }
        
        /* Cores de Status Modal */
        .status-winner { background: #d1e7dd; border-left: 5px solid #198754; color: #0f5132; }
        .status-open { background: #fff3cd; border-left: 5px solid #ffc107; color: #664d03; }
    </style>
</head>
<body>

<div class="header d-flex justify-content-between align-items-center sticky-top">
    <h5 class="m-0"><i class="fas fa-robot"></i> Monitor PNCP</h5>
    <div>
        <span class="badge bg-info me-2" id="totalLics">0</span>
        <button class="btn btn-sm btn-light" onclick="location.reload()">Atualizar</button>
    </div>
</div>

<div class="container-fluid mt-3">
    <div class="card mb-3 p-3">
        <div class="row g-2">
            <div class="col-md-2"><input id="fUf" class="form-control form-control-sm" placeholder="UF" onkeyup="render()"></div>
            <div class="col-md-4"><input id="fOrgao" class="form-control form-control-sm" placeholder="Órgão / UASG / Edital" onkeyup="render()"></div>
            <div class="col-md-6"><input id="fObj" class="form-control form-control-sm" placeholder="Objeto" onkeyup="render()"></div>
        </div>
    </div>

    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0 table-main">
                <thead>
                    <tr>
                        <th style="width: 100px;">Data Fim</th>
                        <th style="width: 50px;">UF</th>
                        <th>Órgão e Unidade Compradora</th> <th style="width: 120px;">Edital</th>
                        <th>Objeto</th>
                        <th class="text-center" style="width: 60px;">Itens</th>
                        <th class="text-end" style="width: 120px;">Valor Global</th>
                        <th class="text-center" style="width: 120px;">Ação</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-center p-3 gap-2 align-items-center border-top">
            <button class="btn btn-sm btn-outline-secondary" onclick="mudarPag(-1)">Anterior</button>
            <span id="pagInfo" class="fw-bold text-muted"></span>
            <button class="btn btn-sm btn-outline-secondary" onclick="mudarPag(1)">Próximo</button>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDet" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header py-2 bg-dark text-white">
                <h6 class="modal-title"><i class="fas fa-list"></i> Detalhes da Licitação</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" id="modalBody"></div>
        </div>
    </div>
</div>

<script src="dados/oportunidades.js"></script>
<script>
    const POR_PAG = 20;
    let pag = 1;
    let dados = [];
    
    // Formatadores
    const brl = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const dataFmt = d => d ? new Date(d).toLocaleDateString('pt-BR') : '-';

    window.onload = () => {
        const excluidos = JSON.parse(localStorage.getItem('excluidos') || '[]');
        const raw = (typeof dadosLicitacoes !== 'undefined') ? dadosLicitacoes : [];
        dados = raw.filter(d => !excluidos.includes(d.id));
        render();
    };

    function render() {
        const u = document.getElementById('fUf').value.toUpperCase();
        const o = document.getElementById('fOrgao').value.toUpperCase();
        const ob = document.getElementById('fObj').value.toUpperCase();

        const filtrados = dados.filter(d => 
            (d.uf || '').includes(u) &&
            ((d.orgao || '').toUpperCase().includes(o) || (d.uasg || '').includes(o) || (d.edital || '').includes(o)) &&
            (d.objeto || '').toUpperCase().includes(ob)
        );

        const totalPag = Math.ceil(filtrados.length / POR_PAG) || 1;
        if (pag > totalPag) pag = totalPag;
        if (pag < 1) pag = 1;
        
        const slice = filtrados.slice((pag-1)*POR_PAG, pag*POR_PAG);
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        slice.forEach(d => {
            const val = (d.is_sigiloso || !d.valor_global) ? '<span class="text-muted small">Sigiloso / R$ 0</span>' : brl.format(d.valor_global);
            const qtd = d.qtd_itens !== undefined ? d.qtd_itens : 0;
            
            // === AQUI ESTÁ A ALTERAÇÃO VISUAL ===
            // Formata: "UASG - Órgão" na linha de cima (Negrito)
            // Formata: "Unidade Compradora" na linha de baixo (Cinza)
            const linhaOrgao = `<div class="fw-bold text-dark text-truncate" style="max-width:350px" title="${d.uasg} - ${d.orgao}">${d.uasg} - ${d.orgao}</div>`;
            const linhaUnidade = `<div class="text-muted small text-truncate" style="max-width:350px" title="${d.unidade_compradora}">${d.unidade_compradora}</div>`;

            tbody.innerHTML += `
                <tr>
                    <td class="fw-bold text-danger">${dataFmt(d.data_encerramento)}</td>
                    <td><b>${d.uf}</b></td>
                    <td>
                        ${linhaOrgao}
                        ${linhaUnidade}
                    </td>
                    <td><span class="badge bg-secondary">${d.edital}</span></td>
                    <td><div class="text-truncate" style="max-width:300px" title="${d.objeto}">${d.objeto}</div></td>
                    <td class="text-center"><span class="badge bg-light text-dark border">${qtd}</span></td>
                    <td class="text-end fw-bold text-primary">${val}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary border-0" onclick="ver('${d.id}')" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
                        <a href="${d.link}" target="_blank" class="btn btn-sm btn-outline-dark border-0" title="Abrir PNCP"><i class="fas fa-link"></i></a>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="excluir('${d.id}')" title="Ocultar"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('totalLics').innerText = filtrados.length;
        document.getElementById('pagInfo').innerText = `${pag} / ${totalPag}`;
    }

    function ver(id) {
        const item = dados.find(d => d.id === id);
        const corpo = document.getElementById('modalBody');
        corpo.innerHTML = '';

        const grupos = {};
        item.itens.forEach(i => {
            const k = i.fornecedor || 'EM ANDAMENTO';
            if (!grupos[k]) grupos[k] = [];
            grupos[k].push(i);
        });

        const chaves = Object.keys(grupos).sort();

        chaves.forEach(k => {
            const lista = grupos[k];
            const isPendente = k === 'EM ANDAMENTO';
            const cls = isPendente ? 'status-open' : 'status-winner';
            const icone = isPendente ? 'fa-clock' : 'fa-trophy';
            
            let html = `
            <div class="card mb-3 shadow-sm">
                <div class="card-header fw-bold ${cls} d-flex justify-content-between">
                    <span><i class="fas ${icone} me-2"></i> ${k}</span>
                    <span class="badge bg-white text-dark opacity-75">${lista.length} Itens</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0 table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width:50px">Item</th>
                                <th>Descrição</th>
                                <th class="text-center" style="width:60px">Qtd</th>
                                <th class="money">Unit. Est.</th>
                                <th class="money">Total Est.</th>
                                ${!isPendente ? '<th class="money text-success bg-light">Unit. Hom.</th><th class="money text-success bg-light">Total Hom.</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>`;
            
            lista.forEach(i => {
                html += `<tr>
                    <td class="text-center fw-bold">${i.item}</td>
                    <td style="font-size:0.8rem">${i.desc}</td>
                    <td class="text-center">${i.qtd}</td>
                    <td class="money text-muted">${brl.format(i.unitario_est)}</td>
                    <td class="money text-muted">${brl.format(i.total_est)}</td>
                    ${!isPendente ? `
                        <td class="money fw-bold text-success bg-light">${brl.format(i.unitario_hom)}</td>
                        <td class="money fw-bold text-success bg-light">${brl.format(i.total_hom)}</td>
                    ` : ''}
                </tr>`;
            });
            html += '</tbody></table></div></div>';
            corpo.innerHTML += html;
        });

        new bootstrap.Modal(document.getElementById('modalDet')).show();
    }

    function excluir(id) {
        if(confirm('Ocultar esta licitação?')) {
            const list = JSON.parse(localStorage.getItem('excluidos') || '[]');
            list.push(id);
            localStorage.setItem('excluidos', JSON.stringify(list));
            window.onload();
        }
    }
    
    function mudarPag(d) { pag += d; render(); }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
