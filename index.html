<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pharma - Monitor de Licita√ß√µes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-licitacao { border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border: none; }
        .header-card { background-color: #004a99; color: white; padding: 12px 15px; border-radius: 12px 12px 0 0; }
        .badge-uf { background-color: #000; color: #fff; font-weight: bold; padding: 3px 8px; border-radius: 4px; }
        
        /* TARJAS DE STATUS DO PREG√ÉO (REGRAS DE NEG√ìCIO) */
        .badge-amplo { background-color: #198754 !important; color: white !important; font-weight: bold !important; padding: 5px 12px; } 
        .badge-exclusivo { background-color: #dc3545 !important; color: white !important; font-weight: bold !important; padding: 5px 12px; } 
        .badge-parcial { background-color: #ffc107 !important; color: #212529 !important; font-weight: bold !important; padding: 5px 12px; } 

        /* CORES DA EXCLUSIVIDADE DO ITEM (SIM/N√ÉO) */
        .benef-sim { color: #dc3545 !important; font-weight: bold !important; } /* Vermelho: SIM */
        .benef-nao { color: #198754 !important; font-weight: bold !important; } /* Verde: N√ÉO */

        /* Estilos da Modal e Tabela */
        .modal-xl { max-width: 95%; }
        .table-itens { font-size: 0.85em; }
        .val-estimado { background-color: #fff9db; font-weight: bold; color: #856404; }
        .val-homologado { background-color: #e7f1ff; font-weight: bold; color: #084298; }
        .val-total { background-color: #d1e7dd; font-weight: bold; color: #0f5132; }
        
        .header-fornecedor { background-color: #e9ecef; font-weight: bold; color: #004a99; }
        .header-status-aguardando { background-color: #fff3cd; font-weight: bold; text-align: center; color: #856404; font-size: 0.85em; }
        .header-falhas { background-color: #f8d7da; font-weight: bold; color: #842029; text-align: center; font-size: 0.85em; }

        .pagination-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 30px; padding-bottom: 50px; }
        .input-jump { width: 65px; text-align: center; }
        .filter-label { font-size: 0.72rem; font-weight: bold; color: #004a99; margin-bottom: 2px; display: block; text-transform: uppercase; }
    </style>
</head>
<body>

<div class="container-fluid px-4 py-4">
    <h2 class="mb-4 text-center">üî≠ Monitor Sniper Pharma - Drogafonte</h2>
    
    <div class="row g-2 mb-4 p-3 bg-white rounded shadow-sm border">
        <div class="col-md-2">
            <label class="filter-label">DATA ENCERRAMENTO</label>
            <input type="date" id="filterData" class="form-control form-control-sm">
        </div>
        <div class="col-md-3">
            <label class="filter-label">EDITAL / UASG</label>
            <input type="text" id="filterEdital" class="form-control form-control-sm" placeholder="Ex: 00083/2025">
        </div>
        <div class="col-md-4">
            <label class="filter-label">√ìRG√ÉO / UNIDADE COMPRADORA</label>
            <input type="text" id="filterOrgao" class="form-control form-control-sm" placeholder="Nome da Prefeitura">
        </div>
        <div class="col-md-3">
            <label class="filter-label">CIDADE / UF</label>
            <input type="text" id="filterLoc" class="form-control form-control-sm" placeholder="Cidade ou UF">
        </div>
    </div>

    <div id="monitor-content"></div>

    <div class="pagination-container">
        <button class="btn btn-outline-primary" id="prevPage">Anterior</button>
        <span id="pageInfo" class="fw-bold">P√°gina 1</span>
        <button class="btn btn-outline-primary" id="nextPage">Pr√≥xima</button>
        <div class="ms-3 d-flex align-items-center">
            <span class="me-2 small">Ir para:</span>
            <input type="number" id="jumpInput" class="form-control form-control-sm input-jump me-2">
            <button class="btn btn-dark btn-sm" id="btnJump">Ir</button>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">Detalhes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer bg-light">
                <a id="linkPncp" href="#" target="_blank" class="btn btn-primary fw-bold">Abrir no Portal PNCP</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let allData = [];
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 12;
const myModal = new bootstrap.Modal(document.getElementById('modalDetalhes'));

async function loadData() {
    try {
        const response = await fetch('pregacoes_pharma_limpos.json.gz');
        const blob = await response.blob();
        const ds = new DecompressionStream('gzip');
        const text = await new Response(blob.stream().pipeThrough(ds)).text();
        allData = JSON.parse(text);
        allData.sort((a, b) => new Date(b.data_enc) - new Date(a.data_enc));
        filteredData = [...allData];
        renderMonitor();
    } catch (e) { console.error("Erro:", e); }
}

function renderMonitor() {
    const content = document.getElementById('monitor-content');
    content.innerHTML = '';
    const items = filteredData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

    items.forEach(preg => {
        const div = document.createElement('div');
        div.className = 'card card-licitacao';
        const statusClass = `badge-${preg.tipo_licitacao.toLowerCase()}`;
        
        div.innerHTML = `
            <div class="header-card d-flex justify-content-between">
                <span><span class="badge badge-uf me-2">${preg.uf}</span> <strong>${preg.orgao}</strong></span>
                <span class="small">${preg.edital} | UASG: ${preg.uasg}</span>
            </div>
            <div class="card-body">
                <p class="mb-1 text-muted small"><strong>Cidade:</strong> ${preg.cidade} | <strong>Encerramento:</strong> ${new Date(preg.data_enc).toLocaleString()}</p>
                <p class="mb-2"><strong>Objeto:</strong> ${preg.objeto}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge ${statusClass} me-2">${preg.tipo_licitacao}</span>
                        <span class="badge bg-light text-dark border">Itens: ${preg.itens.length}</span>
                    </div>
                    <h5 class="mb-0 text-primary">R$ ${preg.valor_estimado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h5>
                    <button class="btn btn-sm btn-outline-primary fw-bold" onclick="showPopup('${preg.id}')">VER DETALHES</button>
                </div>
            </div>`;
        content.appendChild(div);
    });
    document.getElementById('pageInfo').innerText = `P√°gina ${currentPage} de ${Math.ceil(filteredData.length / itemsPerPage) || 1}`;
}

function showPopup(id) {
    const preg = allData.find(p => p.id === id);
    document.getElementById('modalTitle').innerText = `${preg.uf} - ${preg.orgao} (${preg.edital})`;
    document.getElementById('linkPncp').href = preg.link;

    const aguardando = preg.itens.filter(i => !i.fornecedor && !['FRACASSADO', 'DESERTO', 'CANCELADO'].includes(i.situacao));
    const falhas = preg.itens.filter(i => ['FRACASSADO', 'DESERTO', 'CANCELADO'].includes(i.situacao));
    const ganhos = {};

    preg.itens.filter(i => i.fornecedor && !['FRACASSADO', 'DESERTO', 'CANCELADO'].includes(i.situacao)).forEach(it => {
        if (!ganhos[it.fornecedor]) ganhos[it.fornecedor] = { itens: [], total: 0 };
        ganhos[it.fornecedor].itens.push(it);
        ganhos[it.fornecedor].total += (it.qtd * it.valHomologado);
    });

    let html = `<table class="table table-sm table-bordered table-itens">
        <thead class="table-dark">
            <tr>
                <th class="text-center">Item</th><th>Descri√ß√£o</th><th class="text-center">Exclusivo ME/EPP?</th>
                <th class="text-center">Qtd/Un</th><th class="text-center">Est. Unit</th>
                <th class="text-center">Homol. Unit</th><th class="text-center">Total Item</th>
            </tr>
        </thead><tbody>`;

    if (aguardando.length) {
        html += `<tr><td colspan="7" class="header-status-aguardando">‚è≥ ITENS AGUARDANDO RESULTADO</td></tr>`;
        aguardando.forEach(it => html += renderRow(it));
    }

    for (const [forn, d] of Object.entries(ganhos)) {
        html += `<tr class="header-fornecedor"><td colspan="6">üè¢ FORNECEDOR: ${forn}</td><td class="text-center">Soma: R$ ${d.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>`;
        d.itens.forEach(it => html += renderRow(it));
    }

    if (falhas.length) {
        html += `<tr><td colspan="7" class="header-falhas">‚ö†Ô∏è ITENS FRACASSADOS / DESERTOS / CANCELADOS</td></tr>`;
        falhas.forEach(it => html += renderRow(it, 'opacity-75 bg-light'));
    }

    html += `</tbody></table>`;
    document.getElementById('modalBody').innerHTML = html;
    myModal.show();
}

function renderRow(it, css = '') {
    const total = it.valHomologado ? (it.qtd * it.valHomologado) : 0;
    
    // LOGICA ROBUSTA: SIM (Vermelho) | N√ÉO (Verde)
    const isExclusivo = it.me_epp === true || it.me_epp === 1 || [1, 2, 3].includes(parseInt(it.benef));
    const benefTxt = isExclusivo ? 'SIM' : 'N√ÉO';
    const benefClass = isExclusivo ? 'benef-sim' : 'benef-nao';

    return `<tr class="${css}">
        <td class="text-center fw-bold">${it.n}</td>
        <td>${it.desc}</td>
        <td class="text-center ${benefClass}">${benefTxt}</td>
        <td class="text-center">${it.qtd} ${it.un}</td>
        <td class="val-estimado text-center">R$ ${it.valUnit.toFixed(4)}</td>
        <td class="val-homologado text-center">${it.valHomologado > 0 ? 'R$ '+it.valHomologado.toFixed(4) : '---'}</td>
        <td class="val-total text-center">${total > 0 ? 'R$ '+total.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '---'}</td>
    </tr>`;
}

function filtrar() {
    const d = document.getElementById('filterData').value;
    const e = document.getElementById('filterEdital').value.toUpperCase();
    const o = document.getElementById('filterOrgao').value.toUpperCase();
    const l = document.getElementById('filterLoc').value.toUpperCase();

    filteredData = allData.filter(p => {
        return (!d || p.data_enc.includes(d)) &&
               (!e || p.edital.includes(e) || p.uasg.includes(e)) &&
               (!o || p.orgao.toUpperCase().includes(o) || p.unidade.toUpperCase().includes(o)) &&
               (!l || p.cidade.toUpperCase().includes(l) || p.uf.toUpperCase().includes(l));
    });
    currentPage = 1; renderMonitor();
}

document.querySelectorAll('input').forEach(el => el.oninput = filtrar);
document.getElementById('prevPage').onclick = () => { if(currentPage > 1) { currentPage--; renderMonitor(); window.scrollTo(0,0); } };
document.getElementById('nextPage').onclick = () => { if(currentPage * itemsPerPage < filteredData.length) { currentPage++; renderMonitor(); window.scrollTo(0,0); } };
document.getElementById('btnJump').onclick = () => {
    const v = parseInt(document.getElementById('jumpInput').value);
    if(v >= 1 && v <= Math.ceil(filteredData.length / itemsPerPage)) { currentPage = v; renderMonitor(); window.scrollTo(0,0); }
};

loadData();
</script>
</body>
</html>
