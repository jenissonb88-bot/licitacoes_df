<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel PNCP - Sa√∫de</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; font-size: 0.85rem; }
        .table-homologada { border-left: 5px solid #198754 !important; background-color: #f0fff4; }
        .uasg-tag { font-weight: bold; color: #6610f2; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="container-fluid py-3">
    <h4 class="text-primary mb-3"><i class="fas fa-hospital-user"></i> Licita√ß√µes Sa√∫de: NE, SE, CO + AM/PA/TO</h4>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Publica√ß√£o / Abertura</th>
                        <th>UF / Cidade</th>
                        <th>√ìrg√£o / Unidade (UASG)</th>
                        <th>Objeto</th>
                        <th>Valor Est.</th>
                        <th class="text-center">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h6 class="modal-title">Itens e Resultados da Licita√ß√£o</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="loader" class="text-center d-none my-4">
                    <div class="spinner-border text-primary"></div>
                    <p>Buscando itens e vencedores no PNCP...</p>
                </div>
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Descri√ß√£o / Fornecedor</th>
                            <th>Qtd</th>
                            <th>Unit√°rio (4 casas)</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="listaItens"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="dados/oportunidades.js"></script>

<script>
    const fmt4 = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 4 });
    const fmt2 = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

    function renderizar() {
        const tbody = document.getElementById('corpoTabela');
        if (typeof dadosLicitacoes === 'undefined') {
            tbody.innerHTML = "<tr><td colspan='6' class='text-center p-5 text-danger'>Erro: Arquivo 'dados/oportunidades.js' n√£o encontrado.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        dadosLicitacoes.forEach(item => {
            const dtPub = new Date(item.data_pub).toLocaleDateString();
            const dtAbr = item.data_abertura ? new Date(item.data_abertura).toLocaleString() : 'A definir';
            
            tbody.innerHTML += `
                <tr>
                    <td><small>Pub: ${dtPub}</small><br><span class="badge bg-warning text-dark">Abr: ${dtAbr}</span></td>
                    <td><b>${item.uf}</b><br><small>${item.cidade}</small></td>
                    <td>${item.orgao}<br><span class="uasg-tag">UASG: ${item.uasg}</span></td>
                    <td><small>${item.objeto.substring(0, 120)}...</small></td>
                    <td class="fw-bold">${fmt2.format(item.valor_total)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary" onclick="verDetalhes('${item.link_api}')"><i class="fas fa-search-plus"></i> Detalhes</button>
                    </td>
                </tr>`;
        });
    }

    async function verDetalhes(url) {
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
        const lista = document.getElementById('listaItens');
        const loader = document.getElementById('loader');
        
        lista.innerHTML = "";
        loader.classList.remove('d-none');
        modal.show();

        try {
            // Requisi√ß√£o de Itens e Resultados em paralelo
            const [rI, rR] = await Promise.all([fetch(`${url}/itens`), fetch(`${url}/resultados`)]);
            
            const itens = await rI.json();
            const resultados = rR.ok ? await rR.json() : [];
            
            // Mapa de vencedores
            const mapaVencedores = {};
            resultados.forEach(r => mapaVencedores[r.numeroItem] = r);

            loader.classList.add('d-none');
            
            itens.slice(0, 150).forEach(i => {
                const v = mapaVencedores[i.numeroItem];
                const temVencedor = !!v;
                
                lista.innerHTML += `
                    <tr class="${temVencedor ? 'table-homologada' : ''}">
                        <td>${i.numeroItem}</td>
                        <td>
                            ${i.descricao}
                            ${temVencedor ? `<br><small class="text-success">üèÜ <b>${v.nomeRazaoSocialFornecedor}</b> (${v.niFornecedor})</small>` : ''}
                        </td>
                        <td>${i.quantidade}</td>
                        <td>${temVencedor ? fmt4.format(v.valorUnitarioHomologado) : fmt4.format(i.valorUnitarioEstimado)}</td>
                        <td>${temVencedor ? fmt2.format(v.valorTotalHomologado) : fmt2.format(i.valorTotalEstimado)}</td>
                        <td><span class="badge ${temVencedor ? 'bg-success' : 'bg-secondary'}">${temVencedor ? 'Homologado' : 'Aberto'}</span></td>
                    </tr>`;
            });
        } catch (e) { 
            loader.innerHTML = "<div class='alert alert-danger'>Erro ao consultar API do PNCP. O edital pode ser muito recente.</div>"; 
        }
    }

    window.onload = renderizar;
</script>
</body>
</html>
