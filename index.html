<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper PNCP - Monitor de Licitações</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-dark: #2c3e50; --accent-blue: #3498db; --danger-red: #e74c3c; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; font-size: 0.85rem; }
        
        /* Cabeçalho */
        .header-bar { background: var(--primary-dark); color: white; padding: 12px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .app-logo { font-size: 1.2rem; font-weight: 700; letter-spacing: 1px; }

        /* Tabela Principal */
        .card-table { border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .table-pncp thead { background-color: #34495e; color: white; text-transform: uppercase; font-size: 0.75rem; }
        .table-pncp th { padding: 15px 10px; border: none; }
        .table-pncp td { vertical-align: middle; padding: 12px 10px; border-bottom: 1px solid #eee; }
        
        /* Estilização Órgão/Unidade */
        .org-uasg { font-weight: 700; color: #333; display: block; }
        .unit-name { color: #7f8c8d; font-size: 0.8rem; display: block; }

        /* Limite de 3 Linhas para o Objeto */
        .text-truncate-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
        }

        /* Status e Valores */
        .val-global { font-family: 'Consolas', monospace; font-weight: 700; color: var(--accent-blue); }
        .date-badge { font-weight: 600; color: var(--danger-red); }

        /* Modal e Grupos */
        .modal-header { background: var(--primary-dark); color: white; }
        .group-card { border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 15px; }
        .group-header { padding: 10px 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .status-winner { background: #d1e7dd; color: #0f5132; border-left: 5px solid #198754; }
        .status-open { background: #fff3cd; color: #664d03; border-left: 5px solid #ffc107; }

        /* Paginação */
        .pagination-container { background: white; padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: center; align-items: center; gap: 15px; }
    </style>
</head>
<body>

<div class="header-bar d-flex justify-content-between align-items-center sticky-top">
    <div class="app-logo"><i class="fas fa-crosshairs me-2"></i>SNIPER PNCP</div>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-success" onclick="abrirModalManual()">
            <i class="fas fa-plus-circle me-1"></i> Adicionar URL
        </button>
        <button class="btn btn-sm btn-outline-light" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="card card-table p-3 mb-3">
        <div class="row g-2">
            <div class="col-md-1"><input id="fUf" class="form-control form-control-sm" placeholder="UF" onkeyup="render()"></div>
            <div class="col-md-3"><input id="fOrgao" class="form-control form-control-sm" placeholder="Órgão, UASG ou Unidade" onkeyup="render()"></div>
            <div class="col-md-3"><input id="fObjeto" class="form-control form-control-sm" placeholder="Palavra no Objeto" onkeyup="render()"></div>
            <div class="col-md-2"><input id="fEdital" class="form-control form-control-sm" placeholder="Nº Edital" onkeyup="render()"></div>
            <div class="col-md-2"><input type="date" id="fDataEnc" class="form-control form-control-sm" title="Filtrar por Data de Encerramento" onchange="render()"></div>
            <div class="col-md-1"><button class="btn btn-sm btn-secondary w-100" onclick="limparFiltros()">Limpar</button></div>
        </div>
    </div>

    <div class="card card-table">
        <div class="table-responsive">
            <table class="table table-hover table-pncp mb-0">
                <thead>
                    <tr>
                        <th style="width: 100px;">Encerramento</th>
                        <th style="width: 40px;">UF</th>
                        <th>Código - Órgão / Unidade Compradora</th>
                        <th style="width: 100px;">Edital</th>
                        <th>Objeto da Licitação</th>
                        <th class="text-center" style="width: 60px;">Itens</th>
                        <th class="text-end" style="width: 130px;">Valor Global</th>
                        <th class="text-center" style="width: 120px;">Ações</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    </tbody>
            </table>
        </div>

        <div class="pagination-container">
            <button class="btn btn-sm btn-outline-secondary" onclick="mudarPagina(-1)" id="btnAnt">Anterior</button>
            <span class="text-muted">Página <span id="pagAtual" class="fw-bold">1</span> de <span id="pagTotal">1</span></span>
            <button class="btn btn-sm btn-outline-secondary" onclick="mudarPagina(1)" id="btnProx">Próximo</button>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="fas fa-info-circle me-2"></i> Detalhamento por Fornecedor / Item</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div id="modalBody" class="modal-body bg-light">
                </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalManual" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white py-2">
                <h6 class="modal-title">Solicitar Captura via URL</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted">Cole o link do PNCP. O robô irá processar esta URL em sua próxima execução.</p>
                <input type="text" id="urlManual" class="form-control form-control-sm mb-3" placeholder="https://pncp.gov.br/app/editais/...">
                <div class="alert alert-info py-2 small">
                    <i class="fas fa-info-circle me-1"></i> Nota: Para executar, o robô precisa ler o arquivo <b>urls.txt</b> no seu GitHub.
                </div>
            </div>
            <div class="modal-footer py-1">
                <button class="btn btn-primary btn-sm" onclick="salvarUrlManual()">Enviar para Fila</button>
            </div>
        </div>
    </div>
</div>

<script src="dados/oportunidades.js"></script>
<script>
    const ITENS_POR_PAG = 20;
    let pagina = 1;
    let dadosOriginais = [];
    let dadosFiltrados = [];

    const fmtBrl = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmtData = d => d ? new Date(d).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : '--/--/----';

    window.onload = () => {
        const excluidos = JSON.parse(localStorage.getItem('sniper_excluidos') || '[]');
        const raw = (typeof dadosLicitacoes !== 'undefined') ? dadosLicitacoes : [];
        
        dadosOriginais = raw.filter(d => !excluidos.includes(d.id));
        dadosFiltrados = [...dadosOriginais];
        render();
    };

    function render() {
        const uf = document.getElementById('fUf').value.toUpperCase();
        const org = document.getElementById('fOrgao').value.toUpperCase();
        const obj = document.getElementById('fObjeto').value.toUpperCase();
        const edt = document.getElementById('fEdital').value.toUpperCase();
        const dataEnc = document.getElementById('fDataEnc').value; 

        const filtrados = dadosOriginais.filter(d => 
            (d.uf || '').includes(uf) &&
            ((d.orgao || '').toUpperCase().includes(org) || (d.uasg || '').includes(org) || (d.unidade_compradora || '').toUpperCase().includes(org)) &&
            (d.objeto || '').toUpperCase().includes(obj) &&
            (d.edital || '').includes(edt) &&
            (!dataEnc || (d.data_encerramento && d.data_encerramento.startsWith(dataEnc)))
        );

        const totalPaginas = Math.ceil(filtrados.length / ITENS_POR_PAG) || 1;
        if (pagina > totalPaginas) pagina = totalPaginas;
        if (pagina < 1) pagina = 1;
        
        const inicio = (pagina - 1) * ITENS_POR_PAG;
        const fim = inicio + ITENS_POR_PAG;
        const lote = filtrados.slice(inicio, fim);

        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        lote.forEach(d => {
            const valor = (d.is_sigiloso || !d.valor_global) ? '<span class="text-muted">Sigiloso</span>' : fmtBrl.format(d.valor_global);
            
            tbody.innerHTML += `
                <tr>
                    <td class="date-badge">${fmtData(d.data_encerramento)}</td>
                    <td class="text-center fw-bold">${d.uf}</td>
                    <td>
                        <span class="org-uasg">${d.uasg} - ${d.orgao}</span>
                        <span class="unit-name">${d.unidade_compradora}</span>
                    </td>
                    <td><span class="badge bg-light text-dark border">${d.edital}</span></td>
                    
                    <td><div class="text-truncate-3" style="max-width: 350px;" title="${d.objeto}">${d.objeto}</div></td>
                    
                    <td class="text-center fw-bold">${d.qtd_itens || 0}</td>
                    <td class="text-end val-global">${valor}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary border-0" onclick="verDetalhes('${d.id}')" title="Ver Itens"><i class="fas fa-eye"></i></button>
                        <a href="${d.link}" target="_blank" class="btn btn-sm btn-outline-dark border-0" title="Link PNCP"><i class="fas fa-external-link-alt"></i></a>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="excluirLicitacao('${d.id}')" title="Ocultar"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('pagAtual').innerText = pagina;
        document.getElementById('pagTotal').innerText = totalPaginas;
        document.getElementById('btnAnt').disabled = (pagina === 1);
        document.getElementById('btnProx').disabled = (pagina === totalPaginas);
    }

    function verDetalhes(id) {
        const lic = dadosOriginais.find(d => d.id === id);
        if (!lic) return;

        const body = document.getElementById('modalBody');
        body.innerHTML = '';

        const grupos = {};
        lic.itens.forEach(i => {
            const k = i.fornecedor || 'EM ANDAMENTO';
            if (!grupos[k]) grupos[k] = [];
            grupos[k].push(i);
        });

        const chaves = Object.keys(grupos).sort();

        chaves.forEach(k => {
            const lista = grupos[k];
            const isPendente = k === 'EM ANDAMENTO';
            const classe = isPendente ? 'status-open' : 'status-winner';
            
            let tabela = `
                <div class="group-card shadow-sm mb-3">
                    <div class="group-header ${classe}">
                        <span><i class="fas ${isPendente ? 'fa-clock' : 'fa-trophy'} me-2"></i> ${k}</span>
                        <span class="badge bg-white text-dark border">${lista.length} Itens</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered mb-0 align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px">Item</th>
                                    <th>Descrição</th>
                                    <th class="text-center" style="width: 60px">Qtd</th>
                                    <th class="text-end" style="width: 100px">Unit. Est.</th>
                                    <th class="text-end" style="width: 100px">Total Est.</th>
                                    ${!isPendente ? '<th class="text-end text-success" style="width: 100px">Unit. Hom.</th>' : ''}
                                    ${!isPendente ? '<th class="text-end text-success" style="width: 100px">Total Hom.</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>`;
            
            lista.forEach(it => {
                tabela += `
                    <tr>
                        <td class="text-center fw-bold">${it.item}</td>
                        <td style="font-size: 0.8rem;">${it.desc}</td>
                        <td class="text-center">${it.qtd}</td>
                        <td class="text-end text-muted">${fmtBrl.format(it.unitario_est)}</td>
                        <td class="text-end text-muted">${fmtBrl.format(it.total_est)}</td>
                        ${!isPendente ? `<td class="text-end fw-bold text-success">${fmtBrl.format(it.unitario_hom)}</td>` : ''}
                        ${!isPendente ? `<td class="text-end fw-bold text-success">${fmtBrl.format(it.total_hom)}</td>` : ''}
                    </tr>`;
            });

            tabela += `</tbody></table></div></div>`;
            body.innerHTML += tabela;
        });

        new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
    }

    function excluirLicitacao(id) {
        if (confirm('Deseja ocultar esta licitação permanentemente desta lista?')) {
            const excluidos = JSON.parse(localStorage.getItem('sniper_excluidos') || '[]');
            excluidos.push(id);
            localStorage.setItem('sniper_excluidos', JSON.stringify(excluidos));
            window.location.reload();
        }
    }

    function abrirModalManual() {
        new bootstrap.Modal(document.getElementById('modalManual')).show();
    }

    function salvarUrlManual() {
        const url = document.getElementById('urlManual').value;
        if (!url.includes('pncp.gov.br')) {
            alert('Por favor, insira um link válido do portal PNCP.');
            return;
        }
        alert('Instrução: Copie este link e cole no arquivo "urls.txt" do seu repositório no GitHub para que o robô faça a captura na próxima execução.');
    }

    function mudarPagina(dir) { pagina += dir; render(); window.scrollTo(0,0); }
    function limparFiltros() { document.querySelectorAll('input:not([type="date"])').forEach(i => i.value = ''); document.getElementById('fDataEnc').value = ''; render(); }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
