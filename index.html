<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pharma - Monitor V15 (Dados Reais)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-dark: #2c3e50; --accent-blue: #3498db; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; font-size: 0.85rem; }
        
        .header-bar { background: var(--primary-dark); color: white; padding: 12px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-table { border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .table-pncp thead { background-color: #34495e; color: white; text-transform: uppercase; font-size: 0.75rem; cursor: pointer; }
        .table-pncp thead th:hover { background-color: #2c3e50; }
        .table-pncp td { vertical-align: middle; padding: 10px; border-bottom: 1px solid #eee; }

        .uasg-orgao { font-weight: 700; color: #2c3e50; font-size: 0.9rem; }
        .unidade-comp { color: #555; font-size: 0.8rem; display: block; margin-top: 2px; }
        .local-uf { color: #7f8c8d; font-size: 0.8rem; display: block; font-style: italic; }

        .badge-tipo { font-size: 0.7rem; font-weight: 700; padding: 4px 8px; border-radius: 4px; display: inline-block; width: 100%; text-align: center; }
        .tipo-amplo { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .tipo-exclusivo { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        .tipo-parcial { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }

        .group-header { padding: 10px 15px; font-weight: 700; color: white; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .bg-fornecedor { background-color: #2c3e50; } 
        .bg-andamento { background-color: #198754; } 
        .bg-fracassado { background-color: #dc3545; } 
        
        .me-epp-sim { color: #dc3545; font-weight: 800; } 
        .me-epp-nao { color: #198754; font-weight: 700; }
        
        .badge-sigiloso { background-color: #e9ecef; color: #6c757d; border: 1px solid #ced4da; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .sort-icon { float: right; margin-left: 5px; opacity: 0.5; }
        .active-sort { opacity: 1; color: #48c774; }
        .error-box { max-width: 500px; text-align: center; padding: 20px; border-radius: 10px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div id="spinner-container">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3 text-secondary fw-bold fs-5" id="loading-msg">Iniciando sistema...</div>
    </div>
    <div id="error-container" class="error-box d-none">
        <i class="fas fa-exclamation-circle text-danger fa-4x mb-3"></i>
        <h4 class="text-danger">Atenção</h4>
        <p id="error-msg" class="text-muted mb-4"></p>
        <button class="btn btn-primary" onclick="location.reload()">Tentar Novamente</button>
    </div>
</div>

<div class="header-bar d-flex justify-content-between align-items-center sticky-top">
    <div class="fw-bold fs-5"><i class="fas fa-crosshairs me-2"></i>SNIPER PHARMA V15</div>
    <div class="d-flex align-items-center gap-3">
        <div class="form-check form-switch text-white">
            <input class="form-check-input" type="checkbox" id="chkOcultarVencidos" onchange="render()">
            <label class="form-check-label small" for="chkOcultarVencidos">Ocultar Vencidos</label>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="location.reload()"><i class="fas fa-sync-alt"></i></button>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="card card-table p-3 mb-3">
        <div class="row g-2">
            <div class="col-md-2">
                <label class="form-label small mb-0 text-muted">Data Enc.</label>
                <input type="date" id="fDataEnc" class="form-control form-control-sm" onchange="render()">
            </div>
            <div class="col-md-2">
                <label class="form-label small mb-0 text-muted">UASG / Edital</label>
                <input id="fUasgEdital" class="form-control form-control-sm" placeholder="Ex: 12345 ou 90/2026" onkeyup="render()">
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-0 text-muted">Cidade / UF</label>
                <input id="fCidadeUf" class="form-control form-control-sm" placeholder="Ex: Recife ou PE" onkeyup="render()">
            </div>
            <div class="col-md-3">
                <label class="form-label small mb-0 text-muted">Órgão / Unidade</label>
                <input id="fOrgaoUnid" class="form-control form-control-sm" placeholder="Nome do Órgão" onkeyup="render()">
            </div>
            <div class="col-md-2">
                <label class="form-label small mb-0 text-muted">Tipo</label>
                <select id="fTipo" class="form-select form-select-sm" onchange="render()">
                    <option value="">Todos</option>
                    <option value="AMPLO">Amplo</option>
                    <option value="EXCLUSIVO">Exclusivo</option>
                    <option value="PARCIAL">Parcial</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card card-table">
        <div class="table-responsive">
            <table class="table table-hover table-pncp mb-0">
                <thead>
                    <tr>
                        <th style="width: 110px;" onclick="ordenar('data_enc')">Data Fim <i id="icon-data_enc" class="fas fa-sort sort-icon"></i></th>
                        <th style="width: 80px;" class="text-center" onclick="ordenar('tipo')">Tipo <i id="icon-tipo" class="fas fa-sort sort-icon"></i></th>
                        <th onclick="ordenar('orgao')">Órgão / Unidade / Local <i id="icon-orgao" class="fas fa-sort sort-icon"></i></th>
                        <th style="width: 100px;">Edital</th>
                        <th>Objeto</th>
                        <th class="text-end" style="width: 130px;" onclick="ordenar('valor')">Valor Est. <i id="icon-valor" class="fas fa-sort sort-icon"></i></th>
                        <th class="text-center" style="width: 80px;">Ação</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div class="p-3 d-flex justify-content-between align-items-center border-top">
            <div class="text-muted small">
                Exibindo <span id="totalVisible" class="fw-bold">0</span> de <span id="totalReg" class="fw-bold">0</span> registros
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-sm btn-secondary me-2" onclick="mudarPagina(-1)" id="btnAnt">Anterior</button>
                <span class="text-muted small mx-2">Página <span id="pagAtual">1</span> de <span id="pagTotal">1</span></span>
                <button class="btn btn-sm btn-secondary ms-2" onclick="mudarPagina(1)" id="btnProx">Próximo</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2 bg-dark text-white">
                <h6 class="modal-title">Detalhamento do Processo</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div id="modalBody" class="modal-body bg-light"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

<script>
    const FILE_URL = 'pregacoes_pharma_limpos.json.gz';
    let dadosOriginais = [], dadosFiltrados = [];
    let pagina = 1;
    const ITENS_POR_PAG = 20;
    
    let ordemAtual = { campo: 'data_enc', direcao: 'asc' }; 
    const fmtBrl = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmtData = d => d ? new Date(d).toLocaleDateString('pt-BR') : '--';

    window.onload = async () => {
        try {
            updateLoading("Baixando arquivo de dados...");
            const res = await fetch(`${FILE_URL}?v=${Date.now()}`);
            if(!res.ok) throw new Error("Arquivo não encontrado.");
            const blob = await res.blob();
            const arrayBuffer = await blob.arrayBuffer();
            updateLoading("Descompactando...");
            let text;
            try { text = pako.ungzip(new Uint8Array(arrayBuffer), {to:'string'}); }
            catch { text = await new Response(blob).text(); }
            dadosOriginais = JSON.parse(text);
            if (!Array.isArray(dadosOriginais)) dadosOriginais = [];
            ordenar('data_enc', true);
            document.getElementById('loading-overlay').style.display = 'none';
        } catch (e) {
            console.error(e);
            showError(e.message);
        }
    };

    function updateLoading(msg) { const el = document.getElementById('loading-msg'); if(el) el.innerText = msg; }
    function showError(msg) {
        document.getElementById('spinner-container').classList.add('d-none');
        document.getElementById('error-container').classList.remove('d-none');
        document.getElementById('error-msg').innerHTML = msg;
    }

    function ordenar(campo, force = false) {
        if (!force) {
            if (ordemAtual.campo === campo) ordemAtual.direcao = ordemAtual.direcao === 'asc' ? 'desc' : 'asc';
            else { ordemAtual.campo = campo; ordemAtual.direcao = 'asc'; }
        }
        document.querySelectorAll('.sort-icon').forEach(i => i.className = 'fas fa-sort sort-icon');
        const icon = document.getElementById(`icon-${campo}`);
        if(icon) icon.className = `fas fa-sort-${ordemAtual.direcao === 'asc' ? 'down' : 'up'} sort-icon active-sort`;
        render();
    }

    function render() {
        const fData = document.getElementById('fDataEnc').value;
        const fUasgEdital = document.getElementById('fUasgEdital').value.toUpperCase();
        const fCidadeUf = document.getElementById('fCidadeUf').value.toUpperCase();
        const fOrgaoUnid = document.getElementById('fOrgaoUnid').value.toUpperCase();
        const fTipo = document.getElementById('fTipo').value;
        const ocultarVencidos = document.getElementById('chkOcultarVencidos').checked;
        const hoje = new Date();

        dadosFiltrados = dadosOriginais.filter(d => {
            const dataObj = d.data_enc ? new Date(d.data_enc) : null;
            if (ocultarVencidos && dataObj && dataObj < hoje) return false;
            if (fData && d.data_enc && !d.data_enc.startsWith(fData)) return false;
            const txtUasgEdital = ((d.uasg || '') + ' ' + (d.edital || '')).toUpperCase();
            if (fUasgEdital && !txtUasgEdital.includes(fUasgEdital)) return false;
            const txtCidadeUf = ((d.cidade || '') + ' ' + (d.uf || '')).toUpperCase();
            if (fCidadeUf && !txtCidadeUf.includes(fCidadeUf)) return false;
            const txtOrgaoUnid = ((d.orgao || '') + ' ' + (d.unidade || '')).toUpperCase();
            if (fOrgaoUnid && !txtOrgaoUnid.includes(fOrgaoUnid)) return false;
            if (fTipo && d.tipo_licitacao !== fTipo) return false;
            return true;
        });

        dadosFiltrados.sort((a, b) => {
            let valA, valB;
            switch (ordemAtual.campo) {
                case 'data_enc':
                    valA = a.data_enc ? new Date(a.data_enc).getTime() : 0;
                    valB = b.data_enc ? new Date(b.data_enc).getTime() : 0;
                    if (ordemAtual.direcao === 'asc') return valB - valA; 
                    else return valA - valB;
                case 'valor':
                    valA = a.valor_estimado || 0; valB = b.valor_estimado || 0; 
                    if (valA < valB) return ordemAtual.direcao === 'asc' ? -1 : 1; else return 1;
                case 'orgao':
                    valA = (a.orgao || '').toLowerCase(); valB = (b.orgao || '').toLowerCase();
                    if (valA < valB) return ordemAtual.direcao === 'asc' ? -1 : 1; else return 1;
                case 'tipo':
                    valA = (a.tipo_licitacao || '').toLowerCase(); valB = (b.tipo_licitacao || '').toLowerCase();
                    if (valA < valB) return ordemAtual.direcao === 'asc' ? -1 : 1; else return 1;
                default: return 0;
            }
        });

        const totalPaginas = Math.ceil(dadosFiltrados.length / ITENS_POR_PAG) || 1;
        if(pagina > totalPaginas) pagina = totalPaginas;
        if(pagina < 1) pagina = 1;
        const inicio = (pagina - 1) * ITENS_POR_PAG;
        const lote = dadosFiltrados.slice(inicio, inicio + ITENS_POR_PAG);
        
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        lote.forEach(d => {
            const dataObj = d.data_enc ? new Date(d.data_enc) : null;
            let corData = 'text-dark';
            if (dataObj) {
                const diffHoras = (dataObj - hoje) / 36e5; 
                if (diffHoras < 0) corData = 'text-decoration-line-through text-muted';
                else if (diffHoras < 48) corData = 'text-danger fw-bold';
            }

            let classeTipo = 'tipo-amplo'; 
            if(d.tipo_licitacao === 'EXCLUSIVO') classeTipo = 'tipo-exclusivo';
            if(d.tipo_licitacao === 'PARCIAL') classeTipo = 'tipo-parcial';
            const qtdItens = d.itens ? d.itens.length : 0;
            const displayValor = (!d.valor_estimado || parseFloat(d.valor_estimado) === 0) 
                ? '<span class="badge-sigiloso"><i class="fas fa-eye-slash me-1"></i>Sigiloso</span>' 
                : `<span class="fw-bold text-success">${fmtBrl.format(d.valor_estimado)}</span>`;

            tbody.innerHTML += `
                <tr>
                    <td class="${corData}">${fmtData(d.data_enc)}</td>
                    <td class="text-center"><span class="badge-tipo ${classeTipo}">${d.tipo_licitacao || 'AMPLO'}</span></td>
                    <td><div class="uasg-orgao">UASG ${d.uasg || '---'} - ${d.orgao}</div><div class="unidade-comp">${d.unidade}</div><div class="local-uf">${d.cidade} - ${d.uf}</div></td>
                    <td>${d.edital || '-'}</td>
                    <td><div class="text-truncate" style="max-width:350px" title="${d.objeto}">${d.objeto}</div></td>
                    <td class="text-end align-middle"><div>${displayValor}</div><div class="small text-muted mt-1" style="font-size:0.75rem;"><i class="fas fa-box-open me-1"></i>${qtdItens} itens</div></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes('${d.id}')"><i class="fas fa-list"></i></button>
                        <a href="${d.link}" target="_blank" class="btn btn-sm btn-outline-dark"><i class="fas fa-external-link-alt"></i></a>
                    </td>
                </tr>`;
        });

        document.getElementById('pagAtual').innerText = pagina;
        document.getElementById('pagTotal').innerText = totalPaginas;
        document.getElementById('totalReg').innerText = dadosOriginais.length;
        document.getElementById('totalVisible').innerText = dadosFiltrados.length;
        document.getElementById('btnAnt').disabled = pagina === 1;
        document.getElementById('btnProx').disabled = pagina === totalPaginas;
    }

    function mudarPagina(d) { pagina += d; render(); document.querySelector('.card-table').scrollIntoView(); }

    function verDetalhes(id) {
        const lic = dadosOriginais.find(d => d.id === id);
        if(!lic) return;
        
        const aguardando = [];
        const homologados = {}; 
        const fracassados = [];

        lic.itens.forEach(it => {
            const sit = (it.situacao || 'EM_ANDAMENTO');
            if (sit === 'HOMOLOGADO') {
                const forn = it.fornecedor || 'FORNECEDOR NÃO INFORMADO';
                if (!homologados[forn]) homologados[forn] = [];
                homologados[forn].push(it);
            } 
            else if (['CANCELADO', 'FRACASSADO', 'DESERTO'].some(s => sit.includes(s))) {
                fracassados.push(it);
            } 
            else {
                aguardando.push(it);
            }
        });

        let html = `
            <div class="alert alert-light border shadow-sm">
                <strong>${lic.orgao}</strong><br>
                <small>${lic.cidade}/${lic.uf} - Edital: ${lic.edital}</small>
                <div class="mt-2 text-muted small">${lic.objeto}</div>
            </div>`;

        // AGUARDANDO
        if (aguardando.length > 0) {
            html += `<div class="card mb-3 border-success shadow-sm mt-3">
                <div class="group-header bg-andamento">
                    <span><i class="fas fa-clock me-2"></i> Aguardando Resultados</span>
                    <span class="badge bg-white text-dark">${aguardando.length} itens</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered table-itens mb-0">
                            <thead><tr>
                                <th style="width:50px">Item</th><th style="width:60px">ME/EPP</th>
                                <th>Descrição</th><th style="width:70px">Qtd</th>
                                <th style="width:60px">Un</th><th style="width:110px">Val. Est.</th>
                            </tr></thead>
                            <tbody>${gerarLinhasTabela(aguardando, false)}</tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }

        // HOMOLOGADOS
        if (Object.keys(homologados).length > 0) {
            html += `<h6 class="mt-4 border-bottom pb-2 fw-bold text-success"><i class="fas fa-check-circle me-1"></i> Itens Homologados por Fornecedor</h6>`;
            for (const [fornecedor, itens] of Object.entries(homologados)) {
                const totalFornecedor = itens.reduce((acc, it) => acc + ((it.qtd || 0) * (it.valHomologado || 0)), 0);
                html += `<div class="card mb-3 shadow-sm border-dark">
                    <div class="group-header bg-fornecedor">
                        <span><i class="fas fa-truck me-2"></i> ${fornecedor}</span>
                        <span class="badge bg-warning text-dark">${fmtBrl.format(totalFornecedor)}</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-itens mb-0">
                                <thead><tr>
                                    <th style="width:50px">Item</th><th style="width:60px">ME/EPP</th>
                                    <th>Descrição</th><th style="width:70px">Qtd</th>
                                    <th style="width:60px">Un</th><th style="width:110px">Unit. Hom.</th>
                                    <th style="width:110px">Total Hom.</th>
                                </tr></thead>
                                <tbody>${gerarLinhasTabela(itens, true)}</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            }
        }

        // FRACASSADOS
        if (fracassados.length > 0) {
            html += `<div class="card mb-3 border-danger shadow-sm mt-4">
                <div class="group-header bg-fracassado">
                    <span><i class="fas fa-times-circle me-2"></i> Fracassados / Cancelados</span>
                    <span class="badge bg-white text-dark">${fracassados.length} itens</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered table-itens mb-0">
                            <thead><tr>
                                <th style="width:50px">Item</th><th style="width:60px">ME/EPP</th>
                                <th>Descrição</th><th style="width:70px">Qtd</th>
                                <th style="width:60px">Un</th><th>Situação</th>
                            </tr></thead>
                            <tbody>${gerarLinhasTabela(fracassados, false, true)}</tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        }

        document.getElementById('modalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
    }

    function gerarLinhasTabela(lista, isHomologado, isFracassado = false) {
        return lista.map(it => {
            const txtMeEpp = it.me_epp 
                ? '<span class="me-epp-sim">SIM</span>' 
                : '<span class="me-epp-nao">NÃO</span>';
            
            let colsExtras = '';
            if (isHomologado) {
                const totalItem = (it.qtd || 0) * (it.valHomologado || 0);
                colsExtras = `<td class="text-end fw-bold text-primary">${fmtBrl.format(it.valHomologado)}</td><td class="text-end fw-bold text-dark bg-light">${fmtBrl.format(totalItem)}</td>`;
            } else if (isFracassado) {
                colsExtras = `<td class="text-center fw-bold text-danger">${it.situacao}</td>`;
            } else {
                colsExtras = `<td class="text-end">${fmtBrl.format(it.valUnit)}</td>`;
            }

            return `<tr>
                <td class="text-center">${it.n}</td><td class="text-center">${txtMeEpp}</td>
                <td>${it.desc}</td><td class="text-center">${it.qtd}</td><td class="text-center">${it.un}</td>
                ${colsExtras}
            </tr>`;
        }).join('');
    }
</script>
</body>
</html>
