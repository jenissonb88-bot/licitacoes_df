<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analista de Licitações | Dashboard PNCP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <header class="bg-slate-900 text-white p-4 shadow-xl border-b-4 border-blue-500">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight"><i class="fas fa-microscope text-blue-400 mr-2"></i> MONITOR DE LICITAÇÕES</h1>
                <p class="text-xs text-gray-400 uppercase tracking-widest">Setor de Saúde & Higiene | 2026</p>
            </div>
            <div id="status-box" class="text-right">
                <span id="data-atualizacao" class="text-[10px] bg-slate-800 px-3 py-1 rounded-full border border-slate-700">Aguardando dados...</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 lg:p-8">
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8 grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Filtrar por UF</label>
                <select id="filtroUF" onchange="aplicarFiltros()" class="w-full border-gray-300 rounded-lg p-2.5 bg-gray-50 focus:ring-2 focus:ring-blue-500 shadow-sm">
                    <option value="">Brasil (Todos)</option>
                </select>
            </div>
            <div class="md:col-span-2">
                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">Órgão ou Palavra-Chave no Objeto</label>
                <input type="text" id="buscaGeral" onkeyup="aplicarFiltros()" placeholder="Ex: Hospital, Soro, Prefeitura..." class="w-full border-gray-300 rounded-lg p-2.5 bg-gray-50 focus:ring-2 focus:ring-blue-500 shadow-sm">
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.reload()" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2.5 rounded-lg transition border border-slate-300">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button onclick="abrirModalManual()" class="flex-[3] bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg transition shadow-md">
                    <i class="fas fa-plus mr-2"></i> Inclusão Manual
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-50 border-b border-gray-200">
                    <tr>
                        <th class="p-4 text-xs font-bold text-gray-400 uppercase">Local</th>
                        <th class="p-4 text-xs font-bold text-gray-400 uppercase">Órgão / Ente Público</th>
                        <th class="p-4 text-xs font-bold text-gray-400 uppercase">Objeto da Contratação</th>
                        <th class="p-4 text-xs font-bold text-gray-400 uppercase text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo" class="divide-y divide-gray-100 text-gray-700">
                    <tr><td colspan="4" class="p-20 text-center text-gray-400 italic">Carregando oportunidades do PNCP...</td></tr>
                </tbody>
            </table>
            
            <div class="bg-slate-50 p-4 border-t flex justify-between items-center">
                <span id="contador-texto" class="text-sm font-medium text-slate-500 italic">0 itens encontrados</span>
                <div class="flex gap-2" id="paginacao">
                    </div>
            </div>
        </div>
    </main>

    <script>
        let baseCompleta = [];
        let baseFiltrada = [];

        async function inicializar() {
            try {
                const res = await fetch('dados/oportunidades.json');
                if (!res.ok) throw new Error();
                baseCompleta = await res.json();
                
                // Popular UFs dinamicamente
                const ufs = [...new Set(baseCompleta.map(i => i.uf))].filter(Boolean).sort();
                const select = document.getElementById('filtroUF');
                ufs.forEach(uf => select.innerHTML += `<option value="${uf}">${uf}</option>`);

                document.getElementById('data-atualizacao').innerText = `Última varredura: ${new Date().toLocaleDateString()}`;
                aplicarFiltros();
            } catch (e) {
                document.getElementById('tabelaCorpo').innerHTML = '<tr><td colspan="4" class="p-20 text-center"><i class="fas fa-exclamation-triangle text-amber-500 text-2xl mb-2"></i><br>Aguardando primeira execução do robô no GitHub Actions.</td></tr>';
            }
        }

        function aplicarFiltros() {
            const uf = document.getElementById('filtroUF').value;
            const busca = document.getElementById('buscaGeral').value.toLowerCase();

            baseFiltrada = baseCompleta.filter(item => {
                const matchUF = uf === "" || item.uf === uf;
                const matchBusca = item.orgao.toLowerCase().includes(busca) || item.objeto.toLowerCase().includes(busca);
                return matchUF && matchBusca;
            });

            renderizar();
        }

        function renderizar() {
            const corpo = document.getElementById('tabelaCorpo');
            const contador = document.getElementById('contador-texto');
            
            if (baseFiltrada.length === 0) {
                corpo.innerHTML = '<tr><td colspan="4" class="p-20 text-center text-gray-400">Nenhum edital encontrado para este filtro.</td></tr>';
                contador.innerText = "0 itens encontrados";
                return;
            }

            corpo.innerHTML = baseFiltrada.map(item => `
                <tr class="hover:bg-blue-50/50 transition duration-150 group">
                    <td class="p-4 w-20">
                        <span class="bg-blue-100 text-blue-700 font-bold px-3 py-1 rounded text-sm border border-blue-200">${item.uf || 'BR'}</span>
                    </td>
                    <td class="p-4 max-w-xs">
                        <div class="font-bold text-slate-800 text-sm truncate uppercase" title="${item.orgao}">${item.orgao}</div>
                        <div class="text-[10px] text-gray-400 font-mono mt-1">ID: ${item.numero}</div>
                    </td>
                    <td class="p-4">
                        <p class="text-sm text-gray-600 line-clamp-2 leading-relaxed" title="${item.objeto}">${item.objeto}</p>
                    </td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-2">
                            <a href="${item.link}" target="_blank" class="bg-white border border-blue-600 text-blue-600 hover:bg-blue-600 hover:text-white p-2.5 rounded-lg transition shadow-sm" title="Abrir no PNCP">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <button onclick="excluirItem('${item.numero}')" class="text-gray-300 hover:text-red-500 p-2.5 transition" title="Descartar">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            contador.innerText = `${baseFiltrada.length} oportunidades encontradas`;
        }

        function abrirModalManual() {
            const url = prompt("Cole o Link do Edital no PNCP:");
            if (url && url.includes("pncp.gov.br")) {
                const novo = {
                    uf: "MA", // Marcador de Manual
                    orgao: "ADICIONADO MANUALMENTE",
                    numero: "EXTERN-" + Math.floor(Math.random() * 1000),
                    objeto: "Edital adicionado via link manual. Verifique os detalhes no portal oficial.",
                    link: url,
                    data: new Date().toISOString()
                };
                baseCompleta.unshift(novo);
                aplicarFiltros();
                alert("Licitação incluída na lista atual!");
            } else if (url) {
                alert("Erro: O link deve ser do portal pncp.gov.br");
            }
        }

        function excluirItem(numero) {
            if(confirm("Deseja remover este item da visualização?")) {
                baseCompleta = baseCompleta.filter(i => i.numero !== numero);
                aplicarFiltros();
            }
        }

        inicializar();
    </script>
</body>
</html>
