<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Sniper PNCP - Painel Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; font-size: 0.85rem; }
        .table-head { background-color: #0d6efd; color: white; text-transform: uppercase; font-size: 0.75rem; }
        .col-money { text-align: right; font-family: 'Consolas', monospace; }
        .text-estimado { text-decoration: line-through; color: #999; font-size: 0.8em; margin-right: 5px; }
        .group-winner { background-color: #d1e7dd; color: #0f5132; font-weight: bold; border-top: 2px solid #198754; }
        .group-loser { background-color: #fff3cd; color: #664d03; font-weight: bold; border-top: 2px solid #ffc107; }
        .paginacao { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .filters input { margin-bottom: 5px; }
        .date-col { font-size: 0.8rem; line-height: 1.2; }
    </style>
</head>
<body>

<div class="container-fluid py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="text-primary fw-bold"><i class="fas fa-crosshairs"></i> Sniper PNCP</h4>
        <div><span class="badge bg-dark">Total: <span id="total_count">0</span></span></div>
    </div>

    <div class="card mb-3 border-0 shadow-sm">
        <div class="card-body p-2 filters">
            <div class="row g-2">
                <div class="col-md-2"><input type="text" id="filtroUf" class="form-control form-control-sm" placeholder="UF" onkeyup="aplicarFiltros()"></div>
                <div class="col-md-3"><input type="text" id="filtroOrgao" class="form-control form-control-sm" placeholder="Órgão / UASG" onkeyup="aplicarFiltros()"></div>
                <div class="col-md-5"><input type="text" id="filtroObjeto" class="form-control form-control-sm" placeholder="Objeto (ex: Soro)" onkeyup="aplicarFiltros()"></div>
                <div class="col-md-2"><button class="btn btn-sm btn-secondary w-100" onclick="limparFiltros()">Limpar</button></div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 overflow-hidden">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-head">
                <tr>
                    <th>Datas (Pub / Fim)</th>
                    <th>UF</th>
                    <th>Órgão / UASG</th>
                    <th>Edital</th>
                    <th style="width: 30%">Objeto</th>
                    <th>Valor Global</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="paginacao">
        <button id="btnAnt" class="btn btn-sm btn-outline-primary" onclick="mudarPagina(-1)">Anterior</button>
        <div class="d-flex align-items-center gap-2">
            <span>Pág</span>
            <input type="number" id="inputPagina" class="form-control form-control-sm text-center" style="width: 50px;" onchange="irParaPagina()">
            <span id="infoPag"></span>
        </div>
        <button id="btnProx" class="btn btn-sm btn-outline-primary" onclick="mudarPagina(1)">Próximo</button>
    </div>
</div>

<div class="modal fade" id="modalItens" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h6 class="modal-title">Detalhamento por Fornecedor</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive" style="max-height: 70vh;">
                    <table class="table table-bordered table-sm mb-0">
                        <thead class="table-light sticky-top" style="top:0">
                            <tr>
                                <th>Item</th>
                                <th>Descrição</th>
                                <th class="text-center">Qtd</th>
                                <th class="text-end">Unit. (Est / Final)</th>
                                <th class="text-end">Total Final</th>
                            </tr>
                        </thead>
                        <tbody id="itensBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="dados/oportunidades.js"></script>
<script>
    const POR_PAGINA = 15;
    let pag = 1;
    let dadosView = [];
    const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmt4 = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 4 });

    function init() {
        if(typeof dadosLicitacoes !== 'undefined') {
            dadosView = [...dadosLicitacoes];
            render();
        }
    }

    function render() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const slice = dadosView.slice((pag-1)*POR_PAGINA, pag*POR_PAGINA);
        const totalPags = Math.ceil(dadosView.length/POR_PAGINA) || 1;
        
        slice.forEach(d => {
            // FORMATAÇÃO CORRIGIDA DE DATAS
            const dPub = d.data_pub ? new Date(d.data_pub).toLocaleDateString() : 'N/A';
            
            let dFim = '-';
            let badge = 'bg-secondary';
            
            if (d.data_fim_prop) {
                const dataFim = new Date(d.data_fim_prop);
                dFim = dataFim.toLocaleString().slice(0,16); // Formato DD/MM/YYYY HH:MM
                // Se a data final for maior que agora, está aberto (Verde), senão Fechado (Cinza)
                badge = (dataFim > new Date()) ? 'bg-success' : 'bg-secondary';
            }

            tbody.innerHTML += `
                <tr>
                    <td class="date-col">
                        <div class="text-muted small">Pub: ${dPub}</div>
                        <span class="badge ${badge}">Fim: ${dFim}</span>
                    </td>
                    <td><b>${d.uf}</b></td>
                    <td><div class="text-truncate" style="max-width:220px" title="${d.orgao}">${d.orgao}</div><small class="text-muted">${d.uasg}</small></td>
                    <td>${d.numero}<br><span class="badge bg-light text-dark border">${d.quantidade_itens} itens</span></td>
                    <td><div class="text-truncate" style="max-width:250px">${d.objeto}</div></td>
                    <td class="fw-bold text-primary">${fmt.format(d.valor_total)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary" onclick="abrirDetalhes('${d.id}')">Itens</button>
                        <a href="${d.link_pncp}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="fas fa-external-link-alt"></i></a>
                    </td>
                </tr>`;
        });
        
        document.getElementById('total_count').innerText = dadosView.length;
        document.getElementById('infoPag').innerText = `de ${totalPags}`;
        document.getElementById('inputPagina').value = pag;
        document.getElementById('inputPagina').max = totalPags;
        document.getElementById('btnAnt').disabled = pag === 1;
        document.getElementById('btnProx').disabled = pag >= totalPags;
    }

    window.abrirDetalhes = function(id) {
        const item = dadosLicitacoes.find(x => x.id === id);
        if(!item || !item.itens_processados || item.itens_processados.length === 0) {
            return alert("Itens ainda sendo processados pelo robô. Aguarde a próxima atualização.");
        }
        
        const tbody = document.getElementById('itensBody');
        tbody.innerHTML = '';
        const modal = new bootstrap.Modal(document.getElementById('modalItens'));
        
        // Agrupar
        const grupos = {};
        item.itens_processados.forEach(i => {
            const chave = i.tem_vencedor ? i.fornecedor : "Sem Vencedor";
            if(!grupos[chave]) grupos[chave] = [];
            grupos[chave].push(i);
        });

        // 1. Renderizar Vencedores
        Object.keys(grupos).sort().forEach(chave => {
            if(chave === "Sem Vencedor") return;
            tbody.innerHTML += `<tr class="group-winner"><td colspan="5"><i class="fas fa-trophy"></i> ${chave}</td></tr>`;
            grupos[chave].forEach(i => renderLinhaItem(tbody, i));
        });

        // 2. Renderizar Sem Vencedor
        if(grupos["Sem Vencedor"]) {
            tbody.innerHTML += `<tr class="group-loser"><td colspan="5"><i class="fas fa-exclamation-triangle"></i> Sem Vencedor / Aberto / Fracassado</td></tr>`;
            grupos["Sem Vencedor"].forEach(i => renderLinhaItem(tbody, i));
        }

        modal.show();
    };

    function renderLinhaItem(tbody, i) {
        const preco = i.tem_vencedor 
            ? `<span class="text-estimado">${fmt4.format(i.val_est_unit)}</span> <b>${fmt4.format(i.val_final_unit)}</b>`
            : fmt4.format(i.val_est_unit);
        
        const total = i.tem_vencedor ? fmt.format(i.val_final_total) : '-';
        const situacao = i.tem_vencedor ? "Homologado" : (i.situacao || "Aberto");

        tbody.innerHTML += `
            <tr>
                <td class="text-center">${i.item}</td>
                <td>${i.descricao} <br> <small class="text-muted">${situacao}</small></td>
                <td class="text-center">${i.qtd}</td>
                <td class="col-money">${preco}</td>
                <td class="col-money fw-bold">${total}</td>
            </tr>`;
    }

    // Filtros
    function aplicarFiltros() {
        const u = document.getElementById('filtroUf').value.toUpperCase();
        const o = document.getElementById('filtroOrgao').value.toUpperCase();
        const b = document.getElementById('filtroObjeto').value.toUpperCase();
        dadosView = dadosLicitacoes.filter(x => 
            (x.uf||'').includes(u) && 
            ((x.orgao||'').toUpperCase().includes(o) || (x.uasg||'').includes(o)) && 
            (x.objeto||'').toUpperCase().includes(b)
        );
        pag = 1; render();
    }
    
    window.limparFiltros = function() {
        document.querySelectorAll('.filters input').forEach(i => i.value='');
        dadosView = [...dadosLicitacoes]; pag=1; render();
    }
    
    window.mudarPagina = function(d) { pag += d; render(); }
    window.irParaPagina = function() {
        const p = parseInt(document.getElementById('inputPagina').value);
        const max = Math.ceil(dadosView.length/POR_PAGINA);
        if(p>=1 && p<=max) { pag = p; render(); }
    }

    window.onload = init;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
