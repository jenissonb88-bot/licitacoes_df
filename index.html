<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pharma - Monitor V6</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-dark: #2c3e50; --accent-blue: #3498db; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; font-size: 0.85rem; }
        
        /* Header e Tabela */
        .header-bar { background: var(--primary-dark); color: white; padding: 12px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-table { border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .table-pncp thead { background-color: #34495e; color: white; text-transform: uppercase; font-size: 0.75rem; }
        .table-pncp td { vertical-align: middle; padding: 10px; border-bottom: 1px solid #eee; }

        /* Dados Principais */
        .uasg-orgao { font-weight: 700; color: #2c3e50; font-size: 0.9rem; }
        .unidade-comp { color: #555; font-size: 0.8rem; display: block; margin-top: 2px; }
        .local-uf { color: #7f8c8d; font-size: 0.8rem; display: block; font-style: italic; }

        /* Badges de Tipo de Licitação */
        .badge-tipo { font-size: 0.7rem; font-weight: 700; padding: 4px 8px; border-radius: 4px; display: inline-block; width: 100%; text-align: center; }
        .tipo-amplo { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; } /* Verde */
        .tipo-exclusivo { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; } /* Vermelho */
        .tipo-parcial { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; } /* Amarelo */

        /* Modal e Grupos */
        .group-header { padding: 8px 15px; font-weight: 700; color: white; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .bg-fornecedor { background-color: #2c3e50; } /* Azul Escuro para fornecedor */
        .bg-andamento { background-color: #198754; } /* Verde para em andamento */
        .bg-fracassado { background-color: #dc3545; } /* Vermelho para fracassado/cancelado */
        
        .table-itens th { background: #f8f9fa; font-size: 0.75rem; }
        .me-epp-sim { color: #dc3545; font-weight: 800; } /* Vermelho Negrito */
        .me-epp-nao { color: #ccc; }
    </style>
</head>
<body>

<div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-white d-flex flex-column align-items-center justify-content-center" style="z-index:9999; opacity:0.9;">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2 text-muted fw-bold">Carregando dados...</div>
</div>

<div class="header-bar d-flex justify-content-between align-items-center sticky-top">
    <div class="fw-bold fs-5"><i class="fas fa-crosshairs me-2"></i>SNIPER PHARMA V6</div>
    <button class="btn btn-sm btn-outline-light" onclick="location.reload()"><i class="fas fa-sync-alt"></i></button>
</div>

<div class="container-fluid py-3">
    <div class="card card-table p-3 mb-3">
        <div class="row g-2">
            <div class="col-md-2"><input id="fUf" class="form-control form-control-sm" placeholder="UF" onkeyup="render()"></div>
            <div class="col-md-4"><input id="fOrgao" class="form-control form-control-sm" placeholder="Cidade ou Órgão" onkeyup="render()"></div>
            <div class="col-md-4"><input id="fObjeto" class="form-control form-control-sm" placeholder="Palavra no Objeto" onkeyup="render()"></div>
            <div class="col-md-2">
                <select id="fTipo" class="form-select form-select-sm" onchange="render()">
                    <option value="">Todos os Tipos</option>
                    <option value="AMPLO">Amplo (Verde)</option>
                    <option value="EXCLUSIVO">Exclusivo ME/EPP (Vermelho)</option>
                    <option value="PARCIAL">Parcial (Amarelo)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card card-table">
        <div class="table-responsive">
            <table class="table table-hover table-pncp mb-0">
                <thead>
                    <tr>
                        <th style="width: 100px;">Data Fim</th>
                        <th style="width: 80px;" class="text-center">Tipo</th>
                        <th>Órgão / Unidade / Local</th>
                        <th style="width: 100px;">Edital</th>
                        <th>Objeto</th>
                        <th class="text-end" style="width: 120px;">Valor Est.</th>
                        <th class="text-center" style="width: 80px;">Ação</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div class="p-3 d-flex justify-content-between align-items-center border-top">
            <button class="btn btn-sm btn-secondary" onclick="mudarPagina(-1)" id="btnAnt">Anterior</button>
            <span class="text-muted small">Página <span id="pagAtual">1</span> de <span id="pagTotal">1</span></span>
            <button class="btn btn-sm btn-secondary" onclick="mudarPagina(1)" id="btnProx">Próximo</button>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2 bg-dark text-white">
                <h6 class="modal-title">Detalhamento do Processo</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div id="modalBody" class="modal-body bg-light"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

<script>
    const FILE_URL = 'pregacoes_pharma_limpos.json.gz';
    let dadosOriginais = [], dadosFiltrados = [];
    let pagina = 1;
    const ITENS_POR_PAG = 20;
    
    const fmtBrl = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmtData = d => d ? new Date(d).toLocaleDateString('pt-BR') : '--';

    window.onload = async () => {
        try {
            const res = await fetch(`${FILE_URL}?t=${Date.now()}`);
            if(!res.ok) throw new Error("Erro ao baixar dados");
            const blob = await res.blob();
            let text;
            try { text = pako.ungzip(new Uint8Array(await blob.arrayBuffer()), {to:'string'}); }
            catch { text = await blob.text(); } // Fallback
            
            dadosOriginais = JSON.parse(text);
            
            // Ordena por data (urgentes primeiro)
            dadosOriginais.sort((a,b) => (a.data_enc > b.data_enc) ? 1 : -1);
            
            render();
            document.getElementById('loading-overlay').style.display = 'none';
        } catch (e) {
            document.getElementById('loading-overlay').innerHTML = `<div class="text-danger fw-bold">Erro: ${e.message}</div>`;
        }
    };

    function render() {
        const uf = document.getElementById('fUf').value.toUpperCase();
        const org = document.getElementById('fOrgao').value.toUpperCase();
        const obj = document.getElementById('fObjeto').value.toUpperCase();
        const tipo = document.getElementById('fTipo').value;

        dadosFiltrados = dadosOriginais.filter(d => {
            const fullLocal = (d.cidade + ' ' + d.orgao).toUpperCase();
            return (d.uf.includes(uf) && 
                    fullLocal.includes(org) && 
                    d.objeto.toUpperCase().includes(obj) &&
                    (tipo === "" || d.tipo_licitacao === tipo));
        });

        const totalPaginas = Math.ceil(dadosFiltrados.length / ITENS_POR_PAG) || 1;
        if(pagina > totalPaginas) pagina = totalPaginas;
        if(pagina < 1) pagina = 1;

        const inicio = (pagina - 1) * ITENS_POR_PAG;
        const lote = dadosFiltrados.slice(inicio, inicio + ITENS_POR_PAG);
        
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        lote.forEach(d => {
            // Estilo da Data
            const diasRestantes = (new Date(d.data_enc) - new Date()) / (1000 * 60 * 60 * 24);
            let corData = diasRestantes < 0 ? 'text-decoration-line-through text-muted' : (diasRestantes < 2 ? 'text-danger fw-bold' : '');

            // Estilo da Tarja (Tipo)
            let classeTipo = 'tipo-amplo';
            if(d.tipo_licitacao === 'EXCLUSIVO') classeTipo = 'tipo-exclusivo';
            if(d.tipo_licitacao === 'PARCIAL') classeTipo = 'tipo-parcial';

            tbody.innerHTML += `
                <tr>
                    <td class="${corData}">${fmtData(d.data_enc)}</td>
                    <td class="text-center"><span class="badge-tipo ${classeTipo}">${d.tipo_licitacao}</span></td>
                    <td>
                        <div class="uasg-orgao">UASG ${d.uasg || '---'} - ${d.orgao}</div>
                        <div class="unidade-comp">${d.unidade}</div>
                        <div class="local-uf">${d.cidade} - ${d.uf}</div>
                    </td>
                    <td>${d.edital}</td>
                    <td><div class="text-truncate" style="max-width:350px" title="${d.objeto}">${d.objeto}</div></td>
                    <td class="text-end fw-bold text-success">${fmtBrl.format(d.valor_estimado)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes('${d.id}')"><i class="fas fa-list"></i></button>
                        <a href="${d.link}" target="_blank" class="btn btn-sm btn-outline-dark"><i class="fas fa-external-link-alt"></i></a>
                    </td>
                </tr>
            `;
        });

        document.getElementById('pagAtual').innerText = pagina;
        document.getElementById('pagTotal').innerText = totalPaginas;
        document.getElementById('btnAnt').disabled = pagina === 1;
        document.getElementById('btnProx').disabled = pagina === totalPaginas;
    }

    function mudarPagina(d) { pagina += d; render(); document.querySelector('.card-table').scrollIntoView(); }

    // --- FUNÇÃO DE DETALHES COM AGRUPAMENTO ---
    function verDetalhes(id) {
        const lic = dadosOriginais.find(d => d.id === id);
        if(!lic) return;

        const itens = lic.itens || [];
        
        // 1. Agrupar Itens
        const grupos = {
            'EM_ANDAMENTO': [],
            'HOMOLOGADO': {}, // Será um objeto { 'Nome Fornecedor': [itens] }
            'OUTROS': [] // Cancelados, Desertos, Fracassados
        };

        itens.forEach(it => {
            if (it.situacao === 'HOMOLOGADO') {
                const forn = it.fornecedor || 'Fornecedor Não Identificado';
                if (!grupos.HOMOLOGADO[forn]) grupos.HOMOLOGADO[forn] = [];
                grupos.HOMOLOGADO[forn].push(it);
            } else if (it.situacao === 'EM_ANDAMENTO') {
                grupos.EM_ANDAMENTO.push(it);
            } else {
                grupos.OUTROS.push(it); // Cancelado, Deserto...
            }
        });

        let html = `
            <div class="alert alert-light border shadow-sm">
                <strong>${lic.orgao}</strong><br>
                <small>${lic.cidade}/${lic.uf} - Edital: ${lic.edital}</small>
                <div class="mt-2 text-muted small">${lic.objeto}</div>
            </div>
        `;

        // Função auxiliar para gerar tabela
        const gerarTabela = (listaItens, mostrarValHomologado = false) => {
            let trs = '';
            listaItens.forEach(it => {
                const txtMeEpp = it.me_epp ? '<span class="me-epp-sim">SIM</span>' : '<span class="me-epp-nao">NÃO</span>';
                const valShow = mostrarValHomologado ? it.valHomologado : it.valUnit;
                const total = it.qtd * valShow;
                
                let descSit = '';
                if(it.situacao === 'CANCELADO') descSit = '<span class="badge bg-danger">CANCELADO</span>';
                if(it.situacao === 'DESERTO') descSit = '<span class="badge bg-warning text-dark">DESERTO</span>';

                trs += `
                    <tr>
                        <td class="text-center">${it.n}</td>
                        <td class="text-center">${txtMeEpp}</td>
                        <td>${it.desc} ${descSit}</td>
                        <td class="text-center">${it.qtd}</td>
                        <td class="text-center">${it.un}</td>
                        <td class="text-end">${fmtBrl.format(valShow)}</td>
                        <td class="text-end fw-bold">${fmtBrl.format(total)}</td>
                    </tr>
                `;
            });
            return `
                <div class="table-responsive mb-3">
                    <table class="table table-sm table-bordered table-itens mb-0">
                        <thead>
                            <tr>
                                <th style="width:50px">Item</th>
                                <th style="width:50px">ME/EPP</th>
                                <th>Descrição</th>
                                <th style="width:70px">Qtd</th>
                                <th style="width:60px">Un</th>
                                <th style="width:110px">${mostrarValHomologado ? 'Val. Final' : 'Val. Est.'}</th>
                                <th style="width:110px">Total</th>
                            </tr>
                        </thead>
                        <tbody>${trs}</tbody>
                    </table>
                </div>
            `;
        };

        // Renderiza Grupo: HOMOLOGADOS (Por fornecedor)
        if (Object.keys(grupos.HOMOLOGADO).length > 0) {
            html += `<h6 class="mt-4 border-bottom pb-2">✅ Itens Homologados / Adjudicados</h6>`;
            for (const [fornecedor, lista] of Object.entries(grupos.HOMOLOGADO)) {
                html += `
                    <div class="card mb-3 shadow-sm" style="border:1px solid #2c3e50;">
                        <div class="group-header bg-fornecedor">
                            <span><i class="fas fa-truck me-2"></i> ${fornecedor}</span>
                            <span class="badge bg-white text-dark">${lista.length} itens</span>
                        </div>
                        <div class="card-body p-0">
                            ${gerarTabela(lista, true)}
                        </div>
                    </div>
                `;
            }
        }

        // Renderiza Grupo: EM ANDAMENTO
        if (grupos.EM_ANDAMENTO.length > 0) {
            html += `
                <div class="card mb-3 border-success shadow-sm mt-4">
                    <div class="group-header bg-andamento">
                        <span><i class="fas fa-clock me-2"></i> Em Andamento / Aberto</span>
                        <span class="badge bg-white text-dark">${grupos.EM_ANDAMENTO.length} itens</span>
                    </div>
                    <div class="card-body p-0">
                        ${gerarTabela(grupos.EM_ANDAMENTO, false)}
                    </div>
                </div>
            `;
        }

        // Renderiza Grupo: FRACASSADOS / DESERTOS / CANCELADOS
        if (grupos.OUTROS.length > 0) {
            html += `
                <div class="card mb-3 border-danger shadow-sm mt-4">
                    <div class="group-header bg-fracassado">
                        <span><i class="fas fa-times-circle me-2"></i> Fracassados, Desertos ou Cancelados</span>
                        <span class="badge bg-white text-dark">${grupos.OUTROS.length} itens</span>
                    </div>
                    <div class="card-body p-0">
                        ${gerarTabela(grupos.OUTROS, false)}
                    </div>
                </div>
            `;
        }

        document.getElementById('modalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
    }
</script>
</body>
</html>
