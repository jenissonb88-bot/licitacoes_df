<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Sniper PNCP - Painel de Controle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #3498db; }
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Roboto, sans-serif; font-size: 0.9rem; }
        
        /* Cards e Containers */
        .main-container { max-width: 98%; margin: 20px auto; }
        .card-custom { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 8px; background: white; }
        
        /* Cabeçalho */
        .header-bar { background: white; padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .app-title { font-weight: 700; color: var(--primary-color); font-size: 1.2rem; }
        
        /* Tabela Principal */
        .table-main thead { background-color: var(--primary-color); color: white; }
        .table-main th { font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; border: none; padding: 12px; }
        .table-main td { vertical-align: middle; border-bottom: 1px solid #f0f0f0; padding: 10px; }
        .table-hover tbody tr:hover { background-color: #f8f9fa; transition: 0.2s; }
        
        /* Detalhes (Modal) */
        .modal-header { background-color: var(--primary-color); color: white; }
        .group-container { border: 1px solid #e0e0e0; border-radius: 6px; margin-bottom: 15px; overflow: hidden; }
        .group-header { padding: 10px 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        
        /* Cores de Status dos Grupos */
        .status-winner { background-color: #d1e7dd; color: #0f5132; border-left: 4px solid #198754; } /* Verde */
        .status-pending { background-color: #fff3cd; color: #664d03; border-left: 4px solid #ffc107; } /* Amarelo */
        .status-loser { background-color: #f8d7da; color: #842029; border-left: 4px solid #dc3545; }   /* Vermelho (se houver) */

        /* Utilitários */
        .money { font-family: 'Consolas', monospace; text-align: right; white-space: nowrap; }
        .badge-date { font-size: 0.75rem; }
        .text-xs { font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="header-bar sticky-top">
    <div class="d-flex align-items-center gap-3">
        <div class="app-title"><i class="fas fa-crosshairs text-danger"></i> Sniper PNCP</div>
        <span class="badge bg-secondary rounded-pill" id="badgeTotal">0 Licitações</span>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-success" onclick="abrirModalManual()"><i class="fas fa-plus"></i> Add Manual</button>
        <button class="btn btn-sm btn-primary" onclick="location.reload()"><i class="fas fa-sync-alt"></i> Atualizar</button>
    </div>
</div>

<div class="main-container">
    
    <div class="card-custom p-3 mb-3">
        <div class="row g-2">
            <div class="col-md-2">
                <input type="text" id="fUf" class="form-control form-control-sm" placeholder="UF (ex: SP)" onkeyup="filtrar()">
            </div>
            <div class="col-md-3">
                <input type="text" id="fOrgao" class="form-control form-control-sm" placeholder="Órgão / Cidade" onkeyup="filtrar()">
            </div>
            <div class="col-md-5">
                <input type="text" id="fObjeto" class="form-control form-control-sm" placeholder="Objeto (ex: Seringa)" onkeyup="filtrar()">
            </div>
            <div class="col-md-2">
                <button class="btn btn-secondary btn-sm w-100" onclick="limparFiltros()">Limpar</button>
            </div>
        </div>
    </div>

    <div class="card-custom overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover table-main mb-0">
                <thead>
                    <tr>
                        <th>Datas (Pub / Fim)</th>
                        <th>UF</th>
                        <th>Órgão / Unidade</th>
                        <th>Objeto</th>
                        <th class="text-center">Itens</th>
                        <th class="text-end">Valor Global</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="tbDados"></tbody>
            </table>
        </div>
        
        <div class="d-flex justify-content-center align-items-center p-3 gap-2 bg-light border-top">
            <button class="btn btn-sm btn-outline-secondary" onclick="mudarPag(-1)" id="btnAnt">Anterior</button>
            <span class="small text-muted">Página <span id="spanPag" class="fw-bold">1</span> de <span id="spanTotalPag">1</span></span>
            <button class="btn btn-sm btn-outline-secondary" onclick="mudarPag(1)" id="btnProx">Próximo</button>
        </div>
    </div>
</div>

<div class="modal fade" id="mdlDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title fs-6"><i class="fas fa-list"></i> Detalhes dos Itens</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" id="mdlBody"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="mdlManual" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title">Adicionar por Link</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">Cole o link completo do edital no PNCP.</p>
                <input type="text" id="inpUrl" class="form-control mb-2" placeholder="https://pncp.gov.br/app/editais/...">
                <div id="statusManual" class="small"></div>
            </div>
            <div class="modal-footer py-1">
                <button class="btn btn-primary btn-sm" onclick="processarManual()">Adicionar</button>
            </div>
        </div>
    </div>
</div>

<script src="dados/oportunidades.js"></script>

<script>
    // --- Config ---
    const ITENS_PAG = 20;
    let pagAtual = 1;
    let dadosTodos = [];
    let dadosView = [];
    
    const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmtData = d => d ? new Date(d).toLocaleDateString('pt-BR') : '--/--';

    // --- Init ---
    window.onload = () => {
        // Carrega do arquivo JS + LocalStorage (para exclusões/manuais)
        const base = (typeof dadosLicitacoes !== 'undefined') ? dadosLicitacoes : [];
        const excluidos = JSON.parse(localStorage.getItem('sniper_excluidos') || '[]');
        const manuais = JSON.parse(localStorage.getItem('sniper_manuais') || '[]');
        
        // Merge dados manuais com base, removendo duplicados por ID
        const mapa = new Map();
        base.forEach(d => mapa.set(d.id, d));
        manuais.forEach(d => mapa.set(d.id, d));
        
        // Filtra excluídos e ordena por data fim (mais urgente primeiro)
        dadosTodos = Array.from(mapa.values())
            .filter(d => !excluidos.includes(d.id))
            .sort((a,b) => (b.data_encerramento_proposta || '').localeCompare(a.data_encerramento_proposta || ''));
            
        dadosView = [...dadosTodos];
        render();
    };

    // --- Render Tabela ---
    function render() {
        const tb = document.getElementById('tbDados');
        tb.innerHTML = '';
        
        const totalPags = Math.ceil(dadosView.length / ITENS_PAG) || 1;
        if (pagAtual > totalPags) pagAtual = totalPags;
        if (pagAtual < 1) pagAtual = 1;

        const inicio = (pagAtual - 1) * ITENS_PAG;
        const fim = inicio + ITENS_PAG;
        const lote = dadosView.slice(inicio, fim);

        lote.forEach(d => {
            // Lógica de Data e Status
            const hoje = new Date().toISOString().split('T')[0];
            const fimRaw = d.data_encerramento_proposta ? d.data_encerramento_proposta.split('T')[0] : '9999-12-31';
            const corData = fimRaw >= hoje ? 'text-success' : 'text-danger';
            
            // Valor: Se sigiloso ou 0, mostra aviso
            const val = (d.is_sigiloso || d.valor_total_estimado == 0) 
                ? '<span class="text-muted small"><i class="fas fa-lock"></i> Sigiloso/R$0</span>' 
                : fmtBRL.format(d.valor_total_estimado);

            tb.innerHTML += `
                <tr>
                    <td>
                        <div class="text-muted text-xs">Pub: ${fmtData(d.data_pub)}</div>
                        <div class="${corData} fw-bold text-xs">Fim: ${fmtData(d.data_encerramento_proposta)}</div>
                    </td>
                    <td><b>${d.uf}</b></td>
                    <td>
                        <div class="fw-bold text-truncate" style="max-width:200px" title="${d.orgao}">${d.orgao}</div>
                        <div class="text-muted text-xs text-truncate" style="max-width:200px">${d.unidade} - ${d.cidade}</div>
                    </td>
                    <td><div class="text-truncate" style="max-width:250px" title="${d.objeto}">${d.objeto}</div></td>
                    <td class="text-center"><span class="badge bg-light text-dark border">${d.qtd_total_itens}</span></td>
                    <td class="text-end fw-bold text-primary">${val}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary border-0" onclick="detalhes('${d.id}')" title="Ver Itens"><i class="fas fa-eye"></i></button>
                        <a href="${d.link_pncp}" target="_blank" class="btn btn-sm btn-outline-secondary border-0"><i class="fas fa-external-link-alt"></i></a>
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="excluir('${d.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });

        // Atualiza Labels
        document.getElementById('badgeTotal').innerText = `${dadosView.length} Licitações`;
        document.getElementById('spanPag').innerText = pagAtual;
        document.getElementById('spanTotalPag').innerText = totalPags;
        document.getElementById('btnAnt').disabled = pagAtual === 1;
        document.getElementById('btnProx').disabled = pagAtual >= totalPags;
    }

    // --- Modal Detalhes (Cascata) ---
    function detalhes(id) {
        const item = dadosTodos.find(d => d.id === id);
        if(!item) return;

        const corpo = document.getElementById('mdlBody');
        corpo.innerHTML = '';
        
        // Agrupamento
        const grupos = {};
        item.itens.forEach(i => {
            // Chave de agrupamento: Fornecedor
            let chave = i.fornecedor || 'SEM INFORMAÇÃO';
            if (!grupos[chave]) grupos[chave] = [];
            grupos[chave].push(i);
        });

        // Ordenação: Itens "EM ANDAMENTO" primeiro, depois vencedores
        const chavesOrdenadas = Object.keys(grupos).sort((a, b) => {
            if (a.includes('EM ANDAMENTO')) return -1;
            if (b.includes('EM ANDAMENTO')) return 1;
            return a.localeCompare(b);
        });

        chavesOrdenadas.forEach(chave => {
            const lista = grupos[chave];
            // Estilização baseada no status
            const isPendente = chave.includes('EM ANDAMENTO') || chave.includes('SEM RESULTADO');
            const classeHeader = isPendente ? 'status-pending' : 'status-winner';
            const icone = isPendente ? 'fa-clock' : 'fa-trophy';
            const rotuloValor = isPendente ? 'Estimado' : 'Homologado';

            let html = `
                <div class="group-container">
                    <div class="group-header ${classeHeader}">
                        <span><i class="fas ${icone} me-2"></i> ${chave}</span>
                        <span class="badge bg-white text-dark border">${lista.length} Itens</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:50px">Item</th>
                                    <th>Descrição</th>
                                    <th class="text-center" style="width:60px">Qtd</th>
                                    <th class="money">Unit. (${rotuloValor})</th>
                                    <th class="money">Total (${rotuloValor})</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            lista.forEach(i => {
                html += `
                    <tr>
                        <td class="text-center fw-bold">${i.item}</td>
                        <td>${i.desc}</td>
                        <td class="text-center">${i.qtd}</td>
                        <td class="money">${fmtBRL.format(i.unitario)}</td>
                        <td class="money fw-bold">${fmtBRL.format(i.total)}</td>
                    </tr>
                `;
            });

            html += `</tbody></table></div></div>`;
            corpo.innerHTML += html;
        });

        new bootstrap.Modal(document.getElementById('mdlDetalhes')).show();
    }

    // --- Filtros ---
    function filtrar() {
        const u = document.getElementById('fUf').value.toUpperCase();
        const o = document.getElementById('fOrgao').value.toUpperCase();
        const b = document.getElementById('fObjeto').value.toUpperCase();

        dadosView = dadosTodos.filter(d => 
            (d.uf||'').includes(u) &&
            ((d.orgao||'').toUpperCase().includes(o) || (d.cidade||'').toUpperCase().includes(o)) &&
            (d.objeto||'').toUpperCase().includes(b)
        );
        pagAtual = 1; render();
    }

    function limparFiltros() {
        document.querySelectorAll('input').forEach(i => i.value = '');
        dadosView = [...dadosTodos];
        pagAtual = 1; render();
    }

    function mudarPag(d) { pagAtual += d; render(); }

    // --- Ações ---
    function excluir(id) {
        if(!confirm('Ocultar esta licitação da lista?')) return;
        const excluidos = JSON.parse(localStorage.getItem('sniper_excluidos') || '[]');
        excluidos.push(id);
        localStorage.setItem('sniper_excluidos', JSON.stringify(excluidos));
        window.onload(); // Recarrega
    }

    // --- Adição Manual (Simulação Client-Side) ---
    function abrirModalManual() { new bootstrap.Modal(document.getElementById('mdlManual')).show(); }

    async function processarManual() {
        const url = document.getElementById('inpUrl').value;
        const divSts = document.getElementById('statusManual');
        divSts.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando dados...';

        const match = url.match(/editais\/(\d+)\/(\d+)\/(\d+)/);
        if(!match) { divSts.innerHTML = '<span class="text-danger">Link inválido.</span>'; return; }

        const [_, cnpj, ano, seq] = match;
        const apiUrl = `https://pncp.gov.br/api/consulta/v1/contratacoes/publicacao/${cnpj}/${ano}/${seq}`;

        try {
            // Busca Cabeçalho
            const r1 = await fetch(apiUrl);
            if(!r1.ok) throw new Error('Licitação não encontrada.');
            const d = await r1.json();
            
            // Busca Itens (Simplificado para JS)
            const r2 = await fetch(`${apiUrl}/itens?pagina=1&tamanhoPagina=50`);
            const itensRaw = r2.ok ? await r2.json() : [];

            // Monta Objeto compatível com o Python
            const novo = {
                id: `${cnpj}${ano}${seq}`,
                uf: d.unidadeOrgao?.ufSigla || 'BR',
                cidade: d.unidadeOrgao?.municipioNome || 'Manual',
                unidade: d.unidadeOrgao?.nomeUnidade || 'Manual',
                orgao: d.orgaoEntidade?.razaoSocial,
                objeto: d.objetoCompra,
                data_pub: d.dataPublicacaoPncp,
                data_encerramento_proposta: d.dataEncerramentoProposta,
                valor_total_estimado: d.valorTotalEstimado,
                is_sigiloso: d.niValorTotalEstimado,
                qtd_total_itens: itensRaw.length,
                link_pncp: url,
                itens: itensRaw.map(i => ({
                    item: i.numeroItem,
                    desc: i.descricao,
                    qtd: i.quantidade,
                    unitario: i.valorUnitarioEstimado,
                    total: i.valorTotalEstimado,
                    fornecedor: "EM ANDAMENTO (MANUAL)",
                    vitoria: false
                }))
            };

            const manuais = JSON.parse(localStorage.getItem('sniper_manuais') || '[]');
            manuais.push(novo);
            localStorage.setItem('sniper_manuais', JSON.stringify(manuais));
            
            divSts.innerHTML = '<span class="text-success">Sucesso! Recarregando...</span>';
            setTimeout(() => location.reload(), 1000);

        } catch (e) {
            divSts.innerHTML = `<span class="text-danger">Erro: ${e.message}</span>`;
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
