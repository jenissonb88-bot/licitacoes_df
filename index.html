<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analista PNCP | Detalhamento Técnico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .sub-table th { font-size: 10px; letter-spacing: 0.05em; }
        .sub-table td { font-size: 11px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-50 border-b-4 border-blue-500">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-file-prescription text-white"></i></div>
                <div>
                    <h1 class="text-lg font-black uppercase tracking-tight">Monitor de Licitações</h1>
                    <p class="text-[10px] text-blue-300 font-bold uppercase tracking-widest">Painel Analítico de Saúde</p>
                </div>
            </div>
            <div class="text-right">
                <span class="text-[10px] font-mono text-slate-400">v3.0 | Filtro: Pregão (6)</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 lg:p-8">
        
        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6 grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
            <div class="md:col-span-2">
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Estado (UF)</label>
                <select id="selUF" onchange="aplicarFiltros()" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Brasil</option>
                </select>
            </div>
            <div class="md:col-span-6">
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Pesquisar no Objeto ou Órgão</label>
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                    <input type="text" id="txtBusca" onkeyup="aplicarFiltros()" placeholder="Ex: Soro, Hospital, AAS, Prefeitura..." class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2.5 pl-8 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div class="md:col-span-4 flex gap-2">
                <button onclick="incluirManual()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg transition shadow-md flex items-center justify-center gap-2 text-xs uppercase tracking-wide">
                    <i class="fas fa-plus"></i> Inclusão Manual
                </button>
                <button onclick="location.reload()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 p-2.5 rounded-lg border border-slate-200 transition" title="Atualizar">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[400px]">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase font-bold text-[10px]">
                    <tr>
                        <th class="p-4 w-16 text-center">UF</th>
                        <th class="p-4">Órgão / Edital</th>
                        <th class="p-4">Objeto da Licitação</th>
                        <th class="p-4 text-right">Valor Global Est.</th>
                        <th class="p-4 text-center w-32">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo" class="text-sm divide-y divide-slate-100 text-slate-700">
                    <tr><td colspan="5" class="p-10 text-center italic text-slate-400">Carregando dados...</td></tr>
                </tbody>
            </table>
            <div class="p-3 bg-slate-50 border-t border-slate-200 flex justify-between items-center">
                <span id="infoTotal" class="text-[10px] font-bold text-slate-400 uppercase">0 Registros</span>
                <div class="flex gap-1" id="paginacaoControle">
                    </div>
            </div>
        </div>
    </main>

    <script>
        let dadosCompletos = [];
        let dadosFiltrados = [];
        let paginaAtual = 1;
        const ITENS_POR_PAGINA = 20;

        // --- INICIALIZAÇÃO ---
        async function init() {
            try {
                const res = await fetch('dados/oportunidades.json');
                if(!res.ok) throw new Error("Arquivo JSON não encontrado");
                dadosCompletos = await res.json();
                
                // Preencher Select UF
                const ufs = [...new Set(dadosCompletos.map(i => i.uf))].filter(Boolean).sort();
                const sel = document.getElementById('selUF');
                ufs.forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);

                aplicarFiltros();
            } catch (e) {
                document.getElementById('tabelaCorpo').innerHTML = 
                    `<tr><td colspan="5" class="p-10 text-center text-red-400">
                        <i class="fas fa-exclamation-triangle mb-2 text-2xl"></i><br>
                        Dados não encontrados. Verifique se o Robô Python rodou corretamente.
                    </td></tr>`;
            }
        }

        // --- FILTROS ---
        function aplicarFiltros() {
            const uf = document.getElementById('selUF').value;
            const termo = document.getElementById('txtBusca').value.toLowerCase();

            dadosFiltrados = dadosCompletos.filter(item => {
                const matchUF = !uf || item.uf === uf;
                const matchBusca = !termo || item.orgao.toLowerCase().includes(termo) || item.objeto.toLowerCase().includes(termo);
                return matchUF && matchBusca;
            });

            paginaAtual = 1;
            renderizarTabela();
        }

        // --- RENDERIZAÇÃO DA TABELA MESTRE ---
        function renderizarTabela() {
            const corpo = document.getElementById('tabelaCorpo');
            const total = document.getElementById('infoTotal');
            
            total.innerText = `${dadosFiltrados.length} Registros Encontrados`;

            if(dadosFiltrados.length === 0) {
                corpo.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-slate-400 italic">Nenhum resultado para o filtro.</td></tr>';
                return;
            }

            const inicio = (paginaAtual - 1) * ITENS_POR_PAGINA;
            const fim = inicio + ITENS_POR_PAGINA;
            const lote = dadosFiltrados.slice(inicio, fim);

            corpo.innerHTML = lote.map(item => `
                <tr class="hover:bg-blue-50/50 transition duration-150 group border-b border-slate-50" id="row-${item.id}">
                    <td class="p-4 text-center align-top">
                        <span class="bg-slate-100 text-slate-600 font-black px-2 py-1 rounded text-[10px] border border-slate-200">${item.uf || 'BR'}</span>
                    </td>
                    <td class="p-4 align-top">
                        <div class="font-bold text-slate-800 text-[11px] uppercase mb-1 leading-tight" title="${item.orgao}">${item.orgao}</div>
                        <div class="flex items-center gap-2 mt-2">
                             <span class="text-[9px] bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded font-bold border border-emerald-200 uppercase">Pregão</span>
                             <span class="text-[9px] text-slate-400 font-mono">SEQ: ${item.numero}</span>
                        </div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-[11px] text-slate-600 line-clamp-3 leading-relaxed" title="${item.objeto}">${item.objeto}</div>
                    </td>
                    <td class="p-4 text-right align-top font-mono text-xs font-bold text-slate-700">
                        ${formatarMoeda(item.valor_total)}
                    </td>
                    <td class="p-4 text-center align-top">
                        <div class="flex justify-center gap-2">
                            <button onclick="toggleDetalhes(this, '${item.id}')" class="btn-detalhes w-8 h-8 flex items-center justify-center bg-white border border-slate-200 text-slate-400 rounded-lg hover:text-blue-600 hover:border-blue-300 shadow-sm transition" title="Ver Itens (Cascata)">
                                <i class="fas fa-list"></i>
                            </button>
                            <a href="${item.link}" target="_blank" class="w-8 h-8 flex items-center justify-center bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm transition" title="Abrir no PNCP">
                                <i class="fas fa-external-link-alt text-xs"></i>
                            </a>
                            <button onclick="excluirItem('${item.numero}')" class="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-500 transition"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');

            atualizarPaginacao();
        }

        // --- LÓGICA DE DETALHAMENTO (CASCATA) ---
        async function toggleDetalhes(btn, idGlobal) {
            const trPai = btn.closest('tr');
            const trDetalheId = `detalhe-${idGlobal}`;
            let trDetalhe = document.getElementById(trDetalheId);

            // Se já existe, fecha e remove
            if (trDetalhe) {
                trDetalhe.remove();
                btn.classList.remove('text-blue-600', 'border-blue-300', 'bg-blue-50');
                btn.innerHTML = '<i class="fas fa-list"></i>';
                return;
            }

            // Abre estado de carregamento
            btn.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-600"></i>';
            btn.classList.add('bg-blue-50');

            try {
                // Endpoint de Itens da API de Consulta
                const url = `https://pncp.gov.br/api/consulta/v1/contratacoes/${idGlobal}/itens`;
                const resp = await fetch(url);
                const json = await res.json();
                const itens = Array.isArray(json) ? json : (json.data || []);

                // Constrói a tabela de itens
                let htmlItens = `
                    <tr id="${trDetalheId}" class="bg-slate-50 border-b border-blue-100 fade-in">
                        <td colspan="5" class="p-4 pl-12 pr-12">
                            <div class="bg-white rounded-lg border border-slate-200 shadow-inner overflow-hidden">
                                <div class="bg-slate-100 px-4 py-2 border-b border-slate-200 flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-slate-500 uppercase">Detalhamento dos Itens (${itens.length})</span>
                                    <span class="text-[9px] text-slate-400 italic">Fonte: PNCP API v1</span>
                                </div>
                                <table class="w-full text-left sub-table">
                                    <thead class="bg-slate-50 text-slate-500 font-bold uppercase">
                                        <tr>
                                            <th class="p-3 w-10 text-center">#</th>
                                            <th class="p-3">Descrição do Material / Medicamento</th>
                                            <th class="p-3 text-right">Qtd</th>
                                            <th class="p-3 text-right">Val. Unit. Est.</th>
                                            <th class="p-3 text-right">Val. Total Est.</th>
                                            <th class="p-3 text-center">Situação</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 text-slate-600">`;

                if(itens.length === 0) {
                    htmlItens += `<tr><td colspan="6" class="p-4 text-center italic text-xs">Nenhum item listado na API.</td></tr>`;
                } else {
                    itens.forEach(it => {
                        const totalEst = (it.quantidade || 0) * (it.valorUnitarioEstimado || 0);
                        htmlItens += `
                            <tr class="hover:bg-blue-50/30">
                                <td class="p-3 text-center font-mono text-[10px] bg-slate-50 text-slate-400">${it.numeroItem}</td>
                                <td class="p-3 font-medium text-slate-800">${it.descricao}</td>
                                <td class="p-3 text-right font-mono">${it.quantidade}</td>
                                <td class="p-3 text-right font-mono text-blue-600">${formatarMoeda(it.valorUnitarioEstimado)}</td>
                                <td class="p-3 text-right font-mono font-bold text-slate-700">${formatarMoeda(totalEst)}</td>
                                <td class="p-3 text-center">
                                    <span class="px-2 py-0.5 rounded-full text-[9px] font-bold uppercase ${getClasseSituacao(it.situacaoItemNome)}">
                                        ${it.situacaoItemNome || 'Aberto'}
                                    </span>
                                </td>
                            </tr>`;
                    });
                }

                htmlItens += `</tbody></table></div></td></tr>`;
                
                // Insere logo após a linha do pai
                trPai.insertAdjacentHTML('afterend', htmlItens);
                
                // Atualiza botão
                btn.innerHTML = '<i class="fas fa-chevron-up"></i>';
                btn.classList.add('text-blue-600', 'border-blue-300');

            } catch (err) {
                alert("Erro ao carregar detalhes: " + err.message);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle text-red-500"></i>';
            }
        }

        // --- UTILITÁRIOS ---
        function formatarMoeda(valor) {
            if (valor === undefined || valor === null) return '-';
            return parseFloat(valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function getClasseSituacao(status) {
            if (!status) return 'bg-slate-100 text-slate-500';
            const s = status.toLowerCase();
            if (s.includes('cancelado') || s.includes('fracassado')) return 'bg-red-100 text-red-600';
            if (s.includes('homologado') || s.includes('adjudicado')) return 'bg-green-100 text-green-700';
            return 'bg-blue-50 text-blue-600';
        }

        function atualizarPaginacao() {
            const div = document.getElementById('paginacaoControle');
            div.innerHTML = '';
            
            const totalPaginas = Math.ceil(dadosFiltrados.length / ITENS_POR_PAGINA);
            if(totalPaginas <= 1) return;

            // Botão Anterior
            const btnPrev = document.createElement('button');
            btnPrev.className = `p-2 rounded bg-white border border-slate-200 text-xs ${paginaAtual === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100'}`;
            btnPrev.innerHTML = '<i class="fas fa-chevron-left"></i>';
            btnPrev.onclick = () => { if(paginaAtual > 1) { paginaAtual--; renderizarTabela(); } };
            div.appendChild(btnPrev);

            // Indicador
            const span = document.createElement('span');
            span.className = 'px-3 py-2 text-xs font-bold text-slate-500';
            span.innerText = `Pág ${paginaAtual} de ${totalPaginas}`;
            div.appendChild(span);

            // Botão Próximo
            const btnNext = document.createElement('button');
            btnNext.className = `p-2 rounded bg-white border border-slate-200 text-xs ${paginaAtual >= totalPaginas ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100'}`;
            btnNext.innerHTML = '<i class="fas fa-chevron-right"></i>';
            btnNext.onclick = () => { if(paginaAtual < totalPaginas) { paginaAtual++; renderizarTabela(); } };
            div.appendChild(btnNext);
        }

        function incluirManual() {
            const url = prompt("Cole o Link do PNCP:");
            if (url && url.includes("pncp.gov.br")) {
                dadosCompletos.unshift({
                    id: "manual-" + Date.now(),
                    numero: "MANUAL",
                    orgao: "INCLUSÃO MANUAL",
                    objeto: "Oportunidade inserida manualmente.",
                    uf: "M",
                    link: url,
                    valor_total: 0
                });
                aplicarFiltros();
            }
        }

        function excluirItem(numero) {
            if(confirm('Remover esta licitação da lista?')) {
                dadosCompletos = dadosCompletos.filter(i => i.numero !== numero);
                aplicarFiltros();
            }
        }

        init();
    </script>
</body>
</html>
