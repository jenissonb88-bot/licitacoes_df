<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pharma - Monitor de Licita√ß√µes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-licitacao { border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; transition: transform 0.2s; }
        .card-licitacao:hover { transform: translateY(-5px); }
        .header-card { background-color: #004a99; color: white; padding: 12px 15px; border-radius: 12px 12px 0 0; }
        .badge-uf { background-color: #ffc107; color: #212529; font-weight: bold; font-size: 0.9em; }
        .status-aberto { color: #28a745; font-weight: bold; }
        .status-homologado { color: #007bff; font-weight: bold; }
        .detalhes-item { background-color: #fff; padding: 15px; border-top: 1px solid #dee2e6; }
        .pagination-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 30px; padding-bottom: 50px; }
        .btn-page { min-width: 40px; }
        .input-jump { width: 60px; text-align: center; }
        .table-itens { font-size: 0.85em; }
        .val-estimado { background-color: #fff3cd; font-weight: 600; }
        .val-homologado { background-color: #cfe2ff; font-weight: 600; }
    </style>
</head>
<body>

<div class="container py-4">
    <h2 class="mb-4 text-center">üî≠ Monitor Sniper Pharma - Drogafonte</h2>
    
    <div class="row mb-4">
        <div class="col-md-8">
            <input type="text" id="searchInput" class="form-control" placeholder="Buscar por √≥rg√£o, objeto, cidade ou fornecedor vencedor...">
        </div>
        <div class="col-md-4">
            <select id="filterUF" class="form-select">
                <option value="">Todas as UFs</option>
            </select>
        </div>
    </div>

    <div id="monitor-content"></div>

    <div class="pagination-container">
        <button class="btn btn-outline-primary" id="prevPage">Anterior</button>
        <span id="pageInfo" class="fw-bold">P√°gina 1</span>
        <button class="btn btn-outline-primary" id="nextPage">Pr√≥xima</button>
        
        <div class="ms-4 d-flex align-items-center">
            <span class="me-2">Ir para a p√°gina:</span>
            <input type="number" id="jumpInput" class="form-control input-jump me-2" min="1">
            <button class="btn btn-primary btn-sm" id="btnJump">Ir</button>
        </div>
    </div>
</div>

<script>
let allData = [];
let filteredData = [];
let currentPage = 1;
const itemsPerPage = 10;

// Carregar dados
async function loadData() {
    try {
        const response = await fetch('pregacoes_pharma_limpos.json.gz');
        const blob = await response.blob();
        const ds = new DecompressionStream('gzip');
        const decompressedStream = blob.stream().pipeThrough(ds);
        const text = await new Response(decompressedStream).text();
        allData = JSON.parse(text);
        
        // Ordenar por data (mais recentes primeiro)
        allData.sort((a, b) => new Date(b.data_enc) - new Date(a.data_enc));
        
        filteredData = [...allData];
        populateUFs();
        renderMonitor();
    } catch (error) {
        console.error("Erro ao carregar dados:", error);
    }
}

function renderMonitor() {
    const content = document.getElementById('monitor-content');
    content.innerHTML = '';

    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginatedItems = filteredData.slice(start, end);

    paginatedItems.forEach(preg => {
        const card = document.createElement('div');
        card.className = 'card card-licitacao';
        
        // L√≥gica de cores para valor total
        const valorTotal = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(preg.valor_estimado);

        card.innerHTML = `
            <div class="header-card d-flex justify-content-between align-items-center">
                <span><span class="badge badge-uf me-2">${preg.uf}</span> <strong>${preg.orgao}</strong></span>
                <span class="small">${preg.edital}</span>
            </div>
            <div class="card-body">
                <p class="mb-1 text-muted small"><strong>Cidade:</strong> ${preg.cidade} | <strong>Encerramento:</strong> ${new Date(preg.data_enc).toLocaleString()}</p>
                <p class="mb-2"><strong>Objeto:</strong> ${preg.objeto}</p>
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-secondary">${preg.tipo_licitacao}</span>
                    <h5 class="mb-0 text-primary">${valorTotal}</h5>
                    <button class="btn btn-sm btn-outline-dark" onclick="toggleDetails('${preg.id}')">Ver Itens</button>
                </div>
            </div>
            <div id="details-${preg.id}" class="detalhes-item d-none">
                <table class="table table-sm table-hover table-itens">
                    <thead>
                        <tr class="table-light">
                            <th>Item</th>
                            <th>Descri√ß√£o</th>
                            <th>Qtd</th>
                            <th>Un</th>
                            <th class="val-estimado">R$ Est. Unit</th>
                            <th class="val-homologado">R$ Homologado</th>
                            <th>Fornecedor Vencedor</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${preg.itens.map(it => `
                            <tr>
                                <td>${it.n}</td>
                                <td>${it.desc}</td>
                                <td>${it.qtd}</td>
                                <td>${it.un}</td>
                                <td class="val-estimado">R$ ${it.valUnit.toFixed(4)}</td>
                                <td class="val-homologado">R$ ${it.valHomologado ? it.valHomologado.toFixed(4) : '---'}</td>
                                <td><span class="${it.fornecedor ? 'status-homologado' : 'status-aberto'}">${it.fornecedor || 'AGUARDANDO'}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                <div class="mt-2 text-end">
                    <a href="${preg.link}" target="_blank" class="btn btn-sm btn-primary">Abrir no PNCP</a>
                </div>
            </div>
        `;
        content.appendChild(card);
    });

    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    document.getElementById('pageInfo').innerText = `P√°gina ${currentPage} de ${totalPages}`;
    document.getElementById('jumpInput').max = totalPages;
}

function toggleDetails(id) {
    const el = document.getElementById(`details-${id}`);
    el.classList.toggle('d-none');
}

// Fun√ß√µes de Navega√ß√£o
document.getElementById('prevPage').onclick = () => { if(currentPage > 1) { currentPage--; renderMonitor(); window.scrollTo(0,0); } };
document.getElementById('nextPage').onclick = () => { if(currentPage * itemsPerPage < filteredData.length) { currentPage++; renderMonitor(); window.scrollTo(0,0); } };

// Fun√ß√£o de Salto de P√°gina (Ir para a p√°gina)
document.getElementById('btnJump').onclick = () => {
    const jumpVal = parseInt(document.getElementById('jumpInput').value);
    const totalPages = Math.ceil(filteredData.length / itemsPerPage);
    if(jumpVal >= 1 && jumpVal <= totalPages) {
        currentPage = jumpVal;
        renderMonitor();
        window.scrollTo(0,0);
    } else {
        alert("P√°gina inv√°lida.");
    }
};

// ... Fun√ß√µes de busca e filtros de UF (mesma l√≥gica anterior) ...

loadData();
</script>
</body>
</html>
