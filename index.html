<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pharma - Preg√µes Inteligentes PNCP</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tarja-exclusivo { background: linear-gradient(90deg, #10b981, #059669); }
        .tarja-amplo { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .tarja-parcial { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .status-em { background: #f3f4f6; color: #374151; }
        .status-hom { background: #10b981; color: white; }
        .uf-ne { border-left: 4px solid #059669; }
        .uf-outros { border-left: 4px solid #3b82f6; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent mb-4">
                üöÄ Sniper Pharma Inteligente
            </h1>
            <p class="text-xl text-gray-600 mb-2">Preg√µes Farmac√™uticos PNCP - Filtro Regional Autom√°tico</p>
            <div class="flex justify-center gap-4 text-sm text-gray-500 mb-8 flex-wrap">
                <span>üü¢ Nordeste: Material M√©dico + Medicamentos</span>
                <span>üîµ Outros: Apenas Medicamentos</span>
                <span>‚ùå Exclu√≠dos: SUL + AP/AC</span>
            </div>
        </div>

        <!-- Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="font-semibold text-gray-700 mb-2">Total Preg√µes</h3>
                <div id="total-pregoes" class="text-3xl font-bold text-green-600">0</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="font-semibold text-gray-700 mb-2">Valor Total</h3>
                <div id="valor-total" class="text-3xl font-bold text-blue-600">R$ 0</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="font-semibold text-gray-700 mb-2">% MEEPP Exclusivo</h3>
                <div id="meeep-pct" class="text-3xl font-bold text-emerald-600">0%</div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="font-semibold text-gray-700 mb-2">√öltima Atualiza√ß√£o</h3>
                <div id="ultima-atualizacao" class="text-xl font-bold text-gray-800">-</div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üîç Filtros Inteligentes</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <select id="filtroUf" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Todas UFs</option>
                </select>
                <select id="filtroTarja" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    <option value="">Todas Tarjas</option>
                    <option value="TODO EXCLUSIVO">üü¢ Exclusivo MEEPP</option>
                    <option value="PARCIAL">üü° Parcial MEEPP</option>
                    <option value="TODO AMPLO">üîµ Amplo</option>
                </select>
                <select id="filtroStatus" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500">
                    <option value="">Todos Status</option>
                    <option value="EM ANDAMENTO">‚è≥ Em Andamento</option>
                    <option value="HOMOLOGADO">‚úÖ Homologado</option>
                </select>
            </div>
            <button id="btnFiltrar" class="mt-4 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-3 rounded-lg font-semibold transition-all duration-200 shadow-lg">
                üîé Filtrar
            </button>
        </div>

        <!-- Gr√°ficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-6">üìä Preg√µes por UF</h3>
                <canvas id="graficoUf"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-6">üìà Valores por Tarja MEEPP</h3>
                <canvas id="graficoTarja"></canvas>
            </div>
        </div>

        <!-- Tabela Principal -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 inline-block mr-4">üìã Oportunidades Pharma</h2>
                <span id="contador-visiveis" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">0 de 0</span>
            </div>
            <div class="overflow-x-auto">
                <table id="tabelaPreg√µes" class="w-full">
                    <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                        <tr>
                            <th class="p-4 text-left font-semibold text-gray-700">Tarja</th>
                            <th class="p-4 text-left font-semibold text-gray-700">UF/Cidade</th>
                            <th class="p-4 text-left font-semibold text-gray-700">√ìrg√£o</th>
                            <th class="p-4 text-left font-semibold text-gray-700">Objeto</th>
                            <th class="p-4 text-right font-semibold text-gray-700">Valor</th>
                            <th class="p-4 text-right font-semibold text-gray-700">Itens Match</th>
                            <th class="p-4 text-center font-semibold text-gray-700">Status</th>
                            <th class="p-4 text-center font-semibold text-gray-700">Data</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabela"></tbody>
                </table>
            </div>
        </div>

        <!-- Modal Detalhes -->
        <div id="modalDetalhes" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white max-w-4xl max-h-[90vh] w-full rounded-xl shadow-2xl overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-emerald-600 p-6 text-white">
                    <h2 id="modalTitulo" class="text-2xl font-bold">Detalhes do Preg√£o</h2>
                    <button id="fecharModal" class="float-right text-2xl hover:scale-110 transition-transform">√ó</button>
                </div>
                <div id="modalConteudo" class="p-6 overflow-y-auto max-h-96"></div>
            </div>
        </div>
    </div>

    <script>
        let dados = [];
        let graficos = {};

        // Carrega dados
        async function carregarDados() {
            try {
                const response = await fetch('dadosoportunidades.json.gz');
                if (!response.ok) throw new Error('Arquivo n√£o encontrado');
                
                const buffer = await response.arrayBuffer();
                const gunzip = new Zlib.Gunzip(new Uint8Array(buffer));
                const jsonString = new TextDecoder().decode(gunzip.decompress());
                dados = JSON.parse(jsonString);
                
                // Fallback se n√£o tiver gunzip
            } catch (e) {
                try {
                    const response = await fetch('dadosoportunidades.json');
                    dados = await response.json();
                } catch (e2) {
                    console.error('Erro carregando dados:', e2);
                    dados = [];
                }
            }

            atualizarInterface();
        }

        function atualizarInterface() {
            atualizarCards();
            criarGraficos();
            renderizarTabela(dados);
            preencherFiltros();
        }

        function atualizarCards() {
            const total = dados.length;
            const valorTotal = dados.reduce((sum, lic) => sum + (lic.valorFinal || 0), 0);
            const exclusivos = dados.filter(lic => lic.tarja === 'TODO EXCLUSIVO').length;
            const ultima = dados.length ? new Date(Math.max(...dados.map(d => d.dataPub))).toLocaleDateString('pt-BR') : '-';

            document.getElementById('total-pregoes').textContent = total;
            document.getElementById('valor-total').textContent = `R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('meeep-pct').textContent = total ? `${((exclusivos/total)*100).toFixed(1)}%` : '0%';
            document.getElementById('ultima-atualizacao').textContent = ultima;
        }

        function renderizarTabela(filtrados) {
            const tbody = document.getElementById('corpoTabela');
            const contador = document.getElementById('contador-visiveis');
            
            tbody.innerHTML = filtrados.map(lic => `
                <tr class="hover:bg-gray-50 border-b transition-colors ${lic.uf && ['AL','BA','CE','MA','PB','PE','PI','RN','SE'].includes(lic.uf.toUpperCase()) ? 'uf-ne' : 'uf-outros'}">
                    <td class="p-4 font-semibold">
                        <span class="px-3 py-1 rounded-full text-sm ${lic.tarja === 'TODO EXCLUSIVO' ? 'tarja-exclusivo' : lic.tarja === 'PARCIAL' ? 'tarja-parcial' : 'tarja-amplo'}">
                            ${lic.tarja}
                        </span>
                    </td>
                    <td class="p-4">
                        <div class="font-semibold text-lg">${lic.uf || '??'}</div>
                        <div class="text-sm text-gray-600">${lic.cidade || '-'}</div>
                    </td>
                    <td class="p-4">
                        <div class="font-medium">${lic.orgao?.slice(0,40) || '-'}${lic.orgao?.length > 40 ? '...' : ''}</div>
                        <div class="text-sm text-gray-500">${lic.unidadeCompradora || '-'}</div>
                    </td>
                    <td class="p-4 max-w-xs">
                        <div class="font-medium line-clamp-2" title="${lic.objeto}">${lic.objeto || '-'}</div>
                    </td>
                    <td class="p-4 text-right">
                        <div class="text-xl font-bold text-green-600">R$ ${lic.valorFinal?.toLocaleString('pt-BR') || '0'}</div>
                        <div class="text-sm text-gray-500">${lic.uasg}</div>
                    </td>
                    <td class="p-4 text-center">
                        <div class="font-semibold">${lic.itens?.filter(i => i.match).length || 0}</div>
                        <div class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${lic.itens?.length || 0} total</div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${lic.itens?.some(i => i.situacao === 'HOMOLOGADO') ? 'status-hom' : 'status-em'}">
                            ${lic.itens?.some(i => i.situacao === 'HOMOLOGADO') ? '‚úÖ HOMOLOGADO' : '‚è≥ ANDAMENTO'}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        <div>${lic.dataPub ? new Date(lic.dataPub).toLocaleDateString('pt-BR') : '-'}</div>
                        <a href="${lic.link}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium text-sm mt-1 block">üìã Edital</a>
                    </td>
                </tr>
            `).join('');

            contador.textContent = `${filtrados.length} de ${dados.length}`;
        }

        function aplicarFiltros() {
            const uf = document.getElementById('filtroUf').value.toUpperCase();
            const tarja = document.getElementById('filtroTarja').value;
            const status = document.getElementById('filtroStatus').value;

            const filtrados = dados.filter(lic => {
                return (!uf || lic.uf === uf) &&
                       (!tarja || lic.tarja === tarja) &&
                       (!status || lic.itens?.some(i => i.situacao.includes(status)));
            });

            renderizarTabela(filtrados);
        }

        function preencherFiltros() {
            const ufs = [...new Set(dados.map(d => d.uf).filter(Boolean))].sort();
            const ufSelect = document.getElementById('filtroUf');
            ufSelect.innerHTML = '<option value="">Todas UFs</option>' + 
                ufs.map(uf => `<option value="${uf}">${uf}</option>`).join('');
        }

        // Gr√°ficos
        function criarGraficos() {
            const ctxUf = document.getElementById('graficoUf').getContext('2d');
            const ufsData = {};
            dados.forEach(lic => {
                const uf = lic.uf || 'SP';
                ufsData[uf] = (ufsData[uf] || 0) + 1;
            });

            if (graficos.graficoUf) graficos.graficoUf.destroy();
            graficos.graficoUf = new Chart(ctxUf, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(ufsData),
                    datasets: [{
                        data: Object.values(ufsData),
                        backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Gr√°fico Tarja
            const ctxTarja = document.getElementById('graficoTarja').getContext('2d');
            const tarjas = { 'TODO EXCLUSIVO': 0, 'PARCIAL': 0, 'TODO AMPLO': 0 };
            dados.forEach(lic => tarjas[lic.tarja || ''] = (tarjas[lic.tarja || ''] || 0) + 1);

            if (graficos.graficoTarja) graficos.graficoTarja.destroy();
            graficos.graficoTarja = new Chart(ctxTarja, {
                type: 'bar',
                data: {
                    labels: Object.keys(tarjas),
                    datasets: [{
                        label: 'Qtd Preg√µes',
                        data: Object.values(tarjas),
                        backgroundColor: ['#10b981', '#f59e0b', '#3b82f6']
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        // Event Listeners
        document.getElementById('btnFiltrar').onclick = aplicarFiltros;
        document.getElementById('fecharModal').onclick = () => {
            document.getElementById('modalDetalhes').classList.add('hidden');
        };

        // Auto-refresh a cada 5min
        setInterval(carregarDados, 300000);

        // Inicializar
        carregarDados();
    </script>
</body>
</html>
