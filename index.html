<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sniper Pharma - Monitor V8 (Histórico)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --primary-dark: #2c3e50; --accent-blue: #3498db; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; font-size: 0.85rem; }
        
        .header-bar { background: var(--primary-dark); color: white; padding: 12px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card-table { border: none; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .table-pncp thead { background-color: #34495e; color: white; text-transform: uppercase; font-size: 0.75rem; cursor: pointer; }
        .table-pncp thead th:hover { background-color: #2c3e50; }
        .table-pncp td { vertical-align: middle; padding: 10px; border-bottom: 1px solid #eee; }

        .uasg-orgao { font-weight: 700; color: #2c3e50; font-size: 0.9rem; }
        .unidade-comp { color: #555; font-size: 0.8rem; display: block; margin-top: 2px; }
        .local-uf { color: #7f8c8d; font-size: 0.8rem; display: block; font-style: italic; }

        .badge-tipo { font-size: 0.7rem; font-weight: 700; padding: 4px 8px; border-radius: 4px; display: inline-block; width: 100%; text-align: center; }
        .tipo-amplo { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .tipo-exclusivo { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        .tipo-parcial { background-color: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }

        .group-header { padding: 8px 15px; font-weight: 700; color: white; border-radius: 4px 4px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .bg-fornecedor { background-color: #2c3e50; } 
        .bg-andamento { background-color: #198754; } 
        .bg-fracassado { background-color: #dc3545; } 
        
        .table-itens th { background: #f8f9fa; font-size: 0.75rem; }
        .me-epp-sim { color: #dc3545; font-weight: 800; } 
        .me-epp-nao { color: #ccc; font-weight: 400; }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .sort-icon { float: right; margin-left: 5px; opacity: 0.5; }
        .active-sort { opacity: 1; color: #48c774; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner-border text-primary" role="status" id="spinner"></div>
    <div class="mt-3 text-secondary fw-bold" id="loading-msg">Carregando dados...</div>
    <button class="btn btn-sm btn-primary mt-3 d-none" id="btn-retry" onclick="location.reload()">Tentar Novamente</button>
</div>

<div class="header-bar d-flex justify-content-between align-items-center sticky-top">
    <div class="fw-bold fs-5"><i class="fas fa-crosshairs me-2"></i>SNIPER PHARMA V8</div>
    <div class="d-flex align-items-center gap-3">
        <div class="form-check form-switch text-white">
            <input class="form-check-input" type="checkbox" id="chkOcultarVencidos" onchange="render()">
            <label class="form-check-label small" for="chkOcultarVencidos">Ocultar Vencidos</label>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="location.reload()"><i class="fas fa-sync-alt"></i></button>
    </div>
</div>

<div class="container-fluid py-3">
    <div class="card card-table p-3 mb-3">
        <div class="row g-2">
            <div class="col-md-2"><input id="fUf" class="form-control form-control-sm" placeholder="UF" onkeyup="render()"></div>
            <div class="col-md-4"><input id="fOrgao" class="form-control form-control-sm" placeholder="Cidade ou Órgão" onkeyup="render()"></div>
            <div class="col-md-4"><input id="fObjeto" class="form-control form-control-sm" placeholder="Palavra no Objeto" onkeyup="render()"></div>
            <div class="col-md-2">
                <select id="fTipo" class="form-select form-select-sm" onchange="render()">
                    <option value="">Todos os Tipos</option>
                    <option value="AMPLO">Amplo (Verde)</option>
                    <option value="EXCLUSIVO">Exclusivo ME/EPP (Vermelho)</option>
                    <option value="PARCIAL">Parcial (Amarelo)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="card card-table">
        <div class="table-responsive">
            <table class="table table-hover table-pncp mb-0">
                <thead>
                    <tr>
                        <th style="width: 110px;" onclick="ordenar('data_enc')">Data Fim <i id="icon-data_enc" class="fas fa-sort sort-icon"></i></th>
                        <th style="width: 80px;" class="text-center" onclick="ordenar('tipo')">Tipo <i id="icon-tipo" class="fas fa-sort sort-icon"></i></th>
                        <th onclick="ordenar('orgao')">Órgão / Unidade / Local <i id="icon-orgao" class="fas fa-sort sort-icon"></i></th>
                        <th style="width: 100px;">Edital</th>
                        <th>Objeto</th>
                        <th class="text-end" style="width: 120px;" onclick="ordenar('valor')">Valor Est. <i id="icon-valor" class="fas fa-sort sort-icon"></i></th>
                        <th class="text-center" style="width: 80px;">Ação</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
        <div class="p-3 d-flex justify-content-between align-items-center border-top">
            <div class="text-muted small">
                Exibindo <span id="totalVisible" class="fw-bold">0</span> de <span id="totalReg" class="fw-bold">0</span> registros
            </div>
            <div class="d-flex align-items-center">
                <button class="btn btn-sm btn-secondary me-2" onclick="mudarPagina(-1)" id="btnAnt">Anterior</button>
                <span class="text-muted small mx-2">Página <span id="pagAtual">1</span> de <span id="pagTotal">1</span></span>
                <button class="btn btn-sm btn-secondary ms-2" onclick="mudarPagina(1)" id="btnProx">Próximo</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalDetalhes" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2 bg-dark text-white">
                <h6 class="modal-title">Detalhamento do Processo</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div id="modalBody" class="modal-body bg-light"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

<script>
    const FILE_URL = 'pregacoes_pharma_limpos.json.gz';
    let dadosOriginais = [], dadosFiltrados = [];
    let pagina = 1;
    const ITENS_POR_PAG = 20;
    
    // Estado da Ordenação
    let ordemAtual = { campo: 'data_enc', direcao: 'asc' }; // Z-A na lógica invertida

    const fmtBrl = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmtData = d => d ? new Date(d).toLocaleDateString('pt-BR') : '--';

    window.onload = async () => {
        try {
            updateLoading("Baixando arquivo de dados...");
            const res = await fetch(`${FILE_URL}?v=${Date.now()}`);
            if(!res.ok) throw new Error("Arquivo não encontrado.");
            
            const blob = await res.blob();
            const arrayBuffer = await blob.arrayBuffer();

            updateLoading("Descompactando...");
            let text;
            try { text = pako.ungzip(new Uint8Array(arrayBuffer), {to:'string'}); }
            catch { text = await new Response(blob).text(); }
            
            updateLoading("Processando JSON...");
            try { dadosOriginais = JSON.parse(text); } 
            catch { throw new Error("JSON inválido."); }

            if (!Array.isArray(dadosOriginais)) dadosOriginais = [];
            
            // Renderiza com a ordenação padrão (Z-A)
            ordenar('data_enc', true);
            
            document.getElementById('loading-overlay').style.display = 'none';

        } catch (e) {
            console.error(e);
            showError(`Erro: ${e.message}`);
        }
    };

    function updateLoading(msg) {
        const el = document.getElementById('loading-msg');
        if(el) el.innerText = msg;
    }

    function showError(msg) {
        document.getElementById('spinner').style.display = 'none';
        const el = document.getElementById('loading-msg');
        el.innerHTML = `<div class="text-danger mb-2"><i class="fas fa-exclamation-triangle fa-2x"></i></div>${msg}`;
        document.getElementById('btn-retry').classList.remove('d-none');
    }

    function ordenar(campo, force = false) {
        if (!force) {
            if (ordemAtual.campo === campo) {
                ordemAtual.direcao = ordemAtual.direcao === 'asc' ? 'desc' : 'asc';
            } else {
                ordemAtual.campo = campo;
                ordemAtual.direcao = 'asc';
            }
        }

        document.querySelectorAll('.sort-icon').forEach(i => i.className = 'fas fa-sort sort-icon');
        const icon = document.getElementById(`icon-${campo}`);
        if(icon) {
            icon.className = `fas fa-sort-${ordemAtual.direcao === 'asc' ? 'up' : 'down'} sort-icon active-sort`;
        }

        render();
    }

    function render() {
        const uf = document.getElementById('fUf').value.toUpperCase();
        const org = document.getElementById('fOrgao').value.toUpperCase();
        const obj = document.getElementById('fObjeto').value.toUpperCase();
        const tipo = document.getElementById('fTipo').value;
        const ocultarVencidos = document.getElementById('chkOcultarVencidos').checked;
        const hoje = new Date();

        // 1. Filtragem
        dadosFiltrados = dadosOriginais.filter(d => {
            const dataObj = d.data_enc ? new Date(d.data_enc) : null;
            
            // Filtro de Vencidos (Só aplica se checkbox estiver marcado)
            if (ocultarVencidos && dataObj && dataObj < hoje) return false;

            const fullLocal = ((d.cidade || '') + ' ' + (d.orgao || '')).toUpperCase();
            return ((d.uf || '').toUpperCase().includes(uf) && 
                    fullLocal.includes(org) && 
                    (d.objeto || '').toUpperCase().includes(obj) &&
                    (tipo === "" || d.tipo_licitacao === tipo));
        });

        // 2. Ordenação
        dadosFiltrados.sort((a, b) => {
            let valA, valB;

            switch (ordemAtual.campo) {
                case 'data_enc':
                    // Para ordenar Z-A (Futuro -> Passado) como padrão:
                    // Se for data nula, joga pro passado distante
                    valA = a.data_enc ? new Date(a.data_enc).getTime() : 0;
                    valB = b.data_enc ? new Date(b.data_enc).getTime() : 0;
                    
                    // Inversão padrão para Data: Mais novo primeiro
                    if (ordemAtual.direcao === 'asc') return valB - valA; 
                    else return valA - valB;
                    
                case 'valor':
                    valA = a.valor_estimado || 0;
                    valB = b.valor_estimado || 0;
                    break;
                case 'orgao':
                    valA = (a.orgao || '').toLowerCase();
                    valB = (b.orgao || '').toLowerCase();
                    break;
                case 'tipo':
                    valA = (a.tipo_licitacao || '').toLowerCase();
                    valB = (b.tipo_licitacao || '').toLowerCase();
                    break;
                default:
                    valA = 0; valB = 0;
            }

            // Ordenação padrão para strings/numeros
            if (ordemAtual.campo !== 'data_enc') {
                if (valA < valB) return ordemAtual.direcao === 'asc' ? -1 : 1;
                if (valA > valB) return ordemAtual.direcao === 'asc' ? 1 : -1;
                return 0;
            }
        });

        // 3. Paginação
        const totalPaginas = Math.ceil(dadosFiltrados.length / ITENS_POR_PAG) || 1;
        if(pagina > totalPaginas) pagina = totalPaginas;
        if(pagina < 1) pagina = 1;

        const inicio = (pagina - 1) * ITENS_POR_PAG;
        const lote = dadosFiltrados.slice(inicio, inicio + ITENS_POR_PAG);
        
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        lote.forEach(d => {
            const dataObj = d.data_enc ? new Date(d.data_enc) : null;
            let corData = 'text-dark';
            
            if (dataObj) {
                const diffHoras = (dataObj - hoje) / 36e5; 
                if (diffHoras < 0) corData = 'text-decoration-line-through text-muted'; // Vencido
                else if (diffHoras < 48) corData = 'text-danger fw-bold'; // Urgente
            }

            let classeTipo = 'tipo-amplo'; 
            if(d.tipo_licitacao === 'EXCLUSIVO') classeTipo = 'tipo-exclusivo';
            if(d.tipo_licitacao === 'PARCIAL') classeTipo = 'tipo-parcial';

            tbody.innerHTML += `
                <tr>
                    <td class="${corData}">${fmtData(d.data_enc)}</td>
                    <td class="text-center"><span class="badge-tipo ${classeTipo}">${d.tipo_licitacao || 'AMPLO'}</span></td>
                    <td>
                        <div class="uasg-orgao">UASG ${d.uasg || '---'} - ${d.orgao || 'Órgão Desconhecido'}</div>
                        <div class="unidade-comp">${d.unidade || ''}</div>
                        <div class="local-uf">${d.cidade || ''} - ${d.uf || ''}</div>
                    </td>
                    <td>${d.edital || '-'}</td>
                    <td><div class="text-truncate" style="max-width:350px" title="${d.objeto}">${d.objeto}</div></td>
                    <td class="text-end fw-bold text-success">${fmtBrl.format(d.valor_estimado || 0)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalhes('${d.id}')"><i class="fas fa-list"></i></button>
                        <a href="${d.link}" target="_blank" class="btn btn-sm btn-outline-dark"><i class="fas fa-external-link-alt"></i></a>
                    </td>
                </tr>
            `;
        });

        // Atualiza controles
        document.getElementById('pagAtual').innerText = pagina;
        document.getElementById('pagTotal').innerText = totalPaginas;
        document.getElementById('totalReg').innerText = dadosOriginais.length;
        document.getElementById('totalVisible').innerText = dadosFiltrados.length;
        
        document.getElementById('btnAnt').disabled = pagina === 1;
        document.getElementById('btnProx').disabled = pagina === totalPaginas;
    }

    function mudarPagina(d) { pagina += d; render(); document.querySelector('.card-table').scrollIntoView(); }

    function verDetalhes(id) {
        const lic = dadosOriginais.find(d => d.id === id);
        if(!lic) return;

        const itens = lic.itens || [];
        const grupos = { 'EM_ANDAMENTO': [], 'HOMOLOGADO': {}, 'OUTROS': [] };

        itens.forEach(it => {
            const sit = (it.situacao || 'EM_ANDAMENTO');
            if (sit === 'HOMOLOGADO') {
                const forn = it.fornecedor || 'Fornecedor Não Identificado';
                if (!grupos.HOMOLOGADO[forn]) grupos.HOMOLOGADO[forn] = [];
                grupos.HOMOLOGADO[forn].push(it);
            } else if (sit === 'EM_ANDAMENTO') {
                grupos.EM_ANDAMENTO.push(it);
            } else {
                grupos.OUTROS.push(it);
            }
        });

        let html = `
            <div class="alert alert-light border shadow-sm">
                <strong>${lic.orgao}</strong><br>
                <small>${lic.cidade}/${lic.uf} - Edital: ${lic.edital}</small>
                <div class="mt-2 text-muted small">${lic.objeto}</div>
            </div>
        `;

        const gerarTabela = (lista, mostrarValHom) => {
            let trs = '';
            lista.forEach(it => {
                const txtMeEpp = it.me_epp ? '<span class="me-epp-sim">SIM</span>' : '<span class="me-epp-nao">NÃO</span>';
                const valShow = mostrarValHom ? (it.valHomologado || 0) : (it.valUnit || 0);
                const total = (it.qtd || 0) * valShow;
                
                let descSit = '';
                if(it.situacao === 'CANCELADO') descSit = '<span class="badge bg-danger ms-1">CANCELADO</span>';
                if(it.situacao === 'DESERTO') descSit = '<span class="badge bg-warning text-dark ms-1">DESERTO</span>';
                if(it.situacao === 'FRACASSADO') descSit = '<span class="badge bg-danger ms-1">FRACASSADO</span>';

                trs += `
                    <tr>
                        <td class="text-center">${it.n}</td>
                        <td class="text-center">${txtMeEpp}</td>
                        <td>${it.desc} ${descSit}</td>
                        <td class="text-center">${it.qtd}</td>
                        <td class="text-center">${it.un}</td>
                        <td class="text-end">${fmtBrl.format(valShow)}</td>
                        <td class="text-end fw-bold">${fmtBrl.format(total)}</td>
                    </tr>
                `;
            });
            return `
                <div class="table-responsive mb-3">
                    <table class="table table-sm table-bordered table-itens mb-0">
                        <thead>
                            <tr>
                                <th style="width:50px">Item</th>
                                <th style="width:50px">ME/EPP</th>
                                <th>Descrição</th>
                                <th style="width:70px">Qtd</th>
                                <th style="width:60px">Un</th>
                                <th style="width:110px">${mostrarValHom ? 'Val. Final' : 'Val. Est.'}</th>
                                <th style="width:110px">Total</th>
                            </tr>
                        </thead>
                        <tbody>${trs}</tbody>
                    </table>
                </div>
            `;
        };

        if (Object.keys(grupos.HOMOLOGADO).length > 0) {
            html += `<h6 class="mt-4 border-bottom pb-2">✅ Itens Homologados / Adjudicados</h6>`;
            for (const [fornecedor, lista] of Object.entries(grupos.HOMOLOGADO)) {
                html += `
                    <div class="card mb-3 shadow-sm border-dark">
                        <div class="group-header bg-fornecedor">
                            <span><i class="fas fa-truck me-2"></i> ${fornecedor}</span>
                            <span class="badge bg-white text-dark">${lista.length} itens</span>
                        </div>
                        <div class="card-body p-0">${gerarTabela(lista, true)}</div>
                    </div>`;
            }
        }

        if (grupos.EM_ANDAMENTO.length > 0) {
            html += `
                <div class="card mb-3 border-success shadow-sm mt-4">
                    <div class="group-header bg-andamento">
                        <span><i class="fas fa-clock me-2"></i> Em Andamento / Aberto</span>
                        <span class="badge bg-white text-dark">${grupos.EM_ANDAMENTO.length} itens</span>
                    </div>
                    <div class="card-body p-0">${gerarTabela(grupos.EM_ANDAMENTO, false)}</div>
                </div>`;
        }

        if (grupos.OUTROS.length > 0) {
            html += `
                <div class="card mb-3 border-danger shadow-sm mt-4">
                    <div class="group-header bg-fracassado">
                        <span><i class="fas fa-times-circle me-2"></i> Fracassados / Desertos / Cancelados</span>
                        <span class="badge bg-white text-dark">${grupos.OUTROS.length} itens</span>
                    </div>
                    <div class="card-body p-0">${gerarTabela(grupos.OUTROS, false)}</div>
                </div>`;
        }

        document.getElementById('modalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('modalDetalhes')).show();
    }
</script>
</body>
</html>
