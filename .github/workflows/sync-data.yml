name: Sniper Pharma Controller

on:
  schedule:
    - cron: '0 9 * * *'  # Roda todo dia √†s 06:00 BRT (09:00 UTC)
  workflow_dispatch:
    inputs:
      mode:
        description: 'Modo de Execu√ß√£o'
        required: true
        default: 'manual_loop'
        type: choice
        options:
        - manual_loop
        - single_run
      target_date:
        description: 'Data Alvo (YYYY-MM-DD) para iniciar o loop ou rodar √∫nico'
        required: false
        default: '2025-12-01'

jobs:
  sniper:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Permite git push
      actions: write   # Permite disparar o pr√≥ximo workflow (loop)

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Importante para o git pull --rebase funcionar bem

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install deps
      run: pip install requests

    # --- 1. L√ìGICA DE DECIS√ÉO DE DATAS ---
    - name: Definir Datas e Modo
      id: config
      run: |
        # Configura√ß√£o de Fuso Hor√°rio
        export TZ="America/Sao_Paulo"
        TODAY=$(date +'%Y-%m-%d')
        DAY_OF_MONTH=$(date +'%d')

        # CASO 1: Agendado (CRON)
        if [ "${{ github.event_name }}" == "schedule" ]; then
          
          # Se for dia 01 ou dia 16 -> Varredura Completa desde 2026-01-01
          if [ "$DAY_OF_MONTH" == "01" ] || [ "$DAY_OF_MONTH" == "16" ]; then
            echo "START_DATE=2026-01-01" >> $GITHUB_ENV
            echo "END_DATE=$TODAY" >> $GITHUB_ENV
            echo "MODE=full_scan" >> $GITHUB_ENV
            echo "üìÖ ROTINA QUINZENAL: Varredura Completa iniciada."
          
          # Outros dias -> Pega os ultimos 3 dias (seguran√ßa)
          else
            START_3DAYS=$(date -d "3 days ago" +'%Y-%m-%d')
            echo "START_DATE=$START_3DAYS" >> $GITHUB_ENV
            echo "END_DATE=$TODAY" >> $GITHUB_ENV
            echo "MODE=daily_update" >> $GITHUB_ENV
            echo "üìÖ ROTINA DI√ÅRIA: Verificando √∫ltimos 3 dias."
          fi

        # CASO 2: Manual (Workflow Dispatch)
        else
          INPUT_DATE="${{ inputs.target_date }}"
          echo "START_DATE=$INPUT_DATE" >> $GITHUB_ENV
          # No loop manual, processamos 1 dia por vez
          echo "END_DATE=$INPUT_DATE" >> $GITHUB_ENV 
          echo "MODE=${{ inputs.mode }}" >> $GITHUB_ENV
          echo "üîß MODO MANUAL: ${{ inputs.mode }} para $INPUT_DATE"
        fi

    # --- 2. EXECU√á√ÉO DOS SCRIPTS ---
    - name: Run app.py (Coleta)
      run: |
        echo "üöÄ Iniciando Sniper Pharma de $START_DATE at√© $END_DATE..."
        python app.py --start "$START_DATE" --end "$END_DATE"

    - name: Run limpeza.py (Filtros)
      run: python limpeza.py

    # --- 3. COMMIT E PUSH SEGURO ---
    - name: Commit results
      run: |
        git config user.name "Sniper Pharma Bot"
        git config user.email "sniper@pharma.bot"
        
        # Cria checkpoint se n√£o existir
        if [ ! -f checkpoint.txt ]; then echo "$START_DATE" > checkpoint.txt; fi
        
        # Adiciona arquivos (usando || true para n√£o quebrar se algo faltar)
        # Verifica se a pasta 'dados' existe antes de adicionar
        if [ -d "dados" ]; then
          git add dados/ || true
        fi
        
        git add checkpoint.txt || true
        git add pregacoes_pharma_limpos.json.gz || true
        
        # S√≥ tenta commitar se houver mudan√ßas no stage
        if ! git diff --staged --quiet; then
          git commit -m "Sniper $START_DATE | Mode: $MODE"
          
          # --- CORRE√á√ÉO DO ERRO DE REJEI√á√ÉO ---
          # Puxa as mudan√ßas remotas e aplica as locais por cima
          echo "üîÑ Sincronizando com remoto..."
          git pull --rebase origin main || git pull --rebase origin master
          
          echo "‚¨ÜÔ∏è Enviando dados..."
          git push
        else
          echo "‚ú® Nenhuma altera√ß√£o encontrada para commitar."
        fi

    # --- 4. AUTO-TRIGGER (LOOP RECURSIVO) ---
    - name: Trigger Pr√≥ximo Dia (Apenas Loop Manual)
      if: inputs.mode == 'manual_loop'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        CURRENT="${{ inputs.target_date }}"
        # Calcula o pr√≥ximo dia
        NEXT_DAY=$(date -d "$CURRENT + 1 day" +'%Y-%m-%d')
        TODAY=$(date +'%Y-%m-%d')
        
        # Verifica se o pr√≥ximo dia ainda √© passado ou hoje
        if [[ "$NEXT_DAY" < "$TODAY" ]] || [[ "$NEXT_DAY" == "$TODAY" ]]; then
          echo "üîÅ Gatilho ativado para o pr√≥ximo dia: $NEXT_DAY"
          gh workflow run sync-data.yml -f mode=manual_loop -f target_date="$NEXT_DAY"
        else
          echo "üèÅ Chegamos na data atual ($TODAY). Fim do Loop Manual."
        fi
