name: Monitoramento PNCP Iterativo

on:
  schedule:
    - cron: '0 11 * * *' # Executa todo dia 맙 08:00 (BRT)
  workflow_dispatch:     # Permite o rob칪 se auto-chamar

permissions:
  contents: write
  actions: write

jobs:
  run-robot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do C칩digo
        uses: actions/checkout@v3

      - name: L칩gica de Rein칤cio Quinzenal (Dias 01 e 16)
        run: |
          # Verifica se foi um acionamento autom치tico (cron)
          if [ "${{ github.event_name }}" == "schedule" ]; then
            DIA=$(date +%d)
            # Se for dia 01 ou 16, for칞a o rob칪 a voltar para o come칞o do ano!
            if [ "$DIA" == "01" ] || [ "$DIA" == "16" ]; then
              echo "游늱 Dia $DIA: Iniciando varredura profunda de atualiza칞칚o!"
              echo "20260101" > checkpoint.txt
            fi
          fi

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Executar Coleta Di치ria
        run: |
          pip install requests urllib3
          python app.py

      - name: Salvar Dados no Reposit칩rio
        run: |
          git config --global user.name "Bot PNCP"
          git config --global user.email "bot@pncp.com"
          git add .
          git commit -m "Dia processado: $(cat checkpoint.txt)" || exit 0
          git push

      - name: Auto-Acionamento (Loop Inteligente)
        if: hashFiles('finish.txt') == ''
        run: |
          echo "Ainda h치 dias pendentes. Disparando pr칩xima tarefa imediatamente..."
          # Usa o CLI oficial do GitHub para chamar a si mesmo com seguran칞a
          env GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} gh workflow run "${{ github.workflow }}"
