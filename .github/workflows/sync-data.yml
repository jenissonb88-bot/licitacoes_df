name: Triagem Di√°ria e Recursiva PNCP

on:
  schedule:
    - cron: '0 9 * * *' # Roda automaticamente √†s 06:00 AM Bras√≠lia
  workflow_dispatch: # Permite iniciar manualmente

jobs:
  coleta_dados:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout do Reposit√≥rio
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar Depend√™ncias
        run: pip install requests pandas

      - name: Executar Rob√¥
        id: exec_robo
        run: python app.py

      - name: Salvar Progresso (Commit)
        run: |
          git config --global user.name "COLETA-PNCP-BOT"
          git config --global user.email "bot@github.com"
          git add dados/oportunidades.js checkpoint.txt
          if ! git diff --cached --quiet; then
            git commit -m "Auto: Dados atualizados e Checkpoint avan√ßado"
            git push origin main
          else
            echo "Sem novos dados para este dia."
          fi

      - name: Iniciar Pr√≥ximo Dia (Recurs√£o)
        # IMPORTANTE: Ele l√™ o arquivo env.txt criado pelo Python
        run: |
          if [ -f env.txt ]; then
            source env.txt
            if [ "$CONTINUAR_EXECUCAO" = "true" ]; then
              echo "üîÑ Ativando pr√≥xima varredura..."
              curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/actions/workflows/sync-data.yml/dispatches \
                -d '{"ref":"main"}'
            else
              echo "‚úÖ Tudo atualizado at√© a data de hoje."
            fi
          fi
