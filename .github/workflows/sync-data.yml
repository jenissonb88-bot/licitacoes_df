name: Sniper Pharma Controller

on:
  schedule:
    - cron: '0 9 * * *'  # Roda todo dia √†s 06:00 BRT
  workflow_dispatch:
    inputs:
      mode:
        description: 'Modo de Execu√ß√£o'
        required: true
        default: 'manual_loop'
        type: choice
        options:
        - manual_loop
        - single_run
      target_date:
        description: 'Data Alvo (YYYY-MM-DD)'
        required: false
        default: '2025-12-01'

jobs:
  sniper:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install deps
      run: pip install requests

    # --- 1. L√ìGICA DE DATAS ---
    - name: Definir Datas e Modo
      id: config
      run: |
        export TZ="America/Sao_Paulo"
        TODAY=$(date +'%Y-%m-%d')
        DAY_OF_MONTH=$(date +'%d')

        if [ "${{ github.event_name }}" == "schedule" ]; then
          if [ "$DAY_OF_MONTH" == "01" ] || [ "$DAY_OF_MONTH" == "16" ]; then
            echo "START_DATE=2026-01-01" >> $GITHUB_ENV
            echo "END_DATE=$TODAY" >> $GITHUB_ENV
            echo "MODE=full_scan" >> $GITHUB_ENV
          else
            START_3DAYS=$(date -d "3 days ago" +'%Y-%m-%d')
            echo "START_DATE=$START_3DAYS" >> $GITHUB_ENV
            echo "END_DATE=$TODAY" >> $GITHUB_ENV
            echo "MODE=daily_update" >> $GITHUB_ENV
          fi
        else
          INPUT_DATE="${{ inputs.target_date }}"
          echo "START_DATE=$INPUT_DATE" >> $GITHUB_ENV
          echo "END_DATE=$INPUT_DATE" >> $GITHUB_ENV 
          echo "MODE=${{ inputs.mode }}" >> $GITHUB_ENV
        fi

    # --- 2. EXECU√á√ÉO ---
    - name: Run app.py
      run: python app.py --start "$START_DATE" --end "$END_DATE"

    - name: Run limpeza.py
      run: python limpeza.py

    # --- 3. COMMIT E PUSH (ESTRAT√âGIA ANTI-CONFLITO) ---
    - name: Commit results
      run: |
        git config user.name "Sniper Pharma Bot"
        git config user.email "sniper@pharma.bot"
        
        echo "üîÑ Resolvendo conflitos preventivamente..."
        
        # 1. Baixa o hist√≥rico mais recente do servidor
        git fetch origin main
        
        # 2. Reseta o hist√≥rico local para igualar ao servidor (sem apagar os arquivos gerados pelo Python)
        # O --mixed mant√©m os arquivos na pasta (Work Tree) mas limpa o Stage
        git reset --mixed origin/main
        
        # 3. Agora adicionamos nossos arquivos rec√©m-gerados como a "vers√£o final"
        if [ ! -f checkpoint.txt ]; then echo "$START_DATE" > checkpoint.txt; fi
        
        if [ -d "dados" ]; then git add dados/ || true; fi
        git add checkpoint.txt || true
        git add pregacoes_pharma_limpos.json.gz || true
        
        # 4. Verifica se tem mudan√ßa e commita
        if ! git diff --staged --quiet; then
          git commit -m "Sniper $START_DATE | Mode: $MODE"
          echo "‚¨ÜÔ∏è Enviando dados (Fast-Forward)..."
          git push origin main
        else
          echo "‚ú® Nenhuma altera√ß√£o nova para enviar."
        fi

    # --- 4. LOOP ---
    - name: Trigger Pr√≥ximo Dia
      if: inputs.mode == 'manual_loop'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        CURRENT="${{ inputs.target_date }}"
        NEXT_DAY=$(date -d "$CURRENT + 1 day" +'%Y-%m-%d')
        TODAY=$(date +'%Y-%m-%d')
        
        if [[ "$NEXT_DAY" < "$TODAY" ]] || [[ "$NEXT_DAY" == "$TODAY" ]]; then
          echo "üîÅ Pr√≥ximo dia: $NEXT_DAY"
          gh workflow run sync-data.yml -f mode=manual_loop -f target_date="$NEXT_DAY"
        else
          echo "üèÅ Fim do Loop."
        fi
