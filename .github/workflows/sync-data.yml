name: Sniper Pharma Inteligente
on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'        # DiÃ¡ria 3h
    - cron: '0 5 1,16 * *'      # RevisÃ£o 1/16 5h

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: true
        fetch-depth: 0
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install Dependencies
      run: pip install requests pandas openpyxl
      
    - name: ðŸš€ Sniper Captura & Limpeza
      id: captura
      run: |
        python app-3.py
        python limpeza.py
        
    - name: ðŸ“Š Verificar Trigger DominÃ³
      id: trigger
      run: |
        DIA_MES=$(date +%d)
        if [ "$DIA_MES" = "01" ] || [ "$DIA_MES" = "16" ]; then
          echo "trigger_dominÃ³=true" >> $GITHUB_OUTPUT
          echo "Hoje Ã© dia $DIA_MES - Disparando Efeito DominÃ³!"
        else
          echo "trigger_dominÃ³=false" >> $GITHUB_OUTPUT
          echo "Hoje dia $DIA_MES - Sem dominÃ³"
        fi
      
    - name: ðŸ’¾ Commit & Push
      run: |
        git config --global user.name "Sniper Pharma Bot"
        git config --global user.email "bot@sniper.pharma"
        git add .
        if git diff --staged --quiet; then
          echo "âœ… Sem alteraÃ§Ãµes"
        else
          git commit -m "ðŸ¤– Captura $(date +%Y-%m-%d) - $(ls -lh dadosoportunidades.json.gz | awk '{print $5}')"
          git push
        fi
      
    - name: ðŸ”„ EFEITO DOMINÃ“ (Corrigido)
      if: steps.trigger.outputs.trigger_dominÃ³ == 'true'
      run: |
        echo "ðŸŽ¯ Disparando prÃ³xima execuÃ§Ã£o..."
        gh workflow run sync-data.yml --ref ${{ github.ref }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
