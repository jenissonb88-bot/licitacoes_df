name: Sniper Pharma Controller

on:
  schedule:
    - cron: '0 9 * * *'  # Roda todo dia √†s 06:00 BRT
  workflow_dispatch:
    inputs:
      mode:
        description: 'Modo de Execu√ß√£o'
        required: true
        default: 'manual_loop'
        type: choice
        options:
        - manual_loop
        - single_run
      target_date:
        description: 'Data Alvo (YYYY-MM-DD)'
        required: false
        default: '2025-12-01'

jobs:
  sniper:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install deps
      run: pip install requests

    # --- 1. L√ìGICA DE DATAS ---
    - name: Definir Datas e Modo
      id: config
      run: |
        export TZ="America/Sao_Paulo"
        TODAY=$(date +'%Y-%m-%d')
        DAY_OF_MONTH=$(date +'%d')

        if [ "${{ github.event_name }}" == "schedule" ]; then
          if [ "$DAY_OF_MONTH" == "01" ] || [ "$DAY_OF_MONTH" == "16" ]; then
            # Quinzenalmente faz varredura ampla
            echo "START_DATE=2026-01-01" >> $GITHUB_ENV
            echo "END_DATE=$TODAY" >> $GITHUB_ENV
            echo "MODE=full_scan" >> $GITHUB_ENV
          else
            # Diariamente olha os ultimos 5 dias para garantir
            START_5DAYS=$(date -d "5 days ago" +'%Y-%m-%d')
            echo "START_DATE=$START_5DAYS" >> $GITHUB_ENV
            echo "END_DATE=$TODAY" >> $GITHUB_ENV
            echo "MODE=daily_update" >> $GITHUB_ENV
          fi
        else
          # Manual
          INPUT_DATE="${{ inputs.target_date }}"
          echo "START_DATE=$INPUT_DATE" >> $GITHUB_ENV
          echo "END_DATE=$INPUT_DATE" >> $GITHUB_ENV 
          echo "MODE=${{ inputs.mode }}" >> $GITHUB_ENV
        fi

    # --- 2. EXECU√á√ÉO DOS ROB√îS ---
    - name: Run app.py (Coleta)
      run: python app.py --start "$START_DATE" --end "$END_DATE"

    - name: Run limpeza.py (Filtro e Tratamento)
      run: python limpeza.py

    # --- 3. COMMIT E PUSH (CORRE√á√ÉO DO ERRO 128) ---
    - name: Commit results
      run: |
        git config user.name "Sniper Pharma Bot"
        git config user.email "sniper@pharma.bot"
        
        echo "üîÑ Preparando envio dos dados acumulados..."
        
        # 1. Adiciona os arquivos gerados no Stage
        git add dadosoportunidades.json.gz || true
        git add pregacoes_pharma_limpos.json.gz || true
        # Removemos checkpoint.txt se n√£o estiver usando, mas mantive por seguran√ßa
        git add checkpoint.txt || true 
        
        # 2. Verifica se tem algo novo para commitar
        # O comando 'commit' s√≥ roda se houver mudan√ßas, evitando erro de 'nothing to commit'
        git diff --staged --quiet || git commit -m "Sniper Data: $START_DATE | Mode: $MODE"
        
        # 3. TRUQUE PARA EVITAR CONFLITO (AQUI ESTAVA O ERRO):
        # Usamos --rebase -X theirs. 
        # Isso diz: "Se o servidor tiver algo diferente, O MEU ARQUIVO (theirs/bot) GANHA".
        git pull origin main --rebase -X theirs
        
        # 4. Envia
        git push origin main
        echo "‚úÖ Dados salvos com sucesso!"

    # --- 4. LOOP (SE FOR MANUAL) ---
    - name: Trigger Pr√≥ximo Dia
      if: inputs.mode == 'manual_loop'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        CURRENT="${{ inputs.target_date }}"
        # C√°lculo seguro de data +1 dia
        NEXT_DAY=$(date -d "$CURRENT + 1 day" +'%Y-%m-%d')
        # Definimos o limite como a data de hoje (para n√£o rodar no futuro)
        TODAY=$(date +'%Y-%m-%d')
        
        if [[ "$NEXT_DAY" < "$TODAY" ]] || [[ "$NEXT_DAY" == "$TODAY" ]]; then
          echo "üîÅ Pr√≥ximo dia: $NEXT_DAY"
          gh workflow run sync-data.yml -f mode=manual_loop -f target_date="$NEXT_DAY"
        else
          echo "üèÅ Fim do Loop (Chegou na data de hoje)."
        fi
