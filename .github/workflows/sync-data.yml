name: Sniper Pharma Controller

on:
  schedule:
    - cron: '0 9 * * *'  # Roda todo dia Ã s 06:00 BRT
  workflow_dispatch:
    inputs:
      mode:
        description: 'Modo de ExecuÃ§Ã£o'
        required: true
        default: 'manual_loop'
        type: choice
        options:
        - manual_loop
        - single_run
      target_date:
        description: 'Data Alvo (YYYY-MM-DD)'
        required: false
        default: '2025-12-01'

jobs:
  sniper:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install deps
      run: pip install requests

    # --- 1. LÃ“GICA DE DATAS ---
    - name: Definir Datas e Modo
      id: config
      run: |
        export TZ="America/Sao_Paulo"
        TODAY=$(date +'%Y-%m-%d')
        DAY_OF_MONTH=$(date +'%d')

        if [ "${{ github.event_name }}" == "schedule" ]; then
          if [ "$DAY_OF_MONTH" == "01" ] || [ "$DAY_OF_MONTH" == "16" ]; then
            # Quinzenalmente faz varredura ampla
            echo "START_DATE=2026-01-01" >> $GITHUB_ENV
            echo "END_DATE=$TODAY" >> $GITHUB_ENV
            echo "MODE=full_scan" >> $GITHUB_ENV
          else
            # Diariamente olha os ultimos 5 dias para garantir
            START_5DAYS=$(date -d "5 days ago" +'%Y-%m-%d')
            echo "START_DATE=$START_5DAYS" >> $GITHUB_ENV
            echo "END_DATE=$TODAY" >> $GITHUB_ENV
            echo "MODE=daily_update" >> $GITHUB_ENV
          fi
        else
          # Manual
          INPUT_DATE="${{ inputs.target_date }}"
          echo "START_DATE=$INPUT_DATE" >> $GITHUB_ENV
          echo "END_DATE=$INPUT_DATE" >> $GITHUB_ENV 
          echo "MODE=${{ inputs.mode }}" >> $GITHUB_ENV
        fi

    # --- 2. EXECUÃ‡ÃƒO DOS ROBÃ”S ---
    - name: Run app.py (Coleta)
      run: python app.py --start "$START_DATE" --end "$END_DATE"

    - name: Run limpeza.py (Filtro e Tratamento)
      run: python limpeza.py

    # --- 3. COMMIT E PUSH (ESTRATÃ‰GIA ANTI-AMNÃ‰SIA) ---
    - name: Commit results
      run: |
        git config user.name "Sniper Pharma Bot"
        git config user.email "sniper@pharma.bot"
        
        echo "ðŸ”„ Preparando envio dos dados acumulados..."
        
        # 1. Adiciona os arquivos gerados no Stage
        git add dadosoportunidades.json.gz || true
        git add pregacoes_pharma_limpos.json.gz || true
        git add checkpoint.txt || true
        
        # 2. Verifica se tem algo novo
        if ! git diff --staged --quiet; then
          git commit -m "Sniper Data: $START_DATE | Mode: $MODE"
          
          # 3. TRUQUE PARA EVITAR CONFLITO:
          # Puxa as alteraÃ§Ãµes do servidor, mas se tiver conflito no binÃ¡rio,
          # dizemos ao Git para preferir a NOSSA versÃ£o (que tem os dados acumulados).
          git pull --rebase -Xours origin main || git pull --rebase -Xours origin master
          
          # 4. Envia
          git push
          echo "âœ… Dados salvos com sucesso!"
        else
          echo "âœ¨ Nenhuma alteraÃ§Ã£o nova encontrada."
        fi

    # --- 4. LOOP (SE FOR MANUAL) ---
    - name: Trigger PrÃ³ximo Dia
      if: inputs.mode == 'manual_loop'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        CURRENT="${{ inputs.target_date }}"
        NEXT_DAY=$(date -d "$CURRENT + 1 day" +'%Y-%m-%d')
        TODAY=$(date +'%Y-%m-%d')
        
        if [[ "$NEXT_DAY" < "$TODAY" ]] || [[ "$NEXT_DAY" == "$TODAY" ]]; then
          echo "ðŸ” PrÃ³ximo dia: $NEXT_DAY"
          gh workflow run sync-data.yml -f mode=manual_loop -f target_date="$NEXT_DAY"
        else
          echo "ðŸ Fim do Loop."
        fi
