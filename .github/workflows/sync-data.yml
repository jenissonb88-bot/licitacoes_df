name: Sniper Pharma Inteligente
on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'      # 1x/dia 3h UTC (0h BR)
    - cron: '0 5 1,16 * *'    # Dias 1/16 5h UTC (2h BR)

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
      id-token: write
    steps:
    - name: ðŸš€ Checkout
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        fetch-depth: 0

    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ðŸ“¦ Dependencies
      run: pip install requests pandas openpyxl

    - name: ðŸŽ¯ SNIPER CAPTURA
      id: sniper
      run: python app.py

    - name: ðŸ§¹ LIMPEZA
      run: python limpeza.py

    - name: ðŸ“Š CHECK DOMINÃ“
      id: domino
      run: |
        DIA=$(date +%d)
        if [ "$DIA" = "01" ] || [ "$DIA" = "16" ]; then
          echo "domino=true" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ DIA $DIA - EFEITO DOMINÃ“ ATIVADO"
        else
          echo "domino=false" >> $GITHUB_OUTPUT
          echo "ðŸ“… DIA $DIA - Aguardando 1/16"
        fi

    - name: ðŸ’¾ COMMIT
      run: |
        git config --global user.name "Sniper Pharma"
        git config --global user.email "bot@sniper.pharma"
        git add .
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ¤– $(date +%Y-%m-%d) - $(ls -lh dadosoportunidades.json.gz 2>/dev/null | awk '{print $5}' || echo 'Novo')"
          git push
          echo "âœ… Commit & Push OK"
        else
          echo "âšª Sem mudanÃ§as"
        fi

    - name: ðŸ”„ EFEITO DOMINÃ“
      if: steps.domino.outputs.domino == 'true'
      run: |
        echo "ðŸš€ Disparando prÃ³xima varredura..."
        gh workflow run sync-data.yml --ref ${{ github.ref }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
