name: Sincroniza√ß√£o Recursiva PNCP

on:
  schedule:
    - cron: '0 9 * * *' # Roda todo dia √†s 06:00 Bras√≠lia
  workflow_dispatch: # Permite rodar manualmente

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar Depend√™ncias
        run: pip install requests

      - name: Executar Coleta
        run: python app.py

      - name: Salvar Dados e Checkpoint
        run: |
          git config --global user.name "Bot Coleta PNCP"
          git config --global user.email "bot@pncp.com"
          git add dados/oportunidades.js checkpoint.txt
          git commit -m "Auto: Atualiza√ß√£o de dados e checkpoint [skip ci]" || echo "Sem mudan√ßas"
          git push

      - name: Disparar Pr√≥xima Rodada
        run: |
          if [ -f env.txt ]; then
            source env.txt
            if [ "$CONTINUAR_EXECUCAO" = "true" ]; then
              echo "üîÑ H√° dias pendentes. Disparando pr√≥xima execu√ß√£o..."
              curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/actions/workflows/sync-data.yml/dispatches \
                -d '{"ref":"main"}'
            else
              echo "‚úÖ Sincroniza√ß√£o finalizada at√© a data atual."
            fi
          fi
